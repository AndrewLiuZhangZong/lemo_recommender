# æ•°æ®æ¥å…¥æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†ä¸šåŠ¡ç³»ç»Ÿçš„ç‰©å“æ•°æ®æ¥å…¥æ¨èç³»ç»Ÿã€‚

---

## ğŸ¯ æ”¯æŒçš„æ¥å…¥æ–¹å¼

æ¨èç³»ç»Ÿæ”¯æŒ**ä¸¤ç§**æ•°æ®æ¥å…¥æ–¹å¼ï¼š

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å®æ—¶æ€§ | å¤æ‚åº¦ |
|------|---------|--------|--------|
| **APIæ¨é€** | å°è§„æ¨¡ã€å®æ—¶å‘å¸ƒ | âš¡ï¸ ç§’çº§ | â­ ç®€å• |
| **Kafkaæ¶ˆè´¹** | å¤§è§„æ¨¡ã€é«˜åå | âš¡ï¸ ç§’çº§ | â­â­ ä¸­ç­‰ |

---

## æ–¹å¼1ï¼šAPIæ¨é€ï¼ˆæ¨èâœ…ï¼‰

### é€‚ç”¨åœºæ™¯

- vlogå‘å¸ƒåç«‹å³æ¨è
- æ–°é—»å‘å¸ƒåå®æ—¶å±•ç¤º
- ä¸­å°è§„æ¨¡æ•°æ®é‡ï¼ˆ< 10ä¸‡/å¤©ï¼‰
- ä¸šåŠ¡ç³»ç»Ÿæ”¯æŒHTTPè°ƒç”¨

### æ¥å…¥æ­¥éª¤

#### 1. è·å–APIå‡­è¯

- **ç§Ÿæˆ·ID**: `tenant_id`ï¼ˆç”±æ¨èç³»ç»Ÿåˆ†é…ï¼‰
- **APIåœ°å€**: `http://recommender-api:8080/api/v1`

#### 2. è°ƒç”¨æ‰¹é‡å¯¼å…¥æ¥å£

**æ¥å£åœ°å€**:
```
POST /api/v1/items/batch
```

**è¯·æ±‚å¤´**:
```http
Content-Type: application/json
X-Tenant-Id: your_tenant_id
X-User-Id: system
```

**è¯·æ±‚ä½“**:
```json
{
  "scenario_id": "vlog_main_feed",
  "items": [
    {
      "item_id": "vlog_20241022_001",
      "metadata": {
        "title": "åŒ—äº¬æ—…è¡ŒVlog",
        "author": "æ—…è¡Œåšä¸»",
        "author_id": "user_123",
        "duration": 180,
        "cover_url": "https://cdn.example.com/cover.jpg",
        "video_url": "https://cdn.example.com/video.mp4",
        "tags": ["æ—…è¡Œ", "åŒ—äº¬", "ç¾é£Ÿ"],
        "category": "travel",
        "publish_time": "2024-10-22T10:00:00Z"
      }
    },
    {
      "item_id": "vlog_20241022_002",
      "metadata": {
        "title": "ä¸Šæµ·ç¾é£Ÿæ¢åº—",
        "author": "ç¾é£Ÿè¾¾äºº",
        "duration": 240,
        "tags": ["ç¾é£Ÿ", "ä¸Šæµ·"]
      }
    }
  ]
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æˆåŠŸåˆ›å»º2ä¸ªç‰©å“ï¼Œåç»­å¤„ç†å·²å¯åŠ¨",
  "data": {
    "count": 2,
    "processing": {
      "processed": 2,
      "source": "api",
      "tasks": {
        "kafka_sent": 2,
        "vector_queued": 2,
        "cache_updated": true
      },
      "timestamp": "2024-10-22T10:00:00.000Z"
    }
  }
}
```

#### 3. åç»­å¤„ç†ï¼ˆè‡ªåŠ¨ï¼‰

æ¥å£è°ƒç”¨æˆåŠŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. âœ… å†™å…¥MongoDB
2. âœ… å‘é€Kafkaäº‹ä»¶ï¼ˆé€šçŸ¥ä¸‹æ¸¸ï¼‰
3. âœ… è§¦å‘å‘é‡ç”Ÿæˆï¼ˆç”¨äºç›¸ä¼¼æ¨èï¼‰
4. âœ… å¤±æ•ˆç›¸å…³ç¼“å­˜

#### 4. ç¤ºä¾‹ä»£ç 

**Python**:
```python
import requests

def publish_vlog_to_recommender(vlog_data):
    """vlogå‘å¸ƒåè°ƒç”¨æ¨èç³»ç»Ÿ"""
    
    url = "http://recommender-api:8080/api/v1/items/batch"
    headers = {
        "Content-Type": "application/json",
        "X-Tenant-Id": "vlog_platform",
        "X-User-Id": "system"
    }
    
    payload = {
        "scenario_id": "vlog_main_feed",
        "items": [
            {
                "item_id": vlog_data["id"],
                "metadata": {
                    "title": vlog_data["title"],
                    "author": vlog_data["author"],
                    "duration": vlog_data["duration"],
                    "cover_url": vlog_data["cover_url"],
                    "tags": vlog_data["tags"]
                }
            }
        ]
    }
    
    response = requests.post(url, json=payload, headers=headers)
    
    if response.status_code == 200:
        result = response.json()
        print(f"âœ… æ¨èç³»ç»Ÿæ¥å…¥æˆåŠŸ: {result}")
    else:
        print(f"âŒ æ¨èç³»ç»Ÿæ¥å…¥å¤±è´¥: {response.text}")
```

**Go**:
```go
func publishVlogToRecommender(vlog VlogData) error {
    url := "http://recommender-api:8080/api/v1/items/batch"
    
    payload := map[string]interface{}{
        "scenario_id": "vlog_main_feed",
        "items": []map[string]interface{}{
            {
                "item_id": vlog.ID,
                "metadata": map[string]interface{}{
                    "title":  vlog.Title,
                    "author": vlog.Author,
                    "tags":   vlog.Tags,
                },
            },
        },
    }
    
    body, _ := json.Marshal(payload)
    req, _ := http.NewRequest("POST", url, bytes.NewBuffer(body))
    req.Header.Set("Content-Type", "application/json")
    req.Header.Set("X-Tenant-Id", "vlog_platform")
    req.Header.Set("X-User-Id", "system")
    
    client := &http.Client{Timeout: 10 * time.Second}
    resp, err := client.Do(req)
    
    if err != nil {
        return err
    }
    defer resp.Body.Close()
    
    if resp.StatusCode == 200 {
        fmt.Println("âœ… æ¨èç³»ç»Ÿæ¥å…¥æˆåŠŸ")
        return nil
    }
    
    return fmt.Errorf("æ¨èç³»ç»Ÿæ¥å…¥å¤±è´¥: %d", resp.StatusCode)
}
```

---

## æ–¹å¼2ï¼šKafkaæ¶ˆè´¹

### é€‚ç”¨åœºæ™¯

- å¤§è§„æ¨¡æ•°æ®æ¥å…¥ï¼ˆ> 10ä¸‡/å¤©ï¼‰
- å·²æœ‰KafkaåŸºç¡€è®¾æ–½
- éœ€è¦å‰Šå³°å¡«è°·
- éœ€è¦å¼‚æ­¥è§£è€¦

### æ¥å…¥æ­¥éª¤

#### 1. å‘é€æ¶ˆæ¯åˆ°Kafka

ä¸šåŠ¡ç³»ç»Ÿå°†ç‰©å“æ•°æ®å‘é€åˆ°æŒ‡å®šTopicã€‚

**Topicå‘½åè§„èŒƒ**:
- `items-ingest` - ç»Ÿä¸€æ¥å…¥Topicï¼ˆæ¨èï¼‰
- `vlog-items` - vlogä¸“ç”¨Topic
- `news-items` - æ–°é—»ä¸“ç”¨Topic
- `{ä¸šåŠ¡}-items` - è‡ªå®šä¹‰Topicï¼ˆéœ€é…ç½®ï¼‰

**æ¶ˆæ¯æ ¼å¼**:
```json
{
  "tenant_id": "vlog_platform",
  "scenario_id": "vlog_main_feed",
  "items": [
    {
      "item_id": "vlog_20241022_001",
      "metadata": {
        "title": "åŒ—äº¬æ—…è¡ŒVlog",
        "author": "æ—…è¡Œåšä¸»",
        "duration": 180,
        "tags": ["æ—…è¡Œ", "åŒ—äº¬"]
      }
    }
  ]
}
```

**æ¶ˆæ¯Key**ï¼ˆå¯é€‰ï¼‰:
- ä½¿ç”¨ `tenant_id` ä½œä¸ºkeyï¼Œç¡®ä¿åŒä¸€ç§Ÿæˆ·çš„æ¶ˆæ¯æœ‰åº

#### 2. å¯åŠ¨Kafkaæ¶ˆè´¹è€…ï¼ˆæ¨èç³»ç»Ÿä¾§ï¼‰

æ¨èç³»ç»Ÿæä¾›å®ˆæŠ¤è¿›ç¨‹æ¶ˆè´¹Kafkaæ¶ˆæ¯ã€‚

```bash
# åå°å¯åŠ¨
nohup poetry run python scripts/run_item_consumer.py > logs/item_consumer.log 2>&1 &

# æˆ–ä½¿ç”¨systemd
systemctl start recommender-item-consumer
```

#### 3. ç›‘æ§æ¶ˆè´¹çŠ¶æ€

æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
tail -f logs/item_consumer.log
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
[ItemKafkaConsumer] æ”¶åˆ°æ¶ˆæ¯: Topic=vlog-items, Tenant=vlog_platform, Scenario=vlog_main_feed, Items=10
[ItemKafkaConsumer] âœ… å†™å…¥MongoDB: 10ä¸ªç‰©å“
[ItemKafkaConsumer] âœ… å¤„ç†å®Œæˆ: {'processed': 10, 'source': 'kafka', ...}
```

#### 4. ç¤ºä¾‹ä»£ç 

**Python (ä½¿ç”¨aiokafka)**:
```python
from aiokafka import AIOKafkaProducer
import json

async def send_vlogs_to_kafka():
    producer = AIOKafkaProducer(
        bootstrap_servers='localhost:9092',
        value_serializer=lambda v: json.dumps(v).encode('utf-8')
    )
    
    await producer.start()
    
    message = {
        "tenant_id": "vlog_platform",
        "scenario_id": "vlog_main_feed",
        "items": [
            {
                "item_id": "vlog_001",
                "metadata": {"title": "æ—…è¡ŒVlog"}
            }
        ]
    }
    
    await producer.send('items-ingest', value=message, key=b'vlog_platform')
    await producer.stop()
```

**Go (ä½¿ç”¨sarama)**:
```go
func sendVlogsToKafka(vlogs []Vlog) error {
    config := sarama.NewConfig()
    config.Producer.Return.Successes = true
    
    producer, err := sarama.NewSyncProducer([]string{"localhost:9092"}, config)
    if err != nil {
        return err
    }
    defer producer.Close()
    
    message := map[string]interface{}{
        "tenant_id":   "vlog_platform",
        "scenario_id": "vlog_main_feed",
        "items":       vlogs,
    }
    
    msgBytes, _ := json.Marshal(message)
    
    _, _, err = producer.SendMessage(&sarama.ProducerMessage{
        Topic: "items-ingest",
        Key:   sarama.StringEncoder("vlog_platform"),
        Value: sarama.ByteEncoder(msgBytes),
    })
    
    return err
}
```

---

## ğŸ“Š ä¸¤ç§æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | APIæ¨é€ | Kafkaæ¶ˆè´¹ |
|------|--------|----------|
| **å»¶è¿Ÿ** | ç§’çº§ | ç§’çº§ |
| **ååé‡** | ä¸­ç­‰ | æé«˜ |
| **å¯é æ€§** | åŒæ­¥ç¡®è®¤ | å¼‚æ­¥æŒä¹…åŒ– |
| **å®ç°å¤æ‚åº¦** | â­ ç®€å• | â­â­ ä¸­ç­‰ |
| **ä¾èµ–ç»„ä»¶** | æ—  | Kafkaé›†ç¾¤ |
| **é€‚åˆè§„æ¨¡** | < 10ä¸‡/å¤© | > 10ä¸‡/å¤© |
| **å‰Šå³°å¡«è°·** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **æ¶ˆæ¯å›æº¯** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. æ··åˆä½¿ç”¨

- **å®æ—¶å‘å¸ƒ**ï¼šä½¿ç”¨APIæ¨é€ï¼ˆä½å»¶è¿Ÿï¼‰
- **æ‰¹é‡å¯¼å…¥**ï¼šä½¿ç”¨Kafkaæ¶ˆè´¹ï¼ˆé«˜ååï¼‰

### 2. å…ƒæ•°æ®è§„èŒƒ

å¿…å¡«å­—æ®µï¼š
- `item_id` - ç‰©å“å”¯ä¸€ID
- `tenant_id` - ç§Ÿæˆ·ID
- `scenario_id` - åœºæ™¯ID

æ¨èå­—æ®µï¼ˆæå‡æ¨èæ•ˆæœï¼‰ï¼š
- `title` - æ ‡é¢˜ï¼ˆç”¨äºå‘é‡ç”Ÿæˆï¼‰
- `tags` - æ ‡ç­¾ï¼ˆç”¨äºç›¸ä¼¼å¬å›ï¼‰
- `category` - åˆ†ç±»ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
- `author` / `author_id` - ä½œè€…ï¼ˆç”¨äºä½œè€…æ¨èï¼‰
- `publish_time` - å‘å¸ƒæ—¶é—´ï¼ˆç”¨äºæ—¶é—´è¡°å‡ï¼‰

### 3. é”™è¯¯å¤„ç†

- APIæ¨é€ï¼šå®ç°é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
- Kafkaæ¶ˆè´¹ï¼šæ¶ˆæ¯ä¼šè‡ªåŠ¨é‡è¯•ï¼Œæ— éœ€ä¸šåŠ¡æ–¹å¤„ç†

### 4. ç›‘æ§å‘Šè­¦

å…³é”®æŒ‡æ ‡ï¼š
- APIæˆåŠŸç‡ > 99.9%
- Kafkaæ¶ˆè´¹å»¶è¿Ÿ < 1ç§’
- å‘é‡ç”Ÿæˆå®Œæˆç‡ > 99%

---

## â“ å¸¸è§é—®é¢˜

### Q1: APIæ¨é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: å®ç°é‡è¯•æœºåˆ¶ã€‚å¦‚æœæŒç»­å¤±è´¥ï¼Œæ£€æŸ¥ï¼š
- ç§Ÿæˆ·IDæ˜¯å¦æ­£ç¡®
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- æ¨èç³»ç»ŸæœåŠ¡æ˜¯å¦å¯åŠ¨

### Q2: Kafkaæ¶ˆæ¯ç§¯å‹æ€ä¹ˆåŠï¼Ÿ

A: 
- å¢åŠ æ¶ˆè´¹è€…å®ä¾‹æ•°ï¼ˆæ°´å¹³æ‰©å±•ï¼‰
- æ£€æŸ¥MongoDBå†™å…¥æ€§èƒ½
- æŸ¥çœ‹å‘é‡ç”Ÿæˆé˜Ÿåˆ—æ˜¯å¦é˜»å¡

### Q3: å¦‚ä½•ç¡®è®¤æ•°æ®æ¥å…¥æˆåŠŸï¼Ÿ

A:
- APIæ–¹å¼ï¼šæŸ¥çœ‹å“åº”ä¸­çš„ `processing` å­—æ®µ
- Kafkaæ–¹å¼ï¼šæŸ¥çœ‹æ¶ˆè´¹è€…æ—¥å¿—
- é€šç”¨ï¼šè°ƒç”¨æŸ¥è¯¢æ¥å£éªŒè¯

```bash
# æŸ¥è¯¢ç‰©å“
curl -H "X-Tenant-Id: vlog_platform" \
  "http://recommender-api:8080/api/v1/items?scenario_id=vlog_main_feed&page=1"
```

### Q4: å¦‚ä½•æ–°å¢è‡ªå®šä¹‰Topicï¼Ÿ

A: ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```bash
# config/prod.env
KAFKA_ITEM_INGEST_TOPICS=items-ingest,vlog-items,news-items,your-custom-topic
```

é‡å¯æ¶ˆè´¹è€…å³å¯ã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æ–‡æ¡£ï¼š[ç³»ç»Ÿè®¾è®¡.md](./ç³»ç»Ÿè®¾è®¡.md)
- APIæ–‡æ¡£ï¼šhttp://recommender-api:8080/api/v1/docs
- é—®é¢˜åé¦ˆï¼šGitHub Issues

