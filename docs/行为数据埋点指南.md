# åŸ‹ç‚¹æ¥å…¥å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„åŸ‹ç‚¹æ•°æ®æ¥å…¥æ–¹æ¡ˆï¼ŒåŒ…æ‹¬HTTPã€gRPCå’ŒKafkaä¸‰ç§æ–¹å¼ï¼Œä»¥åŠProtoä»£ç ç”ŸæˆæŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [åŸ‹ç‚¹æ¦‚è¿°](#åŸ‹ç‚¹æ¦‚è¿°)
2. [æ”¯æŒçš„åœºæ™¯ç±»å‹](#æ”¯æŒçš„åœºæ™¯ç±»å‹)
3. [æ¥å…¥æ–¹å¼é€‰æ‹©](#æ¥å…¥æ–¹å¼é€‰æ‹©)
4. [HTTP/gRPCæ¥å…¥æ–¹å¼](#httpgrpcæ¥å…¥æ–¹å¼)
5. [Kafkaç›´æ¥æ¥å…¥æ–¹å¼](#kafkaç›´æ¥æ¥å…¥æ–¹å¼)
6. [Protoä»£ç ç”ŸæˆæŒ‡å—](#protoä»£ç ç”ŸæˆæŒ‡å—)
7. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
8. [éªŒè¯å’Œè°ƒè¯•](#éªŒè¯å’Œè°ƒè¯•)
9. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŸ‹ç‚¹æ¦‚è¿°

### ä»€ä¹ˆæ˜¯åœºæ™¯åŸ‹ç‚¹ï¼Ÿ

åœºæ™¯åŸ‹ç‚¹æ˜¯æŒ‡é’ˆå¯¹ä¸åŒä¸šåŠ¡åœºæ™¯ï¼ˆè§†é¢‘ã€ç”µå•†ã€æ–°é—»ç­‰ï¼‰å®šä¹‰ç‰¹å®šçš„æ•°æ®é‡‡é›†å­—æ®µå’ŒéªŒè¯è§„åˆ™ã€‚é€šè¿‡åœºæ™¯åŸ‹ç‚¹é…ç½®ï¼Œå¯ä»¥ï¼š

âœ… **æ ‡å‡†åŒ–æ•°æ®é‡‡é›†** - ç»Ÿä¸€åœºæ™¯å†…çš„æ•°æ®å­—æ®µ  
âœ… **è‡ªåŠ¨æ•°æ®éªŒè¯** - ç¡®ä¿æ•°æ®è´¨é‡å’Œå®Œæ•´æ€§  
âœ… **çµæ´»æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰åœºæ™¯å’Œå­—æ®µ  
âœ… **æå‡æ¨èæ•ˆæœ** - é‡‡é›†æ›´ç²¾å‡†çš„åœºæ™¯ç‰¹å¾

### æ¶æ„è®¾è®¡

```
Cç«¯åº”ç”¨ â†’ HTTP/gRPC API â†’ behavior-service â†’ Kafka â†’ Flink â†’ ClickHouse
                               â†“
å†…éƒ¨æœåŠ¡ â†’ Kafkaç›´æ¥å†™å…¥ â”€â”€â†’ Kafka â†’ Flink â†’ ClickHouse
                               â†“
                        åœºæ™¯åŸ‹ç‚¹é…ç½®(MongoDB)
```

---

## æ”¯æŒçš„åœºæ™¯ç±»å‹

### 1. è§†é¢‘åœºæ™¯ (video)

é€‚ç”¨äºï¼šçŸ­è§†é¢‘ã€vlogã€è§†é¢‘è¯¾ç¨‹ç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `duration`: è§†é¢‘æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
- `watch_duration`: è§‚çœ‹æ—¶é•¿ï¼ˆç§’ï¼‰
- `completion_rate`: å®Œæˆç‡ï¼ˆ0-1ï¼‰
- `video_quality`: è§†é¢‘è´¨é‡ï¼ˆ360p/720p/1080p/4Kï¼‰
- `is_fullscreen`: æ˜¯å¦å…¨å±
- `playback_speed`: æ’­æ”¾é€Ÿåº¦ï¼ˆ1.0/1.5/2.0ï¼‰

**æ¨èè¡Œä¸ºï¼š** impression, click, play, play_end, pause, like, share, comment

### 2. ç”µå•†åœºæ™¯ (ecommerce)

é€‚ç”¨äºï¼šå•†å“æ¨èã€è´­ç‰©è½¦ã€è®¢å•ç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `price`: å•†å“ä»·æ ¼
- `currency`: è´§å¸ç±»å‹ï¼ˆCNY/USDç­‰ï¼‰
- `quantity`: æ•°é‡
- `discount`: æŠ˜æ‰£ç‡ï¼ˆ0-1ï¼‰
- `category_path`: åˆ†ç±»è·¯å¾„
- `brand`: å“ç‰Œ
- `sku_id`: SKU ID

**æ¨èè¡Œä¸ºï¼š** impression, click, view, add_cart, order, payment, purchase

### 3. æ–°é—»åœºæ™¯ (news)

é€‚ç”¨äºï¼šæ–°é—»ã€æ–‡ç« ã€èµ„è®¯ç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `read_duration`: é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰
- `read_progress`: é˜…è¯»è¿›åº¦ï¼ˆ0-1ï¼‰
- `word_count`: æ–‡ç« å­—æ•°
- `news_type`: æ–°é—»ç±»å‹ï¼ˆæ—¶æ”¿/è´¢ç»/ç§‘æŠ€ç­‰ï¼‰
- `source`: æ–°é—»æ¥æº
- `keywords`: å…³é”®è¯åˆ—è¡¨

**æ¨èè¡Œä¸ºï¼š** impression, click, read, read_end, like, share, comment

### 4. éŸ³ä¹åœºæ™¯ (music)

é€‚ç”¨äºï¼šéŸ³ä¹æ’­æ”¾ã€æ­Œå•æ¨èç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `duration`: æ­Œæ›²æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
- `play_duration`: æ’­æ”¾æ—¶é•¿ï¼ˆç§’ï¼‰
- `artist`: è‰ºæœ¯å®¶
- `album`: ä¸“è¾‘
- `genre`: éŸ³ä¹é£æ ¼
- `audio_quality`: éŸ³è´¨ï¼ˆæ ‡å‡†/é«˜å“/æ— æŸï¼‰

**æ¨èè¡Œä¸ºï¼š** impression, play, play_end, pause, like, add_playlist, share

### 5. æ•™è‚²åœºæ™¯ (education)

é€‚ç”¨äºï¼šåœ¨çº¿è¯¾ç¨‹ã€å­¦ä¹ èµ„æºæ¨èç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `course_id`: è¯¾ç¨‹ID
- `lesson_duration`: è¯¾æ—¶æ—¶é•¿ï¼ˆç§’ï¼‰
- `study_duration`: å­¦ä¹ æ—¶é•¿ï¼ˆç§’ï¼‰
- `progress`: å­¦ä¹ è¿›åº¦ï¼ˆ0-1ï¼‰
- `score`: å¾—åˆ†
- `difficulty_level`: éš¾åº¦ç­‰çº§

**æ¨èè¡Œä¸ºï¼š** impression, click, learn, complete, pause, trial, purchase

### 6. å†…å®¹æ¨èåœºæ™¯ (content)

é€‚ç”¨äºï¼šå›¾æ–‡å†…å®¹ã€å¸–å­ã€é—®ç­”ã€UGCå†…å®¹ç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `content_type`: å†…å®¹ç±»å‹ï¼ˆpost/question/answer/gallery/threadï¼‰
- `word_count`: æ–‡å­—æ•°é‡
- `image_count`: å›¾ç‰‡æ•°é‡
- `video_count`: è§†é¢‘æ•°é‡
- `topic`: è¯é¢˜/ä¸»é¢˜
- `content_quality_score`: å†…å®¹è´¨é‡åˆ†ï¼ˆ0-100ï¼‰
- `is_original`: æ˜¯å¦åŸåˆ›å†…å®¹
- `author_level`: ä½œè€…ç­‰çº§

**æ¨èè¡Œä¸ºï¼š** impression, click, view, read, like, comment, share, collect, report

### 7. ç¤¾äº¤æ¨èåœºæ™¯ (social)

é€‚ç”¨äºï¼šå¥½å‹æ¨èã€å…³æ³¨æ¨èã€ç¤¾äº¤å…³ç³»é“¾ç­‰

**æ ¸å¿ƒå­—æ®µï¼š**
- `relationship_type`: å…³ç³»ç±»å‹ï¼ˆfriend/follow/mutual/suggestedï¼‰
- `mutual_friends_count`: å…±åŒå¥½å‹æ•°
- `social_distance`: ç¤¾äº¤è·ç¦»ï¼ˆåº¦æ•°ï¼‰
- `influence_score`: å½±å“åŠ›åˆ†æ•°
- `interaction_frequency`: äº’åŠ¨é¢‘ç‡
- `common_interests`: å…±åŒå…´è¶£åˆ—è¡¨
- `is_verified`: æ˜¯å¦è®¤è¯ç”¨æˆ·

**æ¨èè¡Œä¸ºï¼š** impression, view_profile, follow, add_friend, message, ignore, block

### 8. ä¸ªæ€§åŒ–æ¨èåœºæ™¯ (personalized)

é€‚ç”¨äºï¼šç»¼åˆå¤šå› ç´ çš„ä¸ªæ€§åŒ–å†…å®¹æ¨è

**æ ¸å¿ƒå­—æ®µï¼š**
- `personalization_score`: ä¸ªæ€§åŒ–åˆ†æ•°ï¼ˆ0-1ï¼‰
- `match_reasons`: æ¨èç†ç”±åˆ—è¡¨
- `user_interests_match`: ç”¨æˆ·å…´è¶£åŒ¹é…åº¦
- `trending_score`: çƒ­åº¦åˆ†æ•°
- `novelty_score`: æ–°é¢–åº¦åˆ†æ•°
- `diversity_group`: å¤šæ ·æ€§åˆ†ç»„
- `recommendation_strategy`: æ¨èç­–ç•¥ï¼ˆcollaborative/content_based/hybridï¼‰

**æ¨èè¡Œä¸ºï¼š** impression, click, positive_feedback, negative_feedback, dismiss, not_interested

---

## æ¥å…¥æ–¹å¼é€‰æ‹©

### ä¸‰ç§æ¥å…¥æ–¹å¼å¯¹æ¯”

| æ¥å…¥æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å»¶è¿Ÿ(P99) | ååé‡ | å¤æ‚åº¦ | æ•°æ®éªŒè¯ |
|---------|---------|-----------|--------|--------|----------|
| **HTTP API** | Cç«¯åº”ç”¨ã€è·¨è¯­è¨€é›†æˆ | ~100ms | ~5K TPS | ä½ | âœ… è‡ªåŠ¨éªŒè¯ |
| **gRPC** | å†…éƒ¨æœåŠ¡ã€æ€§èƒ½è¦æ±‚é«˜ | ~50ms | ~10K TPS | ä¸­ | âœ… ç±»å‹å®‰å…¨ |
| **Kafkaç›´æ¥å†™å…¥** | å†…éƒ¨æœåŠ¡ã€è¶…é«˜é¢‘äº‹ä»¶ | ~15ms | ~50K TPS | é«˜ | âš ï¸ å®¢æˆ·ç«¯éªŒè¯ |

### âœ… é€‚åˆHTTP/gRPCçš„åœºæ™¯

- **Cç«¯åº”ç”¨åŸ‹ç‚¹**ï¼šç§»åŠ¨Appã€Webå‰ç«¯
- **éœ€è¦å®æ—¶éªŒè¯**ï¼šç«‹å³è·å¾—æ•°æ®æ ¼å¼åé¦ˆ
- **ä½é¢‘äº‹ä»¶**ï¼šç‚¹å‡»ã€è½¬åŒ–ã€è´­ä¹°ç­‰ï¼ˆQPS < 1Kï¼‰
- **è·¨è¯­è¨€é›†æˆ**ï¼šJavaã€Goã€Pythonç­‰å¤šè¯­è¨€å®¢æˆ·ç«¯

### âœ… é€‚åˆKafkaç›´æ¥å†™å…¥çš„åœºæ™¯

- **å†…éƒ¨æœåŠ¡åŸ‹ç‚¹**ï¼šæ¨èæœåŠ¡ã€å†…å®¹æœåŠ¡ç­‰åç«¯æœåŠ¡
- **é«˜é¢‘äº‹ä»¶**ï¼šæ¯ç§’æ•°åƒæ¬¡çš„æ›å…‰ã€æ»šåŠ¨ç­‰
- **æ‰¹é‡ä¸ŠæŠ¥**ï¼šç¦»çº¿æ—¥å¿—è¡¥å½•ã€æ•°æ®è¿ç§»
- **è¶…ä½å»¶è¿Ÿè¦æ±‚**ï¼šP99 < 20ms

---

## HTTP/gRPCæ¥å…¥æ–¹å¼

### å¿«é€Ÿå¼€å§‹

#### Step 1: é€‰æ‹©æˆ–åˆ›å»ºåœºæ™¯é…ç½®

##### æ–¹å¼1ï¼šä½¿ç”¨å†…ç½®æ¨¡æ¿ï¼ˆæ¨èâœ…ï¼‰

```bash
# æŸ¥çœ‹å¯ç”¨æ¨¡æ¿
curl http://recommender-api:8080/api/v1/tracking-configs/templates/

# ä»æ¨¡æ¿åˆ›å»ºé…ç½®ï¼ˆä»¥è§†é¢‘åœºæ™¯ä¸ºä¾‹ï¼‰
curl -X POST "http://recommender-api:8080/api/v1/tracking-configs/from-template" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "mymx",
    "scenario_id": "vlog_feed",
    "template_id": "video",
    "name": "çŸ­è§†é¢‘FeedæµåŸ‹ç‚¹é…ç½®"
  }'
```

##### æ–¹å¼2ï¼šè‡ªå®šä¹‰é…ç½®

```bash
curl -X POST "http://recommender-api:8080/api/v1/tracking-configs/" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "mymx",
    "scenario_id": "vlog_feed",
    "scenario_type": "video",
    "name": "çŸ­è§†é¢‘åŸ‹ç‚¹é…ç½®",
    "required_fields": [
      {
        "field_name": "duration",
        "field_type": "integer",
        "required": true,
        "description": "è§†é¢‘æ€»æ—¶é•¿ï¼ˆç§’ï¼‰",
        "min_value": 1,
        "max_value": 3600
      }
    ]
  }'
```

#### Step 2: ä¸ŠæŠ¥åŸ‹ç‚¹æ•°æ®

##### HTTPæ–¹å¼

```python
import requests

# è§†é¢‘åœºæ™¯åŸ‹ç‚¹ç¤ºä¾‹
event_data = {
    "tenant_id": "mymx",
    "scenario_id": "vlog_feed",
    "user_id": "user_12345",
    "item_id": "video_67890",
    "action_type": "play_end",
    "context": {
        "device_type": "mobile",
        "os": "iOS",
        "location": "Beijing"
    },
    # åœºæ™¯ç‰¹å®šæ•°æ®
    "scenario_data": {
        "video_data": {
            "duration": 180,
            "watch_duration": 175,
            "completion_rate": 0.97,
            "video_quality": "1080p",
            "is_fullscreen": true,
            "playback_speed": 1.0
        }
    },
    "position": 3,
    "experiment_id": "exp_001"
}

response = requests.post(
    "http://recommender-api:8080/api/v1/behaviors/track",
    json=event_data
)

print(response.json())
# è¾“å‡º: {"success": true, "event_id": "evt_abc123", "message": "Event tracked successfully"}
```

##### gRPCæ–¹å¼

```python
import grpc
from recommender.v1 import behavior_pb2, behavior_pb2_grpc

# åˆ›å»ºgRPC channel
channel = grpc.insecure_channel('localhost:50051')
stub = behavior_pb2_grpc.BehaviorServiceStub(channel)

# æ„å»ºåœºæ™¯æ•°æ®
video_data = behavior_pb2.VideoScenarioData(
    duration=180,
    watch_duration=175,
    completion_rate=0.97,
    video_quality="1080p",
    is_fullscreen=True,
    playback_speed=1.0
)

scenario_data = behavior_pb2.ScenarioSpecificData(
    video_data=video_data
)

# æ„å»ºäº‹ä»¶
event = behavior_pb2.BehaviorEvent(
    tenant_id="mymx",
    scenario_id="vlog_feed",
    user_id="user_12345",
    item_id="video_67890",
    action_type=behavior_pb2.ACTION_TYPE_PLAY_END,
    context=behavior_pb2.BehaviorContext(
        device_type=behavior_pb2.DEVICE_TYPE_MOBILE,
        os="iOS",
        location="Beijing"
    ),
    scenario_data=scenario_data,
    position=3,
    experiment_id="exp_001"
)

# å‘é€è¯·æ±‚
request = behavior_pb2.TrackEventRequest(event=event)
response = stub.TrackEvent(request)

print(f"Success: {response.success}, Event ID: {response.event_id}")
```

### åœºæ™¯æ•°æ®æ ¼å¼

#### è§†é¢‘åœºæ™¯

```json
{
  "scenario_data": {
    "video_data": {
      "duration": 180,
      "watch_duration": 175,
      "completion_rate": 0.97,
      "video_quality": "1080p",
      "is_fullscreen": true,
      "is_muted": false,
      "playback_speed": 1.0,
      "seek_positions": [30, 60, 90],
      "buffer_time": 1200
    }
  }
}
```

#### ç”µå•†åœºæ™¯

```json
{
  "scenario_data": {
    "ecommerce_data": {
      "price": 299.90,
      "currency": "CNY",
      "quantity": 2,
      "discount": 0.15,
      "category_path": "/æœé¥°/å¥³è£…/è¿è¡£è£™",
      "brand": "æŸå“ç‰Œ",
      "sku_id": "SKU123456",
      "product_tags": ["å¤å­£", "æ–°æ¬¾", "çƒ­é”€"],
      "stock_count": 999,
      "coupon_id": "COUPON2024"
    }
  }
}
```

#### æ–°é—»åœºæ™¯

```json
{
  "scenario_data": {
    "news_data": {
      "read_duration": 120,
      "read_progress": 0.85,
      "word_count": 1500,
      "news_type": "ç§‘æŠ€",
      "source": "æŸæ–°é—»ç½‘",
      "author": "å¼ ä¸‰",
      "keywords": ["äººå·¥æ™ºèƒ½", "æŠ€æœ¯", "åˆ›æ–°"],
      "is_breaking_news": false,
      "publish_time": 1730304000000
    }
  }
}
```

#### éŸ³ä¹åœºæ™¯

```json
{
  "scenario_data": {
    "music_data": {
      "duration": 240,
      "play_duration": 240,
      "artist": "æŸæ­Œæ‰‹",
      "album": "æŸä¸“è¾‘",
      "genre": "æµè¡Œ",
      "bpm": 120,
      "language": "ä¸­æ–‡",
      "is_vip_only": false,
      "audio_quality": "æ— æŸ"
    }
  }
}
```

#### æ•™è‚²åœºæ™¯

```json
{
  "scenario_data": {
    "education_data": {
      "course_id": "COURSE001",
      "chapter_id": "CHAPTER01",
      "lesson_duration": 1800,
      "study_duration": 1650,
      "progress": 0.92,
      "exercise_count": 10,
      "correct_count": 8,
      "score": 80.0,
      "difficulty_level": "ä¸­çº§",
      "is_certificate_course": true
    }
  }
}
```

#### å†…å®¹æ¨èåœºæ™¯

```json
{
  "scenario_data": {
    "content_data": {
      "content_type": "post",
      "word_count": 800,
      "image_count": 3,
      "video_count": 0,
      "topic": "ç§‘æŠ€æ•°ç ",
      "content_quality_score": 85,
      "is_original": true,
      "author_level": "èµ„æ·±ä½œè€…",
      "has_hashtags": true,
      "hashtags": ["#AI", "#æŠ€æœ¯åˆ†äº«", "#æ·±åº¦å­¦ä¹ "],
      "engagement_rate": 0.08,
      "read_time_estimate": 180
    }
  }
}
```

#### ç¤¾äº¤æ¨èåœºæ™¯

```json
{
  "scenario_data": {
    "social_data": {
      "relationship_type": "suggested",
      "mutual_friends_count": 15,
      "social_distance": 2,
      "influence_score": 78.5,
      "interaction_frequency": "medium",
      "common_interests": ["ç§‘æŠ€", "æ—…è¡Œ", "æ‘„å½±"],
      "is_verified": true,
      "follower_count": 50000,
      "following_count": 300,
      "post_count": 1200,
      "similarity_score": 0.75
    }
  }
}
```

#### ä¸ªæ€§åŒ–æ¨èåœºæ™¯

```json
{
  "scenario_data": {
    "personalized_data": {
      "personalization_score": 0.89,
      "match_reasons": ["å…´è¶£åŒ¹é…", "çƒ­é—¨å†…å®¹", "å¥½å‹å–œæ¬¢"],
      "user_interests_match": 0.85,
      "trending_score": 0.72,
      "novelty_score": 0.65,
      "diversity_group": "tech_news",
      "recommendation_strategy": "hybrid",
      "model_version": "v2.1",
      "feature_importance": {
        "collaborative": 0.4,
        "content_based": 0.3,
        "popularity": 0.2,
        "novelty": 0.1
      }
    }
  }
}
```

### æ‰¹é‡ä¸ŠæŠ¥

```python
# æ‰¹é‡ä¸ŠæŠ¥ï¼ˆæœ€å¤š100æ¡ï¼‰
events = [
    {
        "tenant_id": "mymx",
        "scenario_id": "vlog_feed",
        "user_id": "user_001",
        "item_id": "video_001",
        "action_type": "impression",
        "context": {"device_type": "mobile"},
        "position": 1
    },
    {
        "tenant_id": "mymx",
        "scenario_id": "vlog_feed",
        "user_id": "user_001",
        "item_id": "video_002",
        "action_type": "impression",
        "context": {"device_type": "mobile"},
        "position": 2
    }
]

response = requests.post(
    "http://recommender-api:8080/api/v1/behaviors/track/batch",
    json={"events": events}
)

print(response.json())
# è¾“å‡º: {"success": true, "total": 2, "succeeded": 2, "failed": 0}
```

### Python SDKç¤ºä¾‹

```python
class TrackingClient:
    """åŸ‹ç‚¹å®¢æˆ·ç«¯å°è£…"""
    
    def __init__(self, base_url: str, tenant_id: str):
        self.base_url = base_url
        self.tenant_id = tenant_id
    
    def track_video_play(
        self,
        user_id: str,
        video_id: str,
        scenario_id: str,
        duration: int,
        watch_duration: int,
        completion_rate: float,
        **kwargs
    ):
        """è§†é¢‘æ’­æ”¾ç»“æŸåŸ‹ç‚¹"""
        event = {
            "tenant_id": self.tenant_id,
            "scenario_id": scenario_id,
            "user_id": user_id,
            "item_id": video_id,
            "action_type": "play_end",
            "context": kwargs.get("context", {"device_type": "mobile"}),
            "scenario_data": {
                "video_data": {
                    "duration": duration,
                    "watch_duration": watch_duration,
                    "completion_rate": completion_rate,
                    "video_quality": kwargs.get("video_quality", "720p"),
                    "is_fullscreen": kwargs.get("is_fullscreen", False),
                    "playback_speed": kwargs.get("playback_speed", 1.0)
                }
            }
        }
        
        return self._send_event(event)
    
    def _send_event(self, event: dict) -> dict:
        """å‘é€äº‹ä»¶"""
        url = f"{self.base_url}/api/v1/behaviors/track"
        response = requests.post(url, json=event, timeout=3)
        response.raise_for_status()
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
client = TrackingClient(
    base_url="http://recommender-api:8080",
    tenant_id="mymx"
)

result = client.track_video_play(
    user_id="user_12345",
    video_id="video_67890",
    scenario_id="vlog_feed",
    duration=180,
    watch_duration=175,
    completion_rate=0.97,
    video_quality="1080p",
    is_fullscreen=True
)

print(f"âœ… åŸ‹ç‚¹æˆåŠŸ: {result['event_id']}")
```

---

## Kafkaç›´æ¥æ¥å…¥æ–¹å¼

### ğŸ“‹ é€‚ç”¨åœºæ™¯

#### âœ… é€‚åˆç›´æ¥å†™Kafkaçš„åœºæ™¯

- **å†…éƒ¨æœåŠ¡åŸ‹ç‚¹**ï¼šæ¨èæœåŠ¡ã€å†…å®¹æœåŠ¡ç­‰åç«¯æœåŠ¡
- **é«˜é¢‘äº‹ä»¶**ï¼šæ¯ç§’æ•°åƒæ¬¡çš„æ›å…‰ã€æ»šåŠ¨ç­‰
- **æ‰¹é‡ä¸ŠæŠ¥**ï¼šç¦»çº¿æ—¥å¿—è¡¥å½•ã€æ•°æ®è¿ç§»
- **ä½å»¶è¿Ÿè¦æ±‚**ï¼šå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯

#### âŒ ä¸é€‚åˆçš„åœºæ™¯

- **Cç«¯åŸ‹ç‚¹**ï¼šå‰ç«¯ã€ç§»åŠ¨ç«¯ï¼ˆåº”ä½¿ç”¨HTTP/SDKï¼‰
- **éœ€è¦å®æ—¶éªŒè¯**ï¼šéœ€è¦ç«‹å³è¿”å›éªŒè¯ç»“æœ
- **ä½é¢‘äº‹ä»¶**ï¼šæ¯ç§’å‡ æ¬¡çš„ç‚¹å‡»ã€è½¬åŒ–ï¼ˆHTTPå³å¯æ»¡è¶³ï¼‰

### ğŸš€ å¿«é€Ÿå¼€å§‹

#### 1. Kafkaè¿æ¥ä¿¡æ¯

```yaml
# å¼€å‘ç¯å¢ƒ
bootstrap_servers: localhost:9092
security_protocol: PLAINTEXT

# ç”Ÿäº§ç¯å¢ƒ
bootstrap_servers: kafka-1:9092,kafka-2:9092,kafka-3:9092
security_protocol: SASL_SSL
sasl_mechanism: PLAIN
sasl_username: ${KAFKA_USER}
sasl_password: ${KAFKA_PASSWORD}
```

#### 2. Topicå‘½åè§„èŒƒ

**é‡è¦ï¼šæŒ‰ç§Ÿæˆ·éš”ç¦»ï¼** ğŸ”’

```
Topicæ ¼å¼: user-behaviors-{tenant_id}

ç¤ºä¾‹ï¼š
- user-behaviors-mymx           # mymxç§Ÿæˆ·çš„è¡Œä¸ºæ•°æ®
- user-behaviors-tenant_abc     # tenant_abcç§Ÿæˆ·çš„è¡Œä¸ºæ•°æ®
```

**åˆ†åŒºé…ç½®**ï¼š
- åˆ†åŒºæ•°ï¼š12-24ï¼ˆæ ¹æ®æµé‡è°ƒæ•´ï¼‰
- å‰¯æœ¬æ•°ï¼š3ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- ä¿ç•™æ—¶é—´ï¼š7å¤©

#### 3. æ¶ˆæ¯æ ¼å¼ï¼ˆJSON Schemaï¼‰

```json
{
  "event_id": "evt_abc123",                    // å¿…å¡«ï¼šäº‹ä»¶å”¯ä¸€ID
  "tenant_id": "mymx",                         // å¿…å¡«ï¼šç§Ÿæˆ·IDï¼ˆSaaSéš”ç¦»ï¼‰
  "scenario_id": "vlog_feed",                  // å¿…å¡«ï¼šåœºæ™¯ID
  "user_id": "user_12345",                     // å¿…å¡«ï¼šç”¨æˆ·ID
  "item_id": "item_67890",                     // å¿…å¡«ï¼šç‰©å“ID
  "action_type": "click",                      // å¿…å¡«ï¼šè¡Œä¸ºç±»å‹ï¼ˆè§æšä¸¾ï¼‰
  "timestamp": 1730304000000,                  // å¿…å¡«ï¼šæ¯«ç§’æ—¶é—´æˆ³
  
  "context": {                                 // å¿…å¡«ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯
    "device_type": "mobile",                   // å¿…å¡«ï¼šmobile/pc/tablet
    "os": "iOS",                               // å¯é€‰
    "location": "Beijing",                     // å¯é€‰
    "ip": "192.168.1.1"                        // å¯é€‰
  },
  
  "experiment_id": "exp_001",                  // å¯é€‰ï¼šABå®éªŒID
  "experiment_group": "treatment",             // å¯é€‰ï¼šå®éªŒåˆ†ç»„
  "position": 3,                               // å¯é€‰ï¼šæ¨èä½ç½®
  
  "scenario_data": {                           // å¯é€‰ï¼šåœºæ™¯ç‰¹å®šæ•°æ®
    "video_data": {                            // è§†é¢‘åœºæ™¯
      "duration": 180,
      "watch_duration": 175,
      "completion_rate": 0.97,
      "video_quality": "1080p"
    }
  },
  
  "extra_data": {}                             // å¯é€‰ï¼šé¢å¤–æ•°æ®ï¼ˆJSONï¼‰
}
```

### ğŸ’» ä»£ç ç¤ºä¾‹

#### Python (aiokafka - æ¨è)

```python
from aiokafka import AIOKafkaProducer
import json
import asyncio
from datetime import datetime
import uuid

class KafkaTracker:
    """KafkaåŸ‹ç‚¹å®¢æˆ·ç«¯"""
    
    def __init__(self, bootstrap_servers: str, tenant_id: str):
        self.bootstrap_servers = bootstrap_servers
        self.tenant_id = tenant_id
        self.producer = None
        self.topic = f"user-behaviors-{tenant_id}"
    
    async def start(self):
        """å¯åŠ¨ç”Ÿäº§è€…"""
        self.producer = AIOKafkaProducer(
            bootstrap_servers=self.bootstrap_servers,
            value_serializer=lambda v: json.dumps(v).encode('utf-8'),
            compression_type='gzip',  # å¯ç”¨å‹ç¼©
            acks='all',               # ç¡®ä¿å†™å…¥æˆåŠŸ
            retries=3,                # é‡è¯•3æ¬¡
            max_in_flight_requests_per_connection=5
        )
        await self.producer.start()
        print(f"âœ… Kafka Producer started: {self.topic}")
    
    async def track(
        self,
        scenario_id: str,
        user_id: str,
        item_id: str,
        action_type: str,
        device_type: str = "mobile",
        **kwargs
    ):
        """ä¸ŠæŠ¥å•ä¸ªäº‹ä»¶"""
        event = {
            "event_id": f"evt_{uuid.uuid4().hex[:16]}",
            "tenant_id": self.tenant_id,
            "scenario_id": scenario_id,
            "user_id": user_id,
            "item_id": item_id,
            "action_type": action_type,
            "timestamp": int(datetime.now().timestamp() * 1000),
            "context": {
                "device_type": device_type,
                **kwargs.get("context", {})
            }
        }
        
        # æ·»åŠ å¯é€‰å­—æ®µ
        if "position" in kwargs:
            event["position"] = kwargs["position"]
        if "scenario_data" in kwargs:
            event["scenario_data"] = kwargs["scenario_data"]
        if "experiment_id" in kwargs:
            event["experiment_id"] = kwargs["experiment_id"]
        
        # å‘é€åˆ°Kafkaï¼ˆKeyä¸ºuser_idï¼Œä¿è¯åŒä¸€ç”¨æˆ·æœ‰åºï¼‰
        await self.producer.send(
            self.topic,
            value=event,
            key=user_id.encode('utf-8')
        )
    
    async def track_batch(self, events: list):
        """æ‰¹é‡ä¸ŠæŠ¥"""
        tasks = []
        for event in events:
            # è¡¥å……å¿…å¡«å­—æ®µ
            if "event_id" not in event:
                event["event_id"] = f"evt_{uuid.uuid4().hex[:16]}"
            if "timestamp" not in event:
                event["timestamp"] = int(datetime.now().timestamp() * 1000)
            if "tenant_id" not in event:
                event["tenant_id"] = self.tenant_id
            
            tasks.append(
                self.producer.send(
                    self.topic,
                    value=event,
                    key=event["user_id"].encode('utf-8')
                )
            )
        
        # æ‰¹é‡å‘é€
        await asyncio.gather(*tasks)
    
    async def close(self):
        """å…³é—­ç”Ÿäº§è€…"""
        if self.producer:
            await self.producer.stop()
            print("âœ… Kafka Producer closed")


# ä½¿ç”¨ç¤ºä¾‹
async def main():
    tracker = KafkaTracker(
        bootstrap_servers="localhost:9092",
        tenant_id="mymx"
    )
    
    await tracker.start()
    
    # å•ä¸ªäº‹ä»¶
    await tracker.track(
        scenario_id="vlog_feed",
        user_id="user_123",
        item_id="video_456",
        action_type="click",
        device_type="mobile",
        position=3,
        scenario_data={
            "video_data": {
                "duration": 180,
                "watch_duration": 175,
                "completion_rate": 0.97
            }
        }
    )
    
    # æ‰¹é‡äº‹ä»¶ï¼ˆæ›å…‰ï¼‰
    impressions = [
        {
            "scenario_id": "vlog_feed",
            "user_id": "user_123",
            "item_id": f"video_{i}",
            "action_type": "impression",
            "context": {"device_type": "mobile"},
            "position": i
        }
        for i in range(1, 11)  # 10ä¸ªæ›å…‰
    ]
    await tracker.track_batch(impressions)
    
    await tracker.close()

if __name__ == "__main__":
    asyncio.run(main())
```

#### Go (sarama)

```go
package main

import (
    "encoding/json"
    "fmt"
    "time"
    "github.com/Shopify/sarama"
    "github.com/google/uuid"
)

type KafkaTracker struct {
    producer  sarama.SyncProducer
    tenantID  string
    topic     string
}

func NewKafkaTracker(brokers []string, tenantID string) (*KafkaTracker, error) {
    config := sarama.NewConfig()
    config.Producer.Return.Successes = true
    config.Producer.Compression = sarama.CompressionGZIP
    config.Producer.RequiredAcks = sarama.WaitForAll
    config.Producer.Retry.Max = 3
    
    producer, err := sarama.NewSyncProducer(brokers, config)
    if err != nil {
        return nil, err
    }
    
    return &KafkaTracker{
        producer: producer,
        tenantID: tenantID,
        topic:    fmt.Sprintf("user-behaviors-%s", tenantID),
    }, nil
}

func (t *KafkaTracker) Track(event map[string]interface{}) error {
    // è¡¥å……å¿…å¡«å­—æ®µ
    if _, ok := event["event_id"]; !ok {
        event["event_id"] = fmt.Sprintf("evt_%s", uuid.New().String()[:16])
    }
    if _, ok := event["timestamp"]; !ok {
        event["timestamp"] = time.Now().UnixNano() / 1e6
    }
    if _, ok := event["tenant_id"]; !ok {
        event["tenant_id"] = t.tenantID
    }
    
    // åºåˆ—åŒ–
    msgBytes, err := json.Marshal(event)
    if err != nil {
        return err
    }
    
    // å‘é€åˆ°Kafka
    userID := event["user_id"].(string)
    msg := &sarama.ProducerMessage{
        Topic: t.topic,
        Key:   sarama.StringEncoder(userID),
        Value: sarama.ByteEncoder(msgBytes),
    }
    
    _, _, err = t.producer.SendMessage(msg)
    return err
}

func (t *KafkaTracker) Close() error {
    return t.producer.Close()
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    tracker, err := NewKafkaTracker(
        []string{"localhost:9092"},
        "mymx",
    )
    if err != nil {
        panic(err)
    }
    defer tracker.Close()
    
    // ä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶
    event := map[string]interface{}{
        "scenario_id": "vlog_feed",
        "user_id":     "user_123",
        "item_id":     "video_456",
        "action_type": "click",
        "context": map[string]interface{}{
            "device_type": "mobile",
        },
        "position": 3,
    }
    
    if err := tracker.Track(event); err != nil {
        fmt.Printf("Failed to track: %v\n", err)
    } else {
        fmt.Println("âœ… Event tracked successfully")
    }
}
```

#### Java (Kafka Clients)

```java
import org.apache.kafka.clients.producer.*;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.*;

public class KafkaTracker {
    private final KafkaProducer<String, String> producer;
    private final String tenantId;
    private final String topic;
    private final ObjectMapper mapper;
    
    public KafkaTracker(String bootstrapServers, String tenantId) {
        Properties props = new Properties();
        props.put("bootstrap.servers", bootstrapServers);
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("compression.type", "gzip");
        props.put("acks", "all");
        props.put("retries", 3);
        
        this.producer = new KafkaProducer<>(props);
        this.tenantId = tenantId;
        this.topic = "user-behaviors-" + tenantId;
        this.mapper = new ObjectMapper();
    }
    
    public void track(Map<String, Object> event) throws Exception {
        // è¡¥å……å¿…å¡«å­—æ®µ
        event.putIfAbsent("event_id", "evt_" + UUID.randomUUID().toString().substring(0, 16));
        event.putIfAbsent("timestamp", System.currentTimeMillis());
        event.putIfAbsent("tenant_id", tenantId);
        
        // åºåˆ—åŒ–
        String json = mapper.writeValueAsString(event);
        String userId = (String) event.get("user_id");
        
        // å‘é€
        ProducerRecord<String, String> record = new ProducerRecord<>(
            topic,
            userId,  // Key
            json     // Value
        );
        
        producer.send(record, (metadata, exception) -> {
            if (exception != null) {
                System.err.println("Failed to send: " + exception.getMessage());
            } else {
                System.out.println("âœ… Sent to partition " + metadata.partition());
            }
        });
    }
    
    public void close() {
        producer.close();
    }
}
```

### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

#### 1. ç§Ÿæˆ·éš”ç¦»ï¼ˆå¿…é¡»ï¼ï¼‰

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç§Ÿæˆ·ä¸“å±Topic
topic = f"user-behaviors-{tenant_id}"

# âŒ é”™è¯¯ï¼šæ‰€æœ‰ç§Ÿæˆ·å…±ç”¨Topic
topic = "user-behaviors"  # ä¸è¦è¿™æ ·åšï¼
```

#### 2. æ•°æ®éªŒè¯

è™½ç„¶ç»•è¿‡äº†behavior-serviceï¼Œä½†å®¢æˆ·ç«¯ä»éœ€éªŒè¯ï¼š

```python
def validate_event(event: dict) -> bool:
    """å®¢æˆ·ç«¯éªŒè¯"""
    required_fields = [
        'tenant_id', 'scenario_id', 'user_id',
        'item_id', 'action_type', 'context'
    ]
    
    # æ£€æŸ¥å¿…å¡«å­—æ®µ
    for field in required_fields:
        if field not in event:
            raise ValueError(f"Missing required field: {field}")
    
    # æ£€æŸ¥device_type
    if 'device_type' not in event.get('context', {}):
        raise ValueError("context.device_type is required")
    
    return True
```

#### 3. é”™è¯¯å¤„ç†

```python
# é‡è¯•æœºåˆ¶
async def track_with_retry(tracker, event, max_retries=3):
    for attempt in range(max_retries):
        try:
            await tracker.track(**event)
            return True
        except Exception as e:
            if attempt == max_retries - 1:
                logger.error(f"Failed after {max_retries} retries: {e}")
                # å¯é€‰ï¼šå†™å…¥æœ¬åœ°é˜Ÿåˆ—ï¼Œç¨åé‡è¯•
                save_to_local_queue(event)
                return False
            await asyncio.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
```

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

#### å»¶è¿Ÿå¯¹æ¯”

| æ–¹å¼ | P50 | P99 | P999 |
|-----|-----|-----|------|
| HTTP API | 50ms | 100ms | 200ms |
| gRPC | 20ms | 50ms | 100ms |
| **Kafkaç›´æ¥å†™å…¥** | **5ms** | **15ms** | **30ms** |

#### ååå¯¹æ¯”

| æ–¹å¼ | å•æœºTPS |
|-----|---------|
| HTTP API | ~5K |
| gRPC | ~10K |
| **Kafkaç›´æ¥å†™å…¥** | **~50K** |

### ğŸ¯ Kafkaæœ€ä½³å®è·µ

#### 1. æ‰¹é‡å†™å…¥

```python
# âŒ ä¸æ¨èï¼šå¾ªç¯å•æ¡å‘é€
for event in events:
    await tracker.track(**event)

# âœ… æ¨èï¼šæ‰¹é‡å‘é€
await tracker.track_batch(events)
```

#### 2. å¼‚æ­¥éé˜»å¡

```python
# âœ… æ¨èï¼šå¼‚æ­¥å‘é€ï¼Œä¸ç­‰å¾…ç¡®è®¤
async def track_async(event):
    asyncio.create_task(tracker.track(**event))
    # ç«‹å³è¿”å›ï¼Œä¸é˜»å¡ä¸šåŠ¡é€»è¾‘
```

#### 3. æœ¬åœ°é˜Ÿåˆ— + å®šæ—¶åˆ·æ–°

```python
from collections import deque
import asyncio

class BufferedKafkaTracker:
    def __init__(self, tracker, buffer_size=100, flush_interval=1.0):
        self.tracker = tracker
        self.buffer = deque(maxlen=buffer_size)
        self.flush_interval = flush_interval
        self._start_flusher()
    
    async def track(self, **event):
        """æ·»åŠ åˆ°ç¼“å†²åŒº"""
        self.buffer.append(event)
        
        # ç¼“å†²åŒºæ»¡äº†ï¼Œç«‹å³åˆ·æ–°
        if len(self.buffer) >= self.buffer.maxlen:
            await self._flush()
    
    async def _flush(self):
        """åˆ·æ–°ç¼“å†²åŒºåˆ°Kafka"""
        if not self.buffer:
            return
        
        events = list(self.buffer)
        self.buffer.clear()
        
        await self.tracker.track_batch(events)
    
    def _start_flusher(self):
        """å®šæ—¶åˆ·æ–°"""
        async def flush_loop():
            while True:
                await asyncio.sleep(self.flush_interval)
                await self._flush()
        
        asyncio.create_task(flush_loop())
```

---

## Protoä»£ç ç”ŸæˆæŒ‡å—

### ğŸ“ ç›®å½•ç»“æ„

```
/Users/edy/Lemo/andrew-protos/          # Protoå®šä¹‰ä»“åº“
â”œâ”€â”€ protos/
â”‚   â””â”€â”€ recommender/
â”‚       â””â”€â”€ v1/
â”‚           â”œâ”€â”€ behavior.proto          # è¡Œä¸ºé‡‡é›†æœåŠ¡ï¼ˆå·²æ›´æ–°âœ…ï¼‰
â”‚           â”œâ”€â”€ item.proto
â”‚           â”œâ”€â”€ scenario.proto
â”‚           â””â”€â”€ ...
â”œâ”€â”€ Makefile                            # æ„å»ºè„šæœ¬
â””â”€â”€ gen/                                # ç”Ÿæˆçš„ä»£ç 
    â”œâ”€â”€ go/                             # Goä»£ç 
    â””â”€â”€ python/                         # Pythonä»£ç 

/Users/edy/PycharmProjects/lemo_recommender/  # æ¨èç³»ç»ŸæœåŠ¡
â””â”€â”€ app/
    â””â”€â”€ grpc_generated/
        â””â”€â”€ python/                     # å¤åˆ¶ç”Ÿæˆçš„Pythonä»£ç åˆ°è¿™é‡Œ
```

### ğŸš€ ç”Ÿæˆæ­¥éª¤

#### Step 1: æ›´æ–°Protoæ–‡ä»¶

Protoæ–‡ä»¶å·²æ›´æ–°ï¼Œæ”¯æŒåœºæ™¯æ‰©å±•å­—æ®µï¼š
- âœ… `VideoScenarioData` - è§†é¢‘åœºæ™¯æ•°æ®
- âœ… `EcommerceScenarioData` - ç”µå•†åœºæ™¯æ•°æ®
- âœ… `NewsScenarioData` - æ–°é—»åœºæ™¯æ•°æ®
- âœ… `MusicScenarioData` - éŸ³ä¹åœºæ™¯æ•°æ®
- âœ… `EducationScenarioData` - æ•™è‚²åœºæ™¯æ•°æ®
- âœ… `ScenarioSpecificData` - åœºæ™¯æ•°æ®è”åˆç±»å‹

ä½ç½®: `/Users/edy/Lemo/andrew-protos/protos/recommender/v1/behavior.proto`

#### Step 2: ç”Ÿæˆä»£ç 

```bash
# è¿›å…¥andrew-protosç›®å½•
cd /Users/edy/Lemo/andrew-protos

# æ–¹å¼1ï¼šç”Ÿæˆæ‰€æœ‰è¯­è¨€ä»£ç ï¼ˆæ¨èï¼‰
make generate

# æ–¹å¼2ï¼šä»…ç”ŸæˆPythonä»£ç 
make generate-python

# æ–¹å¼3ï¼šä½¿ç”¨protocç›´æ¥ç”Ÿæˆ
make generate-protoc
```

ç”Ÿæˆçš„Pythonä»£ç ä½ç½®ï¼š
```
/Users/edy/Lemo/andrew-protos/gen/python/recommender/v1/
â”œâ”€â”€ behavior_pb2.py          # æ¶ˆæ¯å®šä¹‰
â”œâ”€â”€ behavior_pb2_grpc.py     # æœåŠ¡å®šä¹‰
â””â”€â”€ behavior_pb2.pyi         # ç±»å‹æç¤º
```

#### Step 3: å¤åˆ¶åˆ°æ¨èç³»ç»Ÿé¡¹ç›®

```bash
# å¤åˆ¶ç”Ÿæˆçš„Pythonä»£ç 
cp -r /Users/edy/Lemo/andrew-protos/gen/python/* \
      /Users/edy/PycharmProjects/lemo_recommender/app/grpc_generated/python/

# æˆ–è€…ä½¿ç”¨è„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
cd /Users/edy/PycharmProjects/lemo_recommender
./scripts/update_grpc_code.sh
```

#### Step 4: éªŒè¯ç”Ÿæˆç»“æœ

```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /Users/edy/PycharmProjects/lemo_recommender/app/grpc_generated/python/recommender/v1/

# åº”è¯¥çœ‹åˆ°ï¼š
# - behavior_pb2.py
# - behavior_pb2_grpc.py
# - behavior_pb2.pyi
```

#### Step 5: æ›´æ–°gRPCæœåŠ¡å®ç°

ç”Ÿæˆæ–°ä»£ç åï¼Œéœ€è¦æ›´æ–°gRPCæœåŠ¡å®ç°ä»¥æ”¯æŒæ–°çš„åœºæ™¯æ•°æ®ç±»å‹ã€‚

æ–‡ä»¶ä½ç½®: `/Users/edy/PycharmProjects/lemo_recommender/app/grpc_server/services/behavior_service.py`

ä¸»è¦æ›´æ–°ç‚¹ï¼š
1. `_event_proto_to_dict` æ–¹æ³•éœ€è¦å¤„ç† `ScenarioSpecificData`
2. æ”¯æŒè§£æä¸åŒåœºæ™¯çš„æ•°æ®ï¼ˆvideo_data, ecommerce_dataç­‰ï¼‰

### ğŸ”§ ä½¿ç”¨ç”Ÿæˆçš„ä»£ç 

#### 1. åœ¨Pythonä¸­å¯¼å…¥

```python
# å¯¼å…¥ç”Ÿæˆçš„protobufä»£ç 
import sys
from pathlib import Path

# æ·»åŠ grpc_generatedåˆ°è·¯å¾„
grpc_gen_path = Path(__file__).parent.parent.parent / "grpc_generated" / "python"
sys.path.insert(0, str(grpc_gen_path))

# å¯¼å…¥æ¶ˆæ¯å’ŒæœåŠ¡
from recommender.v1 import behavior_pb2, behavior_pb2_grpc
```

#### 2. åˆ›å»ºåœºæ™¯æ•°æ®

```python
# è§†é¢‘åœºæ™¯æ•°æ®
video_data = behavior_pb2.VideoScenarioData(
    duration=180,
    watch_duration=175,
    completion_rate=0.97,
    video_quality="1080p",
    is_fullscreen=True,
    playback_speed=1.0,
    seek_positions=[30, 60, 90],
    buffer_time=1200
)

# å°è£…ä¸ºScenarioSpecificData
scenario_data = behavior_pb2.ScenarioSpecificData(
    video_data=video_data
)

# åˆ›å»ºäº‹ä»¶
event = behavior_pb2.BehaviorEvent(
    tenant_id="mymx",
    scenario_id="vlog_feed",
    user_id="user_12345",
    item_id="video_67890",
    action_type=behavior_pb2.ACTION_TYPE_PLAY_END,
    context=behavior_pb2.BehaviorContext(
        device_type=behavior_pb2.DEVICE_TYPE_MOBILE
    ),
    scenario_data=scenario_data
)
```

#### 3. å¤„ç†oneofå­—æ®µ

```python
# æ£€æŸ¥ä½¿ç”¨äº†å“ªä¸ªåœºæ™¯æ•°æ®
which = scenario_data.WhichOneof('data')

if which == 'video_data':
    video_data = scenario_data.video_data
    print(f"Duration: {video_data.duration}")
elif which == 'ecommerce_data':
    ecommerce_data = scenario_data.ecommerce_data
    print(f"Price: {ecommerce_data.price}")
```

### ğŸ”„ å®Œæ•´å·¥ä½œæµ

```bash
# 1. ä¿®æ”¹Protoæ–‡ä»¶
vim /Users/edy/Lemo/andrew-protos/protos/recommender/v1/behavior.proto

# 2. ç”Ÿæˆä»£ç 
cd /Users/edy/Lemo/andrew-protos
make generate

# 3. å¤åˆ¶åˆ°é¡¹ç›®
cp -r gen/python/* /Users/edy/PycharmProjects/lemo_recommender/app/grpc_generated/python/

# 4. æ›´æ–°æœåŠ¡å®ç°
vim /Users/edy/PycharmProjects/lemo_recommender/app/grpc_server/services/behavior_service.py

# 5. æµ‹è¯•
cd /Users/edy/PycharmProjects/lemo_recommender
poetry run pytest tests/test_behavior_service.py

# 6. é‡å¯æœåŠ¡
docker restart lemo_recommender
# æˆ–
kubectl rollout restart deployment/recommender-service
```

---

## é…ç½®ç®¡ç†

### æŸ¥è¯¢é…ç½®

```bash
# è·å–ç‰¹å®šåœºæ™¯çš„é…ç½®
curl "http://recommender-api:8080/api/v1/tracking-configs/mymx/vlog_feed"

# åˆ—å‡ºæ‰€æœ‰é…ç½®ï¼ˆæ”¯æŒç­›é€‰ï¼‰
curl "http://recommender-api:8080/api/v1/tracking-configs/?tenant_id=mymx&scenario_type=video"
```

### æ›´æ–°é…ç½®

```bash
curl -X PUT "http://recommender-api:8080/api/v1/tracking-configs/mymx/vlog_feed" \
  -H "Content-Type: application/json" \
  -d '{
    "description": "æ›´æ–°åçš„æè¿°",
    "optional_fields": [
      {
        "field_name": "buffer_time",
        "field_type": "integer",
        "required": false,
        "description": "ç¼“å†²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰"
      }
    ]
  }'
```

### åˆ é™¤é…ç½®

```bash
# è½¯åˆ é™¤ï¼ˆè®¾ç½®ä¸ºä¸æ´»è·ƒï¼‰
curl -X DELETE "http://recommender-api:8080/api/v1/tracking-configs/mymx/vlog_feed"
```

---

## éªŒè¯å’Œè°ƒè¯•

### 1. éªŒè¯æ¨¡å¼ï¼ˆä¸å®é™…å‘é€ï¼‰

```python
# ä»…éªŒè¯æ•°æ®æ ¼å¼ï¼Œä¸å‘é€åˆ°Kafka
response = requests.post(
    "http://recommender-api:8080/api/v1/behaviors/validate",
    json=event_data
)

if response.json()["success"]:
    print("âœ… æ•°æ®æ ¼å¼æ­£ç¡®")
else:
    print("âŒ æ•°æ®æ ¼å¼é”™è¯¯:", response.json())
```

### 2. æŸ¥çœ‹éªŒè¯è­¦å‘Š

å¦‚æœåœºæ™¯æ•°æ®ä¸ç¬¦åˆé…ç½®ï¼Œä¼šè¿”å›è­¦å‘Šï¼š

```python
response = requests.post(
    "http://recommender-api:8080/api/v1/behaviors/track",
    json=event_data
)

result = response.json()
if "validation_warnings" in result:
    print("âš ï¸  éªŒè¯è­¦å‘Š:", result["validation_warnings"])
```

### 3. å¥åº·æ£€æŸ¥

```bash
curl "http://recommender-api:8080/api/v1/behaviors/health"
```

è¾“å‡ºç¤ºä¾‹ï¼š
```json
{
  "status": "healthy",
  "kafka_available": true,
  "stats": {
    "total_events": 10000,
    "kafka_success": 9995,
    "kafka_failed": 5,
    "rejected": 0,
    "validation_warnings": 10,
    "success_rate": 99.95
  }
}
```

---

## æœ€ä½³å®è·µ

### 1. å­—æ®µè®¾è®¡åŸåˆ™

âœ… **å¿…å¡«å­—æ®µå°½é‡å°‘** - é™ä½æ¥å…¥æˆæœ¬  
âœ… **å­—æ®µå‘½åè§„èŒƒ** - ä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿ï¼ˆsnake_caseï¼‰  
âœ… **è®¾ç½®åˆç†èŒƒå›´** - ä½¿ç”¨min_value/max_valueé™åˆ¶  
âœ… **ä½¿ç”¨æšä¸¾å€¼** - é™åˆ¶å­—ç¬¦ä¸²å­—æ®µçš„å–å€¼èŒƒå›´

### 2. æ•°æ®é‡‡é›†å»ºè®®

- **æ›å…‰äº‹ä»¶ï¼ˆimpressionï¼‰**: ç‰©å“è¿›å…¥è§†å£æ—¶ä¸ŠæŠ¥
- **ç‚¹å‡»äº‹ä»¶ï¼ˆclickï¼‰**: ç”¨æˆ·ç‚¹å‡»æ—¶ç«‹å³ä¸ŠæŠ¥
- **æ’­æ”¾/é˜…è¯»ç»“æŸ**: ç”¨æˆ·ç¦»å¼€æˆ–å®Œæˆæ—¶ä¸ŠæŠ¥ï¼ˆåŒ…å«æ—¶é•¿ã€è¿›åº¦ç­‰ï¼‰
- **æ‰¹é‡ä¸ŠæŠ¥**: æ›å…‰äº‹ä»¶å»ºè®®æ‰¹é‡ä¸ŠæŠ¥ï¼ˆæ¯ç§’æˆ–æ¯10æ¡ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–

```python
# âŒ ä¸æ¨èï¼šæ¯ä¸ªæ›å…‰å•ç‹¬ä¸ŠæŠ¥
for item in items:
    track_event(item, action="impression")

# âœ… æ¨èï¼šæ‰¹é‡ä¸ŠæŠ¥æ›å…‰
track_batch([
    {"item_id": item["id"], "action_type": "impression"}
    for item in items
])
```

### 4. é”™è¯¯å¤„ç†

```python
try:
    response = requests.post(url, json=event, timeout=3)
    response.raise_for_status()
except requests.exceptions.Timeout:
    # è¶…æ—¶ï¼šè®°å½•æ—¥å¿—ï¼Œç¨åé‡è¯•
    logger.warning("Tracking timeout, will retry")
    retry_queue.append(event)
except requests.exceptions.RequestException as e:
    # å…¶ä»–é”™è¯¯ï¼šè®°å½•æ—¥å¿—
    logger.error(f"Tracking failed: {e}")
```

### 5. ç›‘æ§æŒ‡æ ‡

å…³é”®æŒ‡æ ‡ï¼š
- ä¸ŠæŠ¥æˆåŠŸç‡ > 99.9%
- æ¥å£å“åº”æ—¶é—´ < 100msï¼ˆP99ï¼‰
- Kafkaå‘é€æˆåŠŸç‡ > 99.9%
- æ•°æ®éªŒè¯é€šè¿‡ç‡ > 95%

### 6. ç¯å¢ƒéš”ç¦»

```python
# å¼€å‘/ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
KAFKA_CONFIG = {
    "dev": {
        "bootstrap_servers": "localhost:9092",
        "security_protocol": "PLAINTEXT"
    },
    "prod": {
        "bootstrap_servers": "kafka-1:9092,kafka-2:9092,kafka-3:9092",
        "security_protocol": "SASL_SSL",
        "sasl_username": os.getenv("KAFKA_USER"),
        "sasl_password": os.getenv("KAFKA_PASSWORD")
    }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ‰©å±•è‡ªå®šä¹‰åœºæ™¯ï¼Ÿ

A: æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼1ï¼šä½¿ç”¨custom_dataï¼ˆçµæ´»ï¼Œæ— éªŒè¯ï¼‰**
```json
{
  "scenario_data": {
    "custom_data": {
      "custom_field_1": "value1",
      "custom_field_2": 123
    }
  }
}
```

**æ–¹å¼2ï¼šåˆ›å»ºè‡ªå®šä¹‰é…ç½®ï¼ˆæ¨èï¼Œæœ‰éªŒè¯ï¼‰**
```bash
curl -X POST "/api/v1/tracking-configs/" \
  -d '{
    "scenario_type": "custom",
    "required_fields": [...]
  }'
```

### Q2: åœºæ™¯é…ç½®æ›´æ–°åï¼Œæ—§æ•°æ®æ€ä¹ˆåŠï¼Ÿ

A: 
- æ—§æ•°æ®ä»ç„¶æœ‰æ•ˆï¼ˆå‘åå…¼å®¹ï¼‰
- æ–°å­—æ®µä¼šæœ‰é»˜è®¤å€¼æˆ–æ ‡è®°ä¸ºç¼ºå¤±
- å»ºè®®ä½¿ç”¨ç‰ˆæœ¬å·ç®¡ç†é…ç½®å˜æ›´

### Q3: å¿…å¡«å­—æ®µç¼ºå¤±ä¼šæ€æ ·ï¼Ÿ

A: 
- åŸºç¡€å¿…å¡«å­—æ®µï¼ˆtenant_idç­‰ï¼‰ç¼ºå¤±ä¼šè¢«æ‹’ç»ï¼ˆè¿”å›400ï¼‰
- åœºæ™¯ç‰¹å®šå­—æ®µç¼ºå¤±åªä¼šäº§ç”Ÿè­¦å‘Šï¼ˆä¸å½±å“ä¸ŠæŠ¥ï¼‰

### Q4: å¦‚ä½•æµ‹è¯•åŸ‹ç‚¹æ•°æ®ï¼Ÿ

A:
```python
# 1. ä½¿ç”¨éªŒè¯æ¥å£
response = requests.post("/api/v1/behaviors/validate", json=event)

# 2. æŸ¥çœ‹Kafkaæ¶ˆæ¯
kafka-console-consumer --topic user-behaviors-mymx

# 3. æŸ¥è¯¢ClickHouseï¼ˆFlinkå¤„ç†åï¼‰
SELECT * FROM user_behaviors WHERE scenario_id = 'vlog_feed' LIMIT 10;
```

### Q5: HTTP vs gRPC vs Kafkaï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ

A:
- **Cç«¯åº”ç”¨** â†’ HTTP APIï¼ˆç®€å•ã€å…¼å®¹æ€§å¥½ï¼‰
- **å†…éƒ¨æœåŠ¡ï¼ˆä½é¢‘ï¼‰** â†’ gRPCï¼ˆç±»å‹å®‰å…¨ã€æ€§èƒ½å¥½ï¼‰
- **å†…éƒ¨æœåŠ¡ï¼ˆé«˜é¢‘ï¼‰** â†’ Kafkaç›´æ¥å†™å…¥ï¼ˆè¶…é«˜æ€§èƒ½ï¼‰

### Q6: Kafkaç›´æ¥å†™å…¥ä¼šç»•è¿‡éªŒè¯å—ï¼Ÿ

A: æ˜¯çš„ï¼Œä½†å»ºè®®ï¼š
- å®¢æˆ·ç«¯å®ç°æ•°æ®éªŒè¯é€»è¾‘
- å®šæœŸç›‘æ§æ•°æ®è´¨é‡
- ä½¿ç”¨ Flink è¿›è¡Œæ•°æ®è´¨é‡ç›‘æ§

### Q7: Protoæ–‡ä»¶æ›´æ–°åéœ€è¦é‡å¯æœåŠ¡å—ï¼Ÿ

A: æ˜¯çš„ï¼Œéœ€è¦ï¼š
1. ç”Ÿæˆæ–°çš„Pythonä»£ç 
2. å¤åˆ¶åˆ°é¡¹ç›®
3. é‡å¯æ¨èç³»ç»ŸæœåŠ¡

```bash
# é‡å¯Dockerå®¹å™¨
docker restart lemo_recommender

# æˆ–K8s Pod
kubectl rollout restart deployment/recommender-service
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- **æ–‡æ¡£**: [ç³»ç»Ÿè®¾è®¡.md](./ç³»ç»Ÿè®¾è®¡.md)
- **APIæ–‡æ¡£**: http://recommender-api:8080/api/v1/docs
- **gRPCå®šä¹‰**: /Users/edy/Lemo/andrew-protos/protos/recommender/v1/behavior.proto
- **æ¶æ„æ–¹æ¡ˆ**: [æ•°æ®åˆ†ææ¶æ„æ–¹æ¡ˆ.md](./æ•°æ®åˆ†ææ¶æ„æ–¹æ¡ˆ.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-30  
**ç»´æŠ¤è€…**: æ¨èç³»ç»Ÿå›¢é˜Ÿ

