# æ¨èç³»ç»Ÿå®Œæ•´å¼€å‘æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®**: Lemoæ¨èç³»ç»Ÿ  
**æ¶æ„**: å‰åç«¯åˆ†ç¦» + å¾®æœåŠ¡  
**æŠ€æœ¯æ ˆ**:
- å‰ç«¯: Vue3 + TypeScript + Arco Design
- åç«¯ç½‘å…³: Go (Ginæ¡†æ¶)
- æ¨èæœåŠ¡: Python (gRPC)
- æ•°æ®åº“: MongoDB, MySQL
- éƒ¨ç½²: Docker + Kubernetes

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
å‰ç«¯(Vue3) â†’ service_manager(Goç½‘å…³) â†’ lemo_recommender(Python gRPCæœåŠ¡)
                    â†“                              â†“
              andrew-file(æ–‡ä»¶æœåŠ¡)            MongoDB
```

### æ ¸å¿ƒåŸåˆ™

1. **APIç½‘å…³æ¨¡å¼**: å‰ç«¯åªä¸service_manageré€šä¿¡ï¼Œä¸ç›´æ¥è°ƒç”¨lemo_recommender
2. **è‡ªåŠ¨IDç”Ÿæˆ**: æ‰€æœ‰èµ„æºID(template_id, scenario_id, model_id, item_id, experiment_id)ç”±åç«¯è‡ªåŠ¨ç”Ÿæˆ
3. **ç§Ÿæˆ·éš”ç¦»**: æ‰€æœ‰æ•°æ®æŒ‰tenant_idéš”ç¦»
4. **å¯é€‰ç­›é€‰**: åˆ—è¡¨æŸ¥è¯¢æ—¶ç§Ÿæˆ·ç­›é€‰ä¸ºå¯é€‰ï¼Œä¸ºç©ºæ—¶æŸ¥è¯¢æ‰€æœ‰

---

## ğŸ“ é¡¹ç›®ç»“æ„

### GoæœåŠ¡ (service_manager)
```
service_manager_server/
â”œâ”€â”€ app/admin/recommender/  # æ¨èç³»ç»ŸHTTPæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ model.go           # æ¨¡å‹ç®¡ç†
â”‚   â”œâ”€â”€ template.go        # æ¨¡æ¿ç®¡ç†
â”‚   â”œâ”€â”€ scenario.go        # åœºæ™¯ç®¡ç†
â”‚   â”œâ”€â”€ item.go            # ç‰©å“ç®¡ç†
â”‚   â”œâ”€â”€ experiment.go      # ABå®éªŒç®¡ç†
â”‚   â””â”€â”€ dataset.go         # æ•°æ®é›†ç®¡ç†
â”œâ”€â”€ rpc/                   # gRPCå®¢æˆ·ç«¯
â”‚   â””â”€â”€ recommender_clients.go
â””â”€â”€ route/
    â””â”€â”€ router.go          # è·¯ç”±é…ç½®
```

### PythonæœåŠ¡ (lemo_recommender)
```
lemo_recommender/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/            # Pydanticæ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ model.py
â”‚   â”‚   â”œâ”€â”€ template.py
â”‚   â”‚   â”œâ”€â”€ scenario.py
â”‚   â”‚   â”œâ”€â”€ item.py
â”‚   â”‚   â””â”€â”€ experiment.py
â”‚   â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”œâ”€â”€ template/
â”‚   â”‚   â”œâ”€â”€ scenario/
â”‚   â”‚   â”œâ”€â”€ item/
â”‚   â”‚   â””â”€â”€ experiment/
â”‚   â””â”€â”€ grpc_server/       # gRPCæœåŠ¡å±‚
â”‚       â””â”€â”€ services/
â”‚           â”œâ”€â”€ model_service.py
â”‚           â”œâ”€â”€ template_service.py
â”‚           â”œâ”€â”€ scenario_service.py
â”‚           â”œâ”€â”€ item_service.py
â”‚           â””â”€â”€ experiment_service.py
```

### å‰ç«¯ (service_manager_web/admin)
```
src/views/recommender/
â”œâ”€â”€ model/                 # æ¨¡å‹ç®¡ç†
â”‚   â”œâ”€â”€ index.vue
â”‚   â”œâ”€â”€ Create.vue
â”‚   â””â”€â”€ components/
â”œâ”€â”€ template/              # æ¨¡æ¿ç®¡ç†
â”œâ”€â”€ scenario/              # åœºæ™¯ç®¡ç†
â”œâ”€â”€ item/                  # ç‰©å“ç®¡ç†
â””â”€â”€ experiment/            # ABå®éªŒç®¡ç†
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

### 1. Protobufæ•°æ®è½¬æ¢

#### Timestampè½¬æ¢
```python
# Python: datetime â†’ protobuf Timestamp
from google.protobuf import timestamp_pb2
ts = timestamp_pb2.Timestamp()
ts.FromDatetime(datetime_obj)

# å‰ç«¯: protobuf â†’ æ˜¾ç¤ºæ ¼å¼
const formatTimestamp = (timestamp: any): string => {
  if (timestamp.seconds !== undefined) {
    const date = new Date(timestamp.seconds * 1000);
    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
  }
  return '-';
};
```

#### Enumæ˜ å°„
```python
# Python enum â†’ protobuf enum
status_map = {
    "draft": 1,
    "deployed": 2,
    "archived": 3,
}

# å‰ç«¯: string value
const statusOptions = [
  { label: 'è‰ç¨¿', value: 'draft' },
  { label: 'å·²éƒ¨ç½²', value: 'deployed' },
];
```

#### Structè½¬æ¢
```python
# Python dict â†’ protobuf Struct
from google.protobuf import struct_pb2
config_struct = struct_pb2.Struct()
config_struct.update(config_dict)

# protobuf Struct â†’ Python dict
from google.protobuf.json_format import MessageToDict
config_dict = MessageToDict(struct_proto)
```

### 2. Go POSTè¯·æ±‚å‚æ•°è¯»å–

```go
// âœ… æ­£ç¡®ï¼šä»POST bodyè¯»å–
body, _ := io.ReadAll(c.Request.Body)
var parameter map[string]interface{}
_ = json.Unmarshal(body, &parameter)

tenantID := ""
if tid, ok := parameter["tenant_id"].(string); ok {
    tenantID = tid
}

// âŒ é”™è¯¯ï¼šç”¨c.Queryè¯»å–POSTå‚æ•°
tenantID := c.Query("tenant_id")  // è¯»ä¸åˆ°POST bodyçš„æ•°æ®
```

### 3. å‰ç«¯APIè°ƒç”¨

```typescript
// defHttpå·²å¤„ç†response.dataï¼Œç›´æ¥è¿”å›æ•°æ®
const data = await list(params);  // âœ… æ­£ç¡®
const { data } = await list(params);  // âŒ é”™è¯¯ï¼ˆåŒé‡è§£æ„ï¼‰

// è®¾ç½®row-key
<a-table row-key="model_id" ... />  // âœ… ä½¿ç”¨å®é™…å­—æ®µ
<a-table row-key="id" ... />  // âŒ å­—æ®µå¯èƒ½ä¸å­˜åœ¨

// åˆ†é¡µé…ç½®
const basePagination = reactive({ current: 1, pageSize: 20, total: 0 });
```

### 4. MongoDB ObjectIDç”Ÿæˆ

```go
// Go
import "go.mongodb.org/mongo-driver/bson/primitive"
modelID := primitive.NewObjectID().Hex()

// Python
from bson import ObjectId
model_id = ObjectId().hex
```

---

## ğŸ“ å¼€å‘è§„èŒƒ

### 1. IDç”Ÿæˆè§„åˆ™
- **æ‰€æœ‰èµ„æºIDç”±åç«¯è‡ªåŠ¨ç”Ÿæˆ**
- ä½¿ç”¨MongoDB ObjectID (24ä½hexå­—ç¬¦ä¸²)
- å‰ç«¯è¡¨å•ä¸éœ€è¦è¾“å…¥IDå­—æ®µ

### 2. ç§Ÿæˆ·å‚æ•°å¤„ç†
```python
# PythonæœåŠ¡æ”¯æŒç©ºç§Ÿæˆ·
filter_query = {}
if tenant_id:  # æœ‰å€¼æ‰åŠ å…¥æŸ¥è¯¢æ¡ä»¶
    filter_query["tenant_id"] = tenant_id
```

### 3. é”™è¯¯å¤„ç†
```typescript
// å‰ç«¯ç©ºæ•°æ®å¤„ç†
try {
  const data = await list(params);
  items.value = data?.items || [];
} catch (error) {
  console.error('æŸ¥è¯¢å¤±è´¥:', error);  // âœ… åªè®°å½•æ—¥å¿—
  // âŒ ä¸è¦: Message.error('æŸ¥è¯¢å¤±è´¥');
}
```

### 4. æ—¶é—´æ ¼å¼ç»Ÿä¸€
- æ•°æ®åº“: UTC datetime
- Protobuf: Timestamp (seconds + nanos)
- å‰ç«¯æ˜¾ç¤º: YYYY/MM/DD HH:mm:ss

### 5. çŠ¶æ€æ˜ å°„
```python
# Python Pydantic Enum
class ModelStatus(str, Enum):
    DRAFT = "draft"
    DEPLOYED = "deployed"
    ARCHIVED = "archived"

# Protobuf Enum (ä»1å¼€å§‹)
enum ModelStatus {
  MODEL_STATUS_UNSPECIFIED = 0;
  MODEL_STATUS_DRAFT = 1;
  MODEL_STATUS_DEPLOYED = 2;
  MODEL_STATUS_ARCHIVED = 3;
}

# å‰ç«¯æ˜¾ç¤º
const STATUS_MAP = {
  draft: 'è‰ç¨¿',
  deployed: 'å·²éƒ¨ç½²',
  archived: 'å·²å½’æ¡£',
};
```

---

## ğŸ¯ å·²å®ŒæˆåŠŸèƒ½æ¨¡å—

### 1. æ¨¡å‹ç®¡ç† âœ…
- âœ… åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒç§Ÿæˆ·/ç±»å‹/çŠ¶æ€ç­›é€‰ï¼‰
- âœ… åˆ›å»ºæ¨¡å‹ï¼ˆè‡ªåŠ¨ç”Ÿæˆmodel_idï¼‰
- âœ… ç¼–è¾‘æ¨¡å‹
- âœ… åˆ é™¤æ¨¡å‹
- âœ… ç‰¹å¾é…ç½®ï¼ˆåˆ†ç±»ç»“æ„ï¼šuser/item/context/interactionï¼‰
- âœ… ç®—æ³•å‚æ•°é…ç½®ï¼ˆæ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€æ˜¾ç¤ºï¼‰
- âœ… è®­ç»ƒæ•°æ®è·¯å¾„é…ç½®

**ç‰¹ç‚¹**:
- æ¨¡å‹ç±»å‹: recall/rank/rerank
- ç‰¹å¾åˆ†ç±»ç®¡ç†ï¼ˆä»å­—å…¸è¡¨åŠ¨æ€åŠ è½½ï¼‰
- ç®—æ³•å‚æ•°å¸¦é»˜è®¤å€¼å’Œæ³¨é‡Š
- çŠ¶æ€é¢œè‰²æ ‡ç­¾æ˜¾ç¤º

### 2. æ¨¡æ¿ç®¡ç† âœ…
- âœ… åˆ—è¡¨æŸ¥è¯¢
- âœ… åˆ›å»ºæ¨¡æ¿
- âœ… å¯è§†åŒ–é…ç½®ç¼–è¾‘å™¨
- âœ… æ¨¡å‹é€‰æ‹©ï¼ˆæŒ‰ç±»å‹ç­›é€‰ï¼‰
- âœ… åœºæ™¯ç±»å‹ï¼ˆä»å­—å…¸è¡¨åŠ¨æ€åŠ è½½ï¼‰

**ç‰¹ç‚¹**:
- ä¸å…³è”ç§Ÿæˆ·ï¼ˆè·¨ç§Ÿæˆ·å¯å¤ç”¨ï¼‰
- åœºæ™¯ç±»å‹é…ç½®åŒ–
- å¯è§†åŒ–é…ç½®ï¼ˆRecall/Rank/Rerankï¼‰

### 3. åœºæ™¯ç®¡ç† âœ…
- âœ… åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒç§Ÿæˆ·/ç±»å‹/çŠ¶æ€ç­›é€‰ï¼‰
- âœ… åˆ›å»ºåœºæ™¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆscenario_idï¼‰
- âœ… ç¼–è¾‘åœºæ™¯
- âœ… å¯è§†åŒ–é…ç½®ç¼–è¾‘å™¨
- âœ… çŠ¶æ€åˆ‡æ¢

**ç‰¹ç‚¹**:
- ä¸ç§Ÿæˆ·ç»‘å®š
- åŸºäºæ¨¡æ¿åˆ›å»º
- æ”¯æŒç‹¬ç«‹é…ç½®

### 4. ç‰©å“ç®¡ç† âœ…
- âœ… åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒç§Ÿæˆ·/åœºæ™¯/çŠ¶æ€ç­›é€‰ï¼‰
- âœ… åˆ›å»ºç‰©å“ï¼ˆè‡ªåŠ¨ç”Ÿæˆitem_idï¼‰
- âœ… ç¼–è¾‘ç‰©å“
- âœ… åˆ é™¤ç‰©å“ï¼ˆè½¯åˆ é™¤ï¼‰
- âœ… æ‰¹é‡å¯¼å…¥

**ç‰¹ç‚¹**:
- æŒ‰åœºæ™¯ç»„ç»‡
- æ”¯æŒå…ƒæ•°æ®(metadata)
- æ”¯æŒå‘é‡(embedding)

### 5. ABå®éªŒç®¡ç† âœ…
- âœ… åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒç§Ÿæˆ·/çŠ¶æ€ç­›é€‰ï¼‰
- âœ… åˆ›å»ºå®éªŒï¼ˆè‡ªåŠ¨ç”Ÿæˆexperiment_idï¼‰
- âœ… å¯åŠ¨/åœæ­¢å®éªŒ
- âœ… åˆ é™¤å®éªŒï¼ˆè½¯åˆ é™¤â†’archivedï¼‰
- âœ… æµé‡åˆ†é…é…ç½®

**ç‰¹ç‚¹**:
- å¯¹ç…§ç»„/å®éªŒç»„é…ç½®
- æµé‡åˆ†é…éªŒè¯ï¼ˆæ€»å’Œ100%ï¼‰
- çŠ¶æ€æµè½¬ç®¡ç†

---

## ğŸ”§ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. å‰ç«¯åˆ—è¡¨ä¸æ˜¾ç¤ºæ•°æ®
**åŸå› **: åŒé‡è§£æ„æˆ–row-keyé”™è¯¯  
**è§£å†³**:
```typescript
// âœ… æ­£ç¡®
const data = await list(params);
items.value = data?.items || [];

// âœ… æ­£ç¡®row-key
<a-table row-key="model_id" ... />
```

### 2. Goæ¥å£è¯»ä¸åˆ°POSTå‚æ•°
**åŸå› **: ä½¿ç”¨c.Queryè¯»å–POST bodyå‚æ•°  
**è§£å†³**:
```go
// âœ… æ­£ç¡®ï¼šä»bodyè¯»å–
body, _ := io.ReadAll(c.Request.Body)
var parameter map[string]interface{}
_ = json.Unmarshal(body, &parameter)
```

### 3. Python PydanticéªŒè¯å¤±è´¥
**åŸå› **: å­—å…¸ç»“æ„ä¸æ¨¡å‹ä¸åŒ¹é…  
**è§£å†³**:
```python
# âœ… ä½¿ç”¨model_validate
item = Item.model_validate(doc)

# âœ… ä½¿ç”¨model_dumpè½¬æ¢
result.model_dump()
```

### 4. æ—¶é—´æ˜¾ç¤ºä¸ºprotobufæ ¼å¼
**åŸå› **: æœªæ ¼å¼åŒ–timestamp  
**è§£å†³**:
```typescript
// æ·»åŠ formatTimestampå‡½æ•°
const formatTimestamp = (timestamp: any): string => {
  if (timestamp.seconds !== undefined) {
    const date = new Date(timestamp.seconds * 1000);
    // æ ¼å¼åŒ–...
  }
  return '-';
};
```

### 5. Enumå€¼ä¸åŒ¹é…
**åŸå› **: å‰ç«¯å‘é€å­—ç¬¦ä¸²ï¼Œåç«¯æœŸæœ›æ•°å­—  
**è§£å†³**:
```typescript
// âœ… å‰ç«¯å‘é€å­—ç¬¦ä¸²
params.model_type = 'recall'  // ä¸æ˜¯ 1

// Goåç«¯è½¬æ¢
model_type_map := map[string]int{
    "recall": 1,
    "rank": 2,
}
```

---

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### PythonæœåŠ¡é‡å¯
```bash
docker restart lemo_recommender
```

### å‰ç«¯æ„å»º
```bash
cd /Users/edy/Lemo/service_manage/service_manager_web/admin
yarn build
```

### æµ‹è¯•æ¸…å•
- [ ] æ¨¡å‹ç®¡ç†ï¼šåˆ—è¡¨/åˆ›å»º/ç¼–è¾‘/åˆ é™¤
- [ ] æ¨¡æ¿ç®¡ç†ï¼šåˆ—è¡¨/åˆ›å»º/ç¼–è¾‘
- [ ] åœºæ™¯ç®¡ç†ï¼šåˆ—è¡¨/åˆ›å»º/ç¼–è¾‘/çŠ¶æ€åˆ‡æ¢
- [ ] ç‰©å“ç®¡ç†ï¼šåˆ—è¡¨/åˆ›å»º/æ‰¹é‡å¯¼å…¥
- [ ] ABå®éªŒï¼šåˆ—è¡¨/åˆ›å»º/å¯åŠ¨/åœæ­¢

---

## ğŸ“Š æ•°æ®å­—å…¸

### ç‰¹å¾å­—å…¸è¡¨
- **è¡¨ç»“æ„**: `common_dictionary_table` (å®šä¹‰è¡¨) + `common_dictionary_data` (æ•°æ®è¡¨) æˆ– åŠ¨æ€è¡¨
- **ç‰¹å¾åˆ†ç±»**: 
  - `rec_feature_user` (ç”¨æˆ·ç‰¹å¾)
  - `rec_feature_item` (ç‰©å“ç‰¹å¾)
  - `rec_feature_context` (ä¸Šä¸‹æ–‡ç‰¹å¾)
  - `rec_feature_interaction` (äº¤äº’ç‰¹å¾)

### åœºæ™¯ç±»å‹å­—å…¸
- **è¡¨**: `rec_scenario_type`
- **ç¤ºä¾‹**: vlog, news, ecommerce

---

## ğŸ” æƒé™å’Œä¸­é—´ä»¶

### ç§Ÿæˆ·IDè·å–
```go
// Goä¸­é—´ä»¶è‡ªåŠ¨æ³¨å…¥
userInfo, _ := middleware.GetUserInfo(c)
tenantID := userInfo.BusinessID
```

### APIéªŒè¯
- `ValidityAPi` ä¸­é—´ä»¶éªŒè¯è¯·æ±‚å¤´
- `verify-encrypt`, `verify-time` headers

---

## ğŸ“š å‚è€ƒèµ„æ–™

### Protoæ–‡ä»¶ä½ç½®
- `andrew-protos/proto/recommender/v1/`

### ç”Ÿæˆå‘½ä»¤
```bash
cd andrew-protos
make generate
```

### ä¾èµ–æ›´æ–°
```bash
cd service_manager_server
go mod vendor  # æ›´æ–°vendor
```

---

## âœ… ä¸‹ä¸€æ­¥å·¥ä½œ

1. **å®éªŒç»“æœå±•ç¤º** (å¾…å¼€å‘)
2. **æ•°æ®é›†ç®¡ç†å‰ç«¯** (åç«¯å·²å®Œæˆ)
3. **æ¨¡å‹è®­ç»ƒè§¦å‘** (é›†æˆè®­ç»ƒæœåŠ¡)
4. **å®æ—¶æ¨èAPI** (åœ¨çº¿æœåŠ¡)
5. **æ€§èƒ½ç›‘æ§** (æŒ‡æ ‡é‡‡é›†å’Œå±•ç¤º)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

