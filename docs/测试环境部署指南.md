# æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æŒ‡å—ï¼ˆ2CPU+8Gå†…å­˜ï¼‰

> ğŸ¯ **è¯´æ˜**: æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨æµ‹è¯•ç¯å¢ƒï¼ˆ2CPU+8Gå†…å­˜ï¼‰ä¸Šéƒ¨ç½²v2.0å¾®æœåŠ¡æ¶æ„

---

## ğŸ“Š èµ„æºåˆ†é…

### æ€»èµ„æº

- **CPU**: 2æ ¸
- **å†…å­˜**: 8GB
- **æœåŠ¡æ•°**: 7ä¸ªï¼ˆå¾®æœåŠ¡æ¶æ„ï¼‰

### æ¯ä¸ªæœåŠ¡çš„èµ„æºé…ç½®

| æœåŠ¡ | å‰¯æœ¬æ•° | CPUè¯·æ±‚ | CPUé™åˆ¶ | å†…å­˜è¯·æ±‚ | å†…å­˜é™åˆ¶ | è¯´æ˜ |
|------|--------|---------|---------|----------|----------|------|
| **å¬å›æœåŠ¡** | 1 | 200m | 500m | 512Mi | 1Gi | å¤šè·¯å¬å›ï¼ŒCPUå¯†é›† |
| **ç²¾æ’æœåŠ¡** | 1 | 200m | 500m | 512Mi | 1Gi | æ¨¡å‹æ¨ç†ï¼Œå†…å­˜éœ€æ±‚é«˜ |
| **é‡æ’æœåŠ¡** | 1 | 100m | 300m | 256Mi | 512Mi | è½»é‡çº§æœåŠ¡ |
| **HTTP API** | 1 | 100m | 500m | 128Mi | 512Mi | BFFç¼–æ’å±‚ |
| **Worker** | 1 | 200m | 1000m | 256Mi | 1Gi | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **Beat** | 1 | 100m | 200m | 128Mi | 256Mi | å®šæ—¶ä»»åŠ¡è°ƒåº¦ |
| **Consumer** | 1 | 250m | 500m | 256Mi | 512Mi | Kafkaæ¶ˆè´¹ |
| **åˆè®¡** | **7** | **1.15æ ¸** | **3.5æ ¸** | **2.05Gi** | **4.76Gi** |

âœ… **èµ„æºåˆ©ç”¨ç‡**: 
- CPUè¯·æ±‚: 1.15æ ¸ / 2æ ¸ = **57.5%**
- å†…å­˜è¯·æ±‚: 2.05Gi / 8Gi = **25.6%**
- CPUé™åˆ¶æ€»å’Œ: 3.5æ ¸ï¼ˆå…è®¸burstï¼‰
- å†…å­˜é™åˆ¶æ€»å’Œ: 4.76Giï¼ˆå…è®¸burstï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å‡†å¤‡å·¥ä½œ

ç¡®è®¤K8sé›†ç¾¤å¯ç”¨ï¼š

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml get nodes
```

ç¡®è®¤namespaceå­˜åœ¨ï¼š

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml get namespace lemo-dev
```

---

### 2. ä¸€é”®éƒ¨ç½²æ‰€æœ‰å¾®æœåŠ¡

```bash
cd /Users/edy/PycharmProjects/lemo_recommender
./k8s-deploy/deploy-all-microservices.sh
```

è¿™ä¸ªè„šæœ¬ä¼šä¾æ¬¡éƒ¨ç½²ï¼š
1. å¬å›æœåŠ¡
2. ç²¾æ’æœåŠ¡
3. é‡æ’æœåŠ¡

---

### 3. éƒ¨ç½²å…¶ä»–æœåŠ¡ï¼ˆå¯é€‰ï¼‰

```bash
# WorkeræœåŠ¡ï¼ˆå¼ºçƒˆæ¨èï¼‰
./k8s-deploy/deploy-worker-service.sh

# BeatæœåŠ¡ï¼ˆå¼ºçƒˆæ¨èï¼‰
./k8s-deploy/deploy-beat-service.sh

# ConsumeræœåŠ¡ï¼ˆå¯é€‰ï¼‰
./k8s-deploy/deploy-consumer-service.sh
```

---

### 4. éªŒè¯éƒ¨ç½²

æŸ¥çœ‹æ‰€æœ‰PodçŠ¶æ€ï¼š

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev get pods
```

æœŸæœ›è¾“å‡ºï¼ˆæ‰€æœ‰Podéƒ½æ˜¯Runningï¼‰ï¼š

```
NAME                                  READY   STATUS    RESTARTS   AGE
recall-service-xxx                    1/1     Running   0          2m
ranking-service-xxx                   1/1     Running   0          2m
reranking-service-xxx                 1/1     Running   0          2m
lemo-service-recommender-http-xxx     1/1     Running   0          5m
lemo-service-recommender-worker-xxx   1/1     Running   0          5m
lemo-service-recommender-beat-xxx     1/1     Running   0          5m
```

æŸ¥çœ‹æœåŠ¡ï¼š

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev get svc
```

---

### 5. æµ‹è¯•æœåŠ¡

#### æµ‹è¯•å¬å›æœåŠ¡

```bash
# ç«¯å£è½¬å‘
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev port-forward svc/recall-service 8081:8081

# æ–°ç»ˆç«¯çª—å£æµ‹è¯•
curl http://localhost:8081/health

# æœŸæœ›è¾“å‡º
{
  "status": "healthy",
  "service": "recall-service",
  "strategies": ["hot_items", "user_cf", "item_cf", "als_cf"]
}
```

#### æµ‹è¯•ç²¾æ’æœåŠ¡

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev port-forward svc/ranking-service 8082:8082
curl http://localhost:8082/health
```

#### æµ‹è¯•é‡æ’æœåŠ¡

```bash
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev port-forward svc/reranking-service 8083:8083
curl http://localhost:8083/health
```

---

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

### å•å‰¯æœ¬æ€§èƒ½

| æŒ‡æ ‡ | å¬å›æœåŠ¡ | ç²¾æ’æœåŠ¡ | é‡æ’æœåŠ¡ |
|------|---------|---------|---------|
| **QPS** | ~100 | ~80 | ~200 |
| **P99å»¶è¿Ÿ** | <80ms | <100ms | <30ms |
| **å†…å­˜ä½¿ç”¨** | ~600Mi | ~700Mi | ~300Mi |
| **CPUä½¿ç”¨** | ~300m | ~400m | ~150m |

### æ•´ä½“æ¨èæ€§èƒ½

- **æ¨èQPS**: ~50-80ï¼ˆå—é™äºä¸²è¡Œè°ƒç”¨ï¼‰
- **P99å»¶è¿Ÿ**: <300ms
- **å¹¶å‘ç”¨æˆ·**: ~500-1000

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èµ„æºç«äº‰

æµ‹è¯•ç¯å¢ƒèµ„æºæœ‰é™ï¼Œæ³¨æ„ï¼š

- âœ… é¿å…æ‰€æœ‰æœåŠ¡åŒæ—¶é«˜è´Ÿè½½
- âœ… é€‚å½“é™ä½å‰¯æœ¬æ•°ï¼ˆå·²è®¾ç½®ä¸º1ï¼‰
- âœ… è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶

### 2. K8sè°ƒåº¦

å¦‚æœå‡ºç°Pod Pendingï¼ˆèµ„æºä¸è¶³ï¼‰ï¼š

```bash
# æŸ¥çœ‹Podäº‹ä»¶
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev describe pod <pod-name>

# ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šå‡å°‘æŸä¸ªæœåŠ¡çš„èµ„æºè¯·æ±‚
# ä¿®æ”¹å¯¹åº”çš„ k8s-deployment-*.yaml æ–‡ä»¶
```

### 3. æœåŠ¡é™çº§

å¦‚æœèµ„æºä¸è¶³ï¼Œå¯ä»¥ï¼š

1. **æš‚æ—¶å…³é—­ConsumeræœåŠ¡**ï¼ˆä½¿ç”¨HTTP APIæ¥å…¥ç‰©å“ï¼‰
2. **é™ä½Workerå‰¯æœ¬æ•°**ï¼ˆå‡å°‘å¹¶å‘ä»»åŠ¡æ•°ï¼‰
3. **åˆå¹¶æœåŠ¡**ï¼ˆæš‚æ—¶ä½¿ç”¨v1.0æ¶æ„ï¼‰

```bash
# åœæ­¢Consumer
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev scale deployment consumer --replicas=0
```

---

## ğŸ”§ èµ„æºç›‘æ§

### æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ

```bash
# æŸ¥çœ‹æ‰€æœ‰Podçš„èµ„æºä½¿ç”¨
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev top pods

# æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml top nodes
```

### æœŸæœ›è¾“å‡º

```
NAME                                  CPU(cores)   MEMORY(bytes)
recall-service-xxx                    300m         600Mi
ranking-service-xxx                   400m         700Mi
reranking-service-xxx                 150m         300Mi
lemo-service-recommender-http-xxx     100m         200Mi
lemo-service-recommender-worker-xxx   300m         500Mi
lemo-service-recommender-beat-xxx     50m          150Mi
```

---

## ğŸ“Š ä»æµ‹è¯•ç¯å¢ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

### æ‰©å®¹æ­¥éª¤

å½“ä»æµ‹è¯•ç¯å¢ƒè¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼š

1. **å¢åŠ èŠ‚ç‚¹èµ„æº**
   - æµ‹è¯•: 2CPU + 8G
   - ç”Ÿäº§: 32CPU + 64G * Nå°

2. **å¢åŠ å‰¯æœ¬æ•°**
   ```bash
   # å¬å›æœåŠ¡
   kubectl scale deployment recall-service --replicas=10
   
   # ç²¾æ’æœåŠ¡
   kubectl scale deployment ranking-service --replicas=8
   
   # é‡æ’æœåŠ¡
   kubectl scale deployment reranking-service --replicas=5
   ```

3. **å¢åŠ èµ„æºé…ç½®**
   - ä¿®æ”¹ k8s-deployment-*.yaml ä¸­çš„ resources.requests/limits
   - é‡æ–°éƒ¨ç½²

4. **å¯ç”¨HPAè‡ªåŠ¨ä¼¸ç¼©**
   ```yaml
   apiVersion: autoscaling/v2
   kind: HorizontalPodAutoscaler
   metadata:
     name: recall-service-hpa
   spec:
     scaleTargetRef:
       apiVersion: apps/v1
       kind: Deployment
       name: recall-service
     minReplicas: 10
     maxReplicas: 20
     metrics:
     - type: Resource
       resource:
         name: cpu
         target:
           type: Utilization
           averageUtilization: 70
   ```

---

## ğŸ¯ æ•…éšœæ’æŸ¥

### Podæ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev get pods

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev describe pod <pod-name>

# æŸ¥çœ‹Podæ—¥å¿—
kubectl --kubeconfig=k8s-deploy/k3s-jd-config.yaml -n lemo-dev logs <pod-name>
```

### å¸¸è§é—®é¢˜

1. **ImagePullBackOff**
   - æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥ImagePullSecrets

2. **CrashLoopBackOff**
   - æŸ¥çœ‹æ—¥å¿—æ’æŸ¥å¯åŠ¨å¤±è´¥åŸå› 
   - æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®

3. **Pendingï¼ˆèµ„æºä¸è¶³ï¼‰**
   - é™ä½èµ„æºè¯·æ±‚
   - å¢åŠ èŠ‚ç‚¹èµ„æº
   - å‡å°‘å‰¯æœ¬æ•°

---

## âœ… æ€»ç»“

æµ‹è¯•ç¯å¢ƒé…ç½®ï¼ˆ2CPU+8Gï¼‰**å®Œå…¨æ”¯æŒ**v2.0å¾®æœåŠ¡æ¶æ„ï¼š

- âœ… èµ„æºé…ç½®åˆç†ï¼ˆCPUè¯·æ±‚57.5%ï¼Œå†…å­˜è¯·æ±‚25.6%ï¼‰
- âœ… å¯ä»¥è¿è¡Œ7ä¸ªæœåŠ¡
- âœ… æ”¯æŒåŸºæœ¬çš„æ€§èƒ½æµ‹è¯•
- âœ… æ¶æ„ä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´ï¼Œæ–¹ä¾¿æ‰©å±•

**ä¸‹ä¸€æ­¥**ï¼š
1. éƒ¨ç½²å¾®æœåŠ¡
2. æµ‹è¯•æ¨èæ¥å£
3. éªŒè¯æœåŠ¡é—´é€šä¿¡
4. è¿›è¡Œæ€§èƒ½æµ‹è¯•

---

**ç¯å¢ƒ**: æµ‹è¯•ç¯å¢ƒ  
**èµ„æº**: 2CPU + 8Gå†…å­˜  
**æ¶æ„**: v2.0å¾®æœåŠ¡  
**æ›´æ–°æ—¥æœŸ**: 2024-11-05

