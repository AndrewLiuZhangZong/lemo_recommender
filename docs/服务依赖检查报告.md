# Worker/Beat/Consumer æœåŠ¡ä¾èµ–æ£€æŸ¥æŠ¥å‘Š

## ğŸ“Š æ£€æŸ¥æ¦‚è§ˆ

| æœåŠ¡ | ä»£ç çŠ¶æ€ | ä¾èµ–ç»„ä»¶ | Docker éƒ¨ç½²çŠ¶æ€ | é—®é¢˜ |
|------|---------|---------|----------------|------|
| Celery Worker | âœ… æ­£å¸¸ | Redis, MongoDB, Kafka, Milvus | âœ… å·²éƒ¨ç½² | âš ï¸ ç¼º redbeat |
| Celery Beat | âœ… æ­£å¸¸ | Redis | âœ… å·²éƒ¨ç½² | âŒ ç¼º redbeat åº“ |
| Kafka Consumer | âœ… æ­£å¸¸ | Kafka, MongoDB | âœ… å·²éƒ¨ç½² | âœ… æ— é—®é¢˜ |

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1ï¸âƒ£ Celery Worker æœåŠ¡

#### ä»£ç æ£€æŸ¥ âœ…
**æ–‡ä»¶**: `app/tasks/celery_app.py`, `app/tasks/*_tasks.py`

**ä¾èµ–ç»„ä»¶**ï¼š
- âœ… **Redis**ï¼ˆBroker + Backendï¼‰
  - Broker: `redis://:redis_password_2024@111.228.39.41:6379/1`
  - Backend: `redis://:redis_password_2024@111.228.39.41:6379/2`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²ï¼ˆç«¯å£ 6379ï¼‰

- âœ… **MongoDB**ï¼ˆæ•°æ®å­˜å‚¨ï¼‰
  - è¿æ¥ï¼š`mongodb://admin:password@111.228.39.41:27017`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²ï¼ˆç«¯å£ 27017ï¼‰

- âœ… **Kafka**ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  - è¿æ¥ï¼š`111.228.39.41:9092`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²ï¼ˆç«¯å£ 9092ï¼‰

- âš ï¸ **Milvus**ï¼ˆå‘é‡æ•°æ®åº“ï¼Œå¯é€‰ï¼‰
  - è¿æ¥ï¼š`111.228.39.41:19530`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²ï¼ˆç«¯å£ 19530ï¼‰
  - ä½¿ç”¨åœºæ™¯ï¼šç‰©å“å‘é‡ç”Ÿæˆä»»åŠ¡

**æ‰§è¡Œçš„ä»»åŠ¡**ï¼š
1. æ¨¡å‹è®­ç»ƒï¼ˆ`model_tasks.py`ï¼‰- æ¯å¤©å‡Œæ™¨3ç‚¹
2. ç‰©å“ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆ`item_tasks.py`ï¼‰- æ¯å°æ—¶
3. ç‰©å“å‘é‡ç”Ÿæˆï¼ˆ`item_tasks.py`ï¼‰
4. ç”¨æˆ·ç”»åƒæ›´æ–°ï¼ˆ`user_tasks.py`ï¼‰- æ¯2å°æ—¶
5. æ¨èé¢„è®¡ç®—ï¼ˆ`recommendation_tasks.py`ï¼‰- æ¯4å°æ—¶
6. ç¼“å­˜æ¸…ç†ï¼ˆ`recommendation_tasks.py`ï¼‰- æ¯å¤©å‡Œæ™¨4ç‚¹

**é—®é¢˜**ï¼šâœ… ä»£ç æ— é—®é¢˜ï¼Œä¾èµ–ç»„ä»¶å·²å…¨éƒ¨éƒ¨ç½²

---

### 2ï¸âƒ£ Celery Beat æœåŠ¡

#### ä»£ç æ£€æŸ¥ âœ…
**æ–‡ä»¶**: `app/tasks/celery_app.py`

**ä¾èµ–ç»„ä»¶**ï¼š
- âœ… **Redis**ï¼ˆBroker + è°ƒåº¦çŠ¶æ€å­˜å‚¨ï¼‰
  - Broker: `redis://:redis_password_2024@111.228.39.41:6379/1`
  - Backend: `redis://:redis_password_2024@111.228.39.41:6379/2`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²

**è°ƒåº¦å™¨é…ç½®**ï¼š
```yaml
command:
  - "celery"
  - "-A"
  - "app.tasks.celery_app"
  - "beat"
  - "--scheduler"
  - "redbeat.RedBeatScheduler"  # âŒ ä½¿ç”¨äº† RedBeatï¼Œä½†æœªå®‰è£…
```

**å®šæ—¶ä»»åŠ¡æ¸…å•**ï¼š
1. `compute-item-similarity-hourly` - æ¯å°æ—¶
2. `update-user-profiles-2hours` - æ¯2å°æ—¶
3. `train-model-daily` - æ¯å¤©å‡Œæ™¨3ç‚¹
4. `precompute-recommendations-4hours` - æ¯4å°æ—¶
5. `cleanup-expired-cache-daily` - æ¯å¤©å‡Œæ™¨4ç‚¹

**é—®é¢˜**ï¼šâŒ **ä¸¥é‡é—®é¢˜**
- K8s é…ç½®ä¸­ä½¿ç”¨äº† `redbeat.RedBeatScheduler`
- ä½† `pyproject.toml` ä¸­**æ²¡æœ‰å®‰è£… redbeat åº“**
- å¯åŠ¨æ—¶ä¼šæŠ¥é”™ï¼š`ModuleNotFoundError: No module named 'redbeat'`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```toml
# pyproject.toml ä¸­æ·»åŠ 
celery-redbeat = "^2.2.0"
```

æˆ–è€…ï¼Œä¸ä½¿ç”¨ RedBeatï¼Œæ”¹ç”¨é»˜è®¤è°ƒåº¦å™¨ï¼ˆä½† Pod é‡å¯ä¼šä¸¢å¤±è°ƒåº¦çŠ¶æ€ï¼‰ï¼š
```yaml
# ç®€åŒ–ç‰ˆï¼ˆä½¿ç”¨é»˜è®¤è°ƒåº¦å™¨ï¼‰
command: ["celery", "-A", "app.tasks.celery_app", "beat", "-l", "info"]
```

---

### 3ï¸âƒ£ Kafka Consumer æœåŠ¡

#### ä»£ç æ£€æŸ¥ âœ…
**æ–‡ä»¶**: `app/services/item/kafka_consumer.py`

**ä¾èµ–ç»„ä»¶**ï¼š
- âœ… **Kafka**ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  - è¿æ¥ï¼š`111.228.39.41:9092`
  - Topics: `settings.kafka_item_ingest_topics` (é»˜è®¤: items-ingest, vlog-items, news-items)
  - Consumer Group: `lemo-recommender-group`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²

- âœ… **MongoDB**ï¼ˆç‰©å“æ•°æ®å­˜å‚¨ï¼‰
  - è¿æ¥ï¼š`mongodb://admin:password@111.228.39.41:27017`
  - Docker éƒ¨ç½²ï¼šâœ… å·²éƒ¨ç½²

**åŠŸèƒ½**ï¼š
1. æ¶ˆè´¹ Kafka ç‰©å“äº‹ä»¶
2. å†™å…¥ MongoDB
3. è§¦å‘ç‰©å“å‘é‡ç”Ÿæˆï¼ˆè°ƒç”¨ Celery ä»»åŠ¡ï¼‰

**é—®é¢˜**ï¼šâœ… æ— é—®é¢˜ï¼Œæ‰€æœ‰ä¾èµ–å·²éƒ¨ç½²

---

## ğŸš¨ ç¼ºå¤±çš„ä¾èµ–ç»„ä»¶

### âŒ ClickHouseï¼ˆå¯é€‰ï¼Œä½†å¼ºçƒˆæ¨èï¼‰

**ç”¨é€”**ï¼š
- è¡Œä¸ºæ•°æ® OLAP åˆ†æ
- æ¨èæŒ‡æ ‡ç»Ÿè®¡ï¼ˆCTRã€è½¬åŒ–ç‡ç­‰ï¼‰
- æ•°æ®åˆ†æé¡µé¢æ•°æ®æº

**å½“å‰çŠ¶æ€**ï¼š
- Docker Composeï¼šâŒ æœªéƒ¨ç½²
- ä»£ç ä¾èµ–ï¼šâš ï¸ å·²å¼•ç”¨ä½†é™çº§å¤„ç†

**å½±å“**ï¼š
- æ•°æ®åˆ†æé¡µé¢æ— æ³•æ˜¾ç¤ºçœŸå®æ•°æ®
- Flink Jobs æ— æ³•å°†è¡Œä¸ºæ•°æ®å†™å…¥ ClickHouse

**æ˜¯å¦å¿…é¡»**ï¼š
- çŸ­æœŸï¼šâŒ ä¸å¿…é¡»ï¼ˆå¯ç”¨ MongoDB æ›¿ä»£ï¼Œæ€§èƒ½è¾ƒå·®ï¼‰
- é•¿æœŸï¼šâœ… å¼ºçƒˆæ¨èï¼ˆè¡Œä¸ºæ•°æ®é‡å¤§æ—¶å¿…é¡»ï¼‰

**Docker éƒ¨ç½²å‘½ä»¤**ï¼š
```yaml
# æ·»åŠ åˆ° docker-compose.yml
clickhouse:
  image: clickhouse/clickhouse-server:24.1
  container_name: lemo-clickhouse
  ports:
    - "8123:8123"  # HTTP
    - "9000:9000"  # Native
  environment:
    CLICKHOUSE_USER: default
    CLICKHOUSE_PASSWORD: clickhouse_2024
  volumes:
    - clickhouse_data:/var/lib/clickhouse
  networks:
    - lemo-network
```

---

## ğŸ“‹ Python ä¾èµ–ä¿®å¤

### å¿…é¡»æ·»åŠ çš„ä¾èµ–

```toml
# pyproject.toml

[tool.poetry.dependencies]
# Celery Beat è°ƒåº¦å™¨ï¼ˆå¿…é¡»ï¼ï¼‰
celery-redbeat = "^2.2.0"
```

### å¯é€‰æ·»åŠ çš„ä¾èµ–

```toml
# ClickHouse å®¢æˆ·ç«¯ï¼ˆå¦‚æœéƒ¨ç½² ClickHouseï¼‰
clickhouse-driver = "^0.2.7"

# Flink ç›¸å…³ï¼ˆå¦‚æœä½¿ç”¨ Flinkï¼‰
apache-flink = "^1.18.0"  # å¯é€‰ï¼Œç‹¬ç«‹éƒ¨ç½²æ—¶ä¸éœ€è¦
```

---

## âœ… Docker Compose å®Œæ•´æ€§æ£€æŸ¥

### å·²éƒ¨ç½²çš„æœåŠ¡ âœ…

| æœåŠ¡ | é•œåƒ | ç«¯å£ | çŠ¶æ€ | Worker/Beat/Consumer ä¾èµ– |
|------|------|------|------|-------------------------|
| MongoDB | mongo:7.0 | 27017 | âœ… | âœ…âœ…âœ… Worker + Consumer |
| Redis | redis:7.2-alpine | 6379 | âœ… | âœ…âœ…âœ… Worker + Beat |
| Kafka | apache/kafka:3.8.1 | 9092 | âœ… | âœ…âœ…âœ… Worker + Consumer |
| Milvus | milvusdb/milvus:v2.4.1 | 19530 | âœ… | âœ… Workerï¼ˆå‘é‡ä»»åŠ¡ï¼‰|
| Etcd | quay.io/coreos/etcd:v3.5.5 | 2379 | âœ… | Milvus ä¾èµ– |
| MinIO | minio/minio | 9000 | âœ… | Milvus ä¾èµ– |
| Prometheus | prom/prometheus | 9090 | âœ… | ç›‘æ§ï¼ˆå¯é€‰ï¼‰|
| Grafana | grafana/grafana | 3000 | âœ… | ç›‘æ§ï¼ˆå¯é€‰ï¼‰|

### ç¼ºå¤±çš„æœåŠ¡ âŒ

| æœåŠ¡ | çŠ¶æ€ | å½±å“ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| ClickHouse | âŒ æœªéƒ¨ç½² | æ•°æ®åˆ†æä¸å¯ç”¨ | â­â­â­ é«˜ |

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼šä¿®å¤ Beat æœåŠ¡ï¼ˆå¿…é¡»ï¼‰â­â­â­â­â­

**é—®é¢˜**ï¼šBeat ä½¿ç”¨äº†æœªå®‰è£…çš„ `redbeat` åº“

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šå®‰è£… redbeat
```bash
# 1. æ›´æ–° pyproject.toml
poetry add celery-redbeat

# 2. é‡æ–°æ„å»ºé•œåƒ
docker build -t lemo-service-recommender:latest .

# 3. æ¨é€é•œåƒ
docker push registry.cn-beijing.aliyuncs.com/lemo_zls/lemo-service-recommender:latest
```

**æ–¹æ¡ˆ Bï¼ˆä¸´æ—¶ï¼‰**ï¼šä¸ä½¿ç”¨ RedBeatï¼Œæ”¹ç”¨é»˜è®¤è°ƒåº¦å™¨
```yaml
# k8s-deployment-beat.yaml
command: ["celery", "-A", "app.tasks.celery_app", "beat", "-l", "info"]
# ç§»é™¤ --scheduler redbeat.RedBeatScheduler
```

**æ³¨æ„**ï¼šæ–¹æ¡ˆ B ä¼šå¯¼è‡´ Pod é‡å¯åä¸¢å¤±è°ƒåº¦çŠ¶æ€ï¼ˆä»»åŠ¡å¯èƒ½é‡å¤æ‰§è¡Œï¼‰

---

### ä¼˜å…ˆçº§ 2ï¼šéƒ¨ç½² ClickHouseï¼ˆæ¨èï¼‰â­â­â­

**æ­¥éª¤**ï¼š

1. **æ›´æ–° docker-compose.yml**
```yaml
# æ·»åŠ  ClickHouse æœåŠ¡
clickhouse:
  image: clickhouse/clickhouse-server:24.1
  container_name: lemo-clickhouse
  ports:
    - "8123:8123"  # HTTP
    - "9000:9000"  # Native
  environment:
    CLICKHOUSE_USER: default
    CLICKHOUSE_PASSWORD: clickhouse_2024
  volumes:
    - clickhouse_data:/var/lib/clickhouse
  ulimits:
    nofile:
      soft: 262144
      hard: 262144
  networks:
    - lemo-network
  healthcheck:
    test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
    interval: 30s
    timeout: 10s
    retries: 3

# æ·»åŠ  volume
volumes:
  clickhouse_data:
```

2. **é‡æ–°éƒ¨ç½² Docker Compose**
```bash
# SSH åˆ°æœåŠ¡å™¨ 111.228.39.41
docker-compose up -d clickhouse
```

3. **æ·»åŠ  Python ä¾èµ–**
```bash
poetry add clickhouse-driver
```

4. **åˆ›å»º ClickHouse è¡¨**ï¼ˆå‚è€ƒ `docs/æ•°æ®åˆ†ææ¶æ„æ–¹æ¡ˆ.md`ï¼‰

---

### ä¼˜å…ˆçº§ 3ï¼šéªŒè¯æœåŠ¡è¿æ¥

**éªŒè¯è„šæœ¬**ï¼š
```python
# scripts/check_dependencies.py
import redis
from pymongo import MongoClient
from kafka import KafkaProducer

# æ£€æŸ¥ Redis
try:
    r = redis.Redis.from_url("redis://:redis_password_2024@111.228.39.41:6379/1")
    r.ping()
    print("âœ… Redis è¿æ¥æˆåŠŸ")
except Exception as e:
    print(f"âŒ Redis è¿æ¥å¤±è´¥: {e}")

# æ£€æŸ¥ MongoDB
try:
    client = MongoClient("mongodb://admin:password@111.228.39.41:27017")
    client.admin.command("ping")
    print("âœ… MongoDB è¿æ¥æˆåŠŸ")
except Exception as e:
    print(f"âŒ MongoDB è¿æ¥å¤±è´¥: {e}")

# æ£€æŸ¥ Kafka
try:
    producer = KafkaProducer(bootstrap_servers="111.228.39.41:9092")
    producer.close()
    print("âœ… Kafka è¿æ¥æˆåŠŸ")
except Exception as e:
    print(f"âŒ Kafka è¿æ¥å¤±è´¥: {e}")
```

---

## ğŸ“ æ€»ç»“

### Worker æœåŠ¡
- âœ… ä»£ç æ— é—®é¢˜
- âœ… æ‰€æœ‰ä¾èµ–å·²éƒ¨ç½²
- âœ… å¯ä»¥ç›´æ¥å¯åŠ¨

### Beat æœåŠ¡
- âœ… ä»£ç æ— é—®é¢˜
- âŒ **ç¼ºå°‘ redbeat åº“**ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
- âš ï¸ éœ€è¦é€‰æ‹©ï¼šå®‰è£… redbeat æˆ–ä½¿ç”¨é»˜è®¤è°ƒåº¦å™¨

### Consumer æœåŠ¡
- âœ… ä»£ç æ— é—®é¢˜
- âœ… æ‰€æœ‰ä¾èµ–å·²éƒ¨ç½²
- âœ… å¯ä»¥ç›´æ¥å¯åŠ¨

### å¯é€‰ç»„ä»¶
- âš ï¸ ClickHouse - å¼ºçƒˆæ¨èéƒ¨ç½²ï¼ˆæ•°æ®åˆ†æå¿…éœ€ï¼‰
- âš ï¸ Flink - å¯é€‰ï¼ˆå®æ—¶å¤„ç†ï¼Œå¯ç”¨ Celery å®šæ—¶èšåˆæ›¿ä»£ï¼‰

---

## ğŸš€ å¿«é€Ÿä¿®å¤è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆå¿…é¡»ï¼‰

```bash
# 1. æ·»åŠ  redbeat ä¾èµ–
cd /Users/edy/PycharmProjects/lemo_recommender
poetry add celery-redbeat

# 2. é‡æ–°æ„å»ºé•œåƒï¼ˆæœ¬åœ° Macï¼‰
docker buildx build --platform linux/amd64 -t registry.cn-beijing.aliyuncs.com/lemo_zls/lemo-service-recommender:$(date +%Y-%m-%d-%H-%M-%S) .

# 3. æ¨é€é•œåƒ
# (é€šè¿‡ deploy-all-services.sh è‡ªåŠ¨å¤„ç†)

# 4. éƒ¨ç½²æ‰€æœ‰æœåŠ¡
./k8s-deploy/deploy-all-services.sh
```

### åç»­æ‰§è¡Œï¼ˆæ¨èï¼‰

```bash
# SSH åˆ°æœåŠ¡å™¨ 111.228.39.41
ssh user@111.228.39.41

# åœ¨ docker-compose.yml ä¸­æ·»åŠ  ClickHouse
vim docker-compose.yml
# (æ·»åŠ ä¸Šé¢çš„ ClickHouse é…ç½®)

# éƒ¨ç½² ClickHouse
docker-compose up -d clickhouse

# éªŒè¯éƒ¨ç½²
docker ps | grep clickhouse
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [K8s éƒ¨ç½²æŒ‡å—](../k8s-deploy/README.md)
- [æ•°æ®åˆ†ææ¶æ„æ–¹æ¡ˆ](./æ•°æ®åˆ†ææ¶æ„æ–¹æ¡ˆ.md)
- [æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆ](./æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆ.md)

