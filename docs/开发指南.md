# Lemo推荐系统 - 开发指南

本文档包含项目开发计划、架构设计、技术规范和开发指南。

---

## 📋 目录

1. [项目概述](#项目概述)
2. [核心设计原则](#核心设计原则)
3. [系统架构](#系统架构)
4. [项目结构](#项目结构)
5. [开发阶段规划](#开发阶段规划)
6. [核心技术要点](#核心技术要点)
7. [开发规范](#开发规范)
8. [已完成功能模块](#已完成功能模块)
9. [常见问题和解决方案](#常见问题和解决方案)
10. [部署和测试](#部署和测试)

---

## 项目概述

**项目名称**: Lemo推荐系统  
**项目定位**: 多场景SaaS推荐系统，支持vlog、新闻、电商、音乐等多种业务场景  
**架构模式**: 前后端分离 + 微服务  

### 技术栈

**前端**:
- Vue3 + TypeScript
- Arco Design UI
- Axios + defHttp

**后端**:
- Go (Gin框架) - service_manager API网关
- Python (FastAPI + gRPC) - lemo_recommender推荐服务
- PyTorch - 深度学习模型
- Celery - 异步任务调度

**数据存储**:
- MongoDB - 主数据库（场景、物品、用户画像、实验）
- MySQL - 数据字典表
- Redis - 缓存层
- Milvus - 向量数据库
- ClickHouse - OLAP分析（Flink写入）

**消息队列**:
- Kafka - 行为数据流

**流处理**:
- Flink (PyFlink) - 实时特征计算

**部署**:
- Docker + Docker Compose
- Kubernetes (K3s)

**监控**:
- Prometheus + Grafana
- ELK Stack (可选)

---

## 核心设计原则

1. **多租户隔离**: 所有数据按`tenant_id`完全隔离，确保SaaS安全性
2. **场景抽象**: 通过配置化支持不同业务场景，避免硬编码
3. **算法插件化**: 算法模块可插拔、可组合，支持热更新
4. **可观测性**: 完善的监控、日志、链路追踪体系
5. **高性能**: 支持高并发、低延迟响应（P99 < 100ms）
6. **API网关模式**: 前端只与service_manager通信，不直接调用lemo_recommender
7. **自动ID生成**: 所有资源ID由后端自动生成（MongoDB ObjectID）

---

## 系统架构

### 整体架构

```
前端(Vue3) → service_manager(Go网关) → lemo_recommender(Python gRPC服务)
                    ↓                              ↓
              andrew-file(文件服务)         MongoDB + Redis
                                                  ↓
                                            Kafka + Flink
                                                  ↓
                                            ClickHouse (OLAP)
```

### 数据流架构

```
用户行为 → Kafka → Flink实时计算 → Redis/MongoDB/ClickHouse
                      ↓
                  实时特征更新
                      ↓
                 推荐引擎使用
```

### 推荐链路

```
请求 → 场景路由 → 多路召回 → 粗排 → 精排 → 重排 → 结果返回
         ↓          ↓        ↓     ↓     ↓
      配置加载   热门/协同/  规则  模型  多样性
                 向量召回    打分  打分  过滤
```

---

## 项目结构

### Go服务 (service_manager)

```
service_manager_server/
├── app/admin/recommender/  # 推荐系统HTTP控制器
│   ├── model.go           # 模型管理
│   ├── template.go        # 模板管理
│   ├── scenario.go        # 场景管理
│   ├── item.go            # 物品管理
│   ├── experiment.go      # AB实验管理
│   └── dataset.go         # 数据集管理
├── rpc/                   # gRPC客户端
│   └── recommender_clients.go
└── route/
    └── router.go          # 路由配置
```

### Python服务 (lemo_recommender)

```
lemo_recommender/
├── app/
│   ├── api/               # FastAPI路由（V1版本）
│   │   └── v1/
│   │       ├── behavior.py
│   │       ├── item.py
│   │       ├── recommendation.py
│   │       ├── scenario.py
│   │       ├── experiment.py
│   │       └── model_training.py
│   ├── models/            # Pydantic数据模型
│   │   ├── base.py
│   │   ├── behavior.py
│   │   ├── item.py
│   │   ├── scenario.py
│   │   ├── experiment.py
│   │   └── user_profile.py
│   ├── services/          # 业务逻辑层
│   │   ├── behavior/
│   │   ├── item/
│   │   ├── recommendation/
│   │   ├── scenario/
│   │   ├── experiment/
│   │   ├── analytics/
│   │   ├── dataset/
│   │   └── model/
│   ├── engine/            # 推荐引擎
│   │   ├── recall/        # 召回层
│   │   │   ├── hot_items.py
│   │   │   ├── collaborative_filtering.py
│   │   │   └── vector_search.py
│   │   ├── ranker/        # 排序层
│   │   │   ├── base.py
│   │   │   └── simple_ranker.py
│   │   └── reranker/      # 重排层
│   │       ├── base.py
│   │       └── diversity.py
│   ├── ml/                # 深度学习模型
│   │   ├── models/
│   │   │   ├── base.py
│   │   │   ├── wide_deep.py
│   │   │   ├── deepfm.py
│   │   │   └── two_tower.py
│   │   ├── trainer.py     # 模型训练器
│   │   ├── model_server.py # 模型服务
│   │   └── model_registry.py # 模型注册表
│   ├── grpc_server/       # gRPC服务层
│   │   └── services/
│   │       ├── behavior_service.py
│   │       ├── item_service.py
│   │       ├── scenario_service.py
│   │       ├── experiment_service.py
│   │       └── model_service.py
│   ├── tasks/             # Celery异步任务
│   │   ├── celery_app.py
│   │   ├── item_tasks.py
│   │   ├── user_tasks.py
│   │   ├── model_tasks.py
│   │   └── recommendation_tasks.py
│   ├── core/              # 核心组件
│   │   ├── config.py      # 配置管理
│   │   ├── database.py    # MongoDB客户端
│   │   ├── kafka.py       # Kafka生产者/消费者
│   │   ├── milvus_client.py # Milvus客户端
│   │   └── metrics.py     # Prometheus指标
│   └── utils/             # 工具类
│       ├── circuit_breaker_decorator.py
│       ├── rate_limiter.py
│       └── performance.py
├── flink_jobs/            # Flink实时作业
│   ├── user_profile_updater.py
│   ├── item_hot_score_calculator.py
│   └── recommendation_metrics.py
└── scripts/               # 脚本
    ├── init_db.py
    ├── init_milvus.py
    └── run_grpc_server.py
```

### 前端 (service_manager_web/admin)

```
src/views/recommender/
├── model/                 # 模型管理
│   ├── index.vue
│   ├── Create.vue
│   └── components/
├── template/              # 模板管理
├── scenario/              # 场景管理
├── item/                  # 物品管理
└── experiment/            # AB实验管理
```

---

## 开发阶段规划

### 第一阶段：基础架构与核心功能 (4-6周) ✅

#### Week 1-2: 项目初始化与基础框架 ✅

**1. 项目结构搭建** ✅
- [x] 创建标准项目结构（分层架构）
- [x] 配置Poetry依赖管理
- [x] 设置Docker开发环境
- [x] 配置代码质量工具（Black、Flake8、MyPy）
- [x] 配置Pytest测试框架

**2. 数据模型设计（MongoDB）** ✅
- [x] 设计MongoDB Collection结构
  - 场景配置集合（scenarios）
  - 物品集合（items）
  - 用户画像集合（user_profiles）
  - 行为日志集合（interactions）
  - 模型配置集合（model_configs）
  - AB实验集合（experiments）
- [x] 创建索引策略（tenant_id, scenario_id等）
- [x] 设计统一的场景配置Schema（支持vlog、新闻等场景）

**3. 基础服务搭建** ✅
- [x] FastAPI应用初始化
- [x] MongoDB集成（Motor异步驱动）
- [x] Redis集成（连接池、缓存工具类）
- [x] 统一响应格式定义
- [x] 异常处理中间件
- [x] 请求上下文管理（tenant_id、user_id、request_id）

#### Week 3-4: 服务对接与场景管理 ✅

**1. 外部服务对接** ✅
- [x] 定义与网关服务的接口协议（请求头规范）
- [x] 实现租户/用户服务的gRPC客户端框架
- [x] 租户信息缓存机制（预留）
- [x] 请求验证中间件（验证tenant_id和user_id）

**2. 场景管理（配置化，无需硬编码）** ✅
- [x] 场景CRUD API
- [x] 场景配置Schema定义（通用JSON Schema）
  - 特征配置：item_features, user_features, context_features
  - 召回策略配置：多路召回权重和参数
  - 排序模型配置：模型类型和版本
  - 重排规则配置：多样性、新鲜度等
- [x] 场景配置模板
  - vlog场景模板（视频时长、完播率等特征）
  - 新闻场景模板（时效性、地域性等特征）
- [x] 场景配置验证器
- [x] 场景动态路由（根据scenario_id加载配置）

**3. 物品管理与行为采集** ✅
- [x] 物品管理API（CRUD、批量导入、搜索）
- [x] 物品元数据存储（支持异构字段）
- [x] 用户画像表设计与实现
- [x] 用户行为上报API（单个+批量）

#### Week 5-6: 基础推荐引擎 ✅

**1. 推荐算法实现** ✅
- [x] 协同过滤（UserCF、ItemCF）
- [x] 热门推荐（预留Flink实时计算集成点）
- [x] 向量召回（预留Milvus集成点）
- [x] 混合推荐策略（多路召回合并）

**2. 推荐服务API** ✅
- [x] 统一推荐接口设计
- [x] 场景路由与算法选择（配置驱动）
- [x] 结果过滤与去重
- [x] 推荐调试信息（debug模式）

**3. 缓存策略** 🚧
- [x] 推荐结果缓存（接口预留）
- [x] 用户画像缓存（接口预留）
- [x] 热门物品缓存（接口预留）
- [ ] 缓存失效策略（待实现）

**4. 性能优化** ✅
- [x] 数据库索引优化（init_db.py）
- [x] 批量查询优化（get_items_by_ids）
- [x] 异步任务处理（Celery框架搭建）

### 第二阶段：高级特性与扩展 (4-6周) ✅

#### Week 7-8: 特征工程与向量化 ✅

**1. 特征提取框架** 🚧
- [ ] 通用特征提取接口（待深度学习模型）
- [ ] vlog场景特征提取（待深度学习模型）
  - 视频时长、分类、标签
  - 作者特征
  - 观看完成率、点赞率
- [ ] 新闻场景特征提取（待深度学习模型）
  - 文本TF-IDF、Word2Vec
  - 新闻分类、发布时间
  - 点击率、评论数

**2. 向量化与检索** ✅
- [x] 集成Milvus向量数据库（客户端封装）
- [x] 物品向量生成（Embedding接口）
- [x] 用户向量生成（历史行为聚合）
- [x] ANN相似度检索（向量召回策略）
- [x] I2I向量召回（基于物品的向量召回）

**3. 实时特征计算（Kafka + Flink）** ✅
- [x] Kafka集成与Topic设计
  - user-behaviors-{tenant_id} Topic
  - user-profile-updates Topic
  - item-stats-updates Topic
  - recommendation-metrics Topic
- [x] Flink环境搭建（PyFlink作业框架）
- [x] Flink Job 1: 用户画像实时更新
  - 5分钟滚动窗口聚合
  - 计算用户偏好、活跃时段
  - 写入MongoDB和Redis
  - 发送到user-profile-updates Topic
- [x] Flink Job 2: 物品热度实时计算
  - 1小时滑动窗口（步长15分钟）
  - 时间衰减热度算法
  - 写入Redis ZSET
  - 发送到item-stats-updates Topic
- [x] Flink Job 3: 实时指标统计
  - CTR、平均观看时长、完播率、互动率
  - 1分钟滚动窗口
  - 推送到Prometheus Pushgateway
  - 发送到recommendation-metrics Topic

#### Week 9-10: 深度学习模型 ✅

**1. 模型框架** ✅
- [x] PyTorch集成（BaseRecommenderModel基类）
- [x] 模型训练pipeline（ModelTrainer）
- [x] 模型版本管理（ModelRegistry）

**2. 推荐模型实现** ✅
- [x] Wide & Deep模型（记忆+泛化）
- [x] DeepFM模型（FM+DNN特征交互）
- [x] 双塔召回模型（User塔+Item塔）
- [ ] 序列推荐模型（GRU4Rec，待后续扩展）

**3. 模型服务化** ✅
- [x] 模型加载与预测（ModelServer）
- [x] 批量预测接口
- [x] 模型热更新（无缝切换版本）
- [x] GPU/CPU自动选择
- [x] 多模型并行管理

#### Week 11-12: 离线任务与调度 ✅

**1. 离线计算任务** ✅
- [x] 批量物品相似度计算（Item-Based CF）
- [x] 用户画像离线更新（行为聚合、偏好计算）
- [x] 模型离线训练任务（每日自动训练）
- [x] 推荐结果预计算（高活跃用户Top N）
- [x] 热门物品缓存更新
- [x] 推荐效果指标计算

**2. 任务调度** ✅
- [x] Celery任务定义（4个任务模块）
- [x] 定时任务配置（Celery Beat）
  - 每小时: 计算物品相似度
  - 每2小时: 更新用户画像
  - 每4小时: 预计算推荐结果
  - 每天凌晨3点: 模型训练
  - 每天凌晨4点: 清理过期缓存
- [x] 任务监控与重试（Celery配置）
- [x] 任务执行日志（内置日志系统）

### 第三阶段：平台化与运营支持 (4-6周) ✅

#### Week 13-14: AB测试平台 ✅

**1. 实验管理** ✅
- [x] 实验配置数据模型（Experiment, ExperimentVariant）
- [x] 实验创建与管理API（CRUD + 启动/停止）
- [x] 流量分配算法
  - User ID Hash（一致性哈希）
  - Random（随机分配）
  - Weighted（加权分配）
- [x] 实验生效逻辑（分配记录、变体配置）

**2. 效果评估** ✅
- [x] 指标定义（主要指标、次要指标、护栏指标）
- [x] 实验结果计算（ExperimentResult）
- [x] 统计显著性检验
  - T检验（连续指标）
  - 比例Z检验（CTR、转化率）
  - 序贯检验（Sequential Testing）
- [x] 效果分析工具
  - 置信区间计算
  - 样本量计算器
  - 多臂老虎机（Thompson Sampling）

#### Week 15-16: 监控与告警 ✅

**1. 监控体系** ✅
- [x] Prometheus集成（prometheus_client）
- [x] 自定义业务指标埋点（app/core/metrics.py）
  - 推荐请求量（Counter）
  - 推荐响应时间（Histogram）
  - 推荐覆盖率（Gauge）
  - 推荐多样性（Gauge）
  - CTR、缓存命中率
- [x] Grafana Dashboard配置（config/prometheus.yml）

**2. 日志与追踪** 🚧
- [x] 结构化日志配置（Python logging）
- [ ] ELK Stack集成（可选，生产环境）
- [ ] Jaeger链路追踪集成（可选）
- [x] 慢查询日志分析（内置）

**3. 告警系统** 🚧
- [x] 告警规则配置（Prometheus Alertmanager）
- [ ] 告警通知（邮件、钉钉、企业微信）
- [ ] 告警收敛与升级（待扩展）

#### Week 17-18: 管理后台与数据分析 ✅

**1. 管理后台API** ✅
- [x] 仪表板概览API（核心指标）
- [x] 指标趋势API（按天聚合）
- [x] 物品分布统计API
- [x] 用户行为分析API
- [x] 数据导出API（interactions/items/user_profiles）
- [x] 系统健康检查API
- [x] 实验汇总API

**2. 数据可视化支持** ✅
- [x] 推荐效果监控数据接口
- [x] 用户行为分析数据接口
- [x] 物品分布统计数据接口
- [x] 实时指标查询接口
- [x] 前端Dashboard（Vue3 + Arco Design）
  - 仪表板（核心指标+趋势图）
  - 场景管理（CRUD）
  - 物品管理（CRUD + 批量导入）
  - AB实验管理（创建、启动/停止、结果查看）
  - 数据分析（饼图、柱状图）

### 第四阶段：优化与上线 (2-4周) ✅

#### Week 19-20: 性能优化与高可用 ✅

**1. 性能优化** ✅
- [x] 缓存管理器（CacheManager）
  - 缓存装饰器
  - 缓存统计
  - 缓存预热
- [x] 查询优化器（QueryOptimizer）
  - 索引优化建议
  - 聚合管道优化
- [x] 性能监控工具
  - 执行时间跟踪
  - 慢查询记录
- [x] 批处理器（BatchProcessor）
- [x] 懒加载（LazyLoader）
- [x] 并行执行工具（async_parallel）

**2. 高可用保障** ✅
- [x] 限流器（RateLimiter）
  - 滑动窗口算法
  - 配额管理
- [x] 熔断器（CircuitBreaker）
  - 故障检测
  - 自动恢复
  - 降级策略
- [x] 熔断器装饰器（with_circuit_breaker）
- [x] Cache-Aside模式
- [x] 连接池管理

**3. 压力测试** 📝（待生产环境）
- [ ] 单接口压测脚本
- [ ] 全链路压测
- [ ] 性能基准建立
- [ ] 容量规划文档

#### Week 21-22: 文档与部署 📝（待生产部署时完善）

**1. 文档完善**
- [x] API文档（FastAPI自动生成）
- [x] 架构设计文档（docs/系统设计.md）
- [x] 开发指南文档（docs/开发指南.md）
- [x] 埋点接入指南（docs/埋点接入完整指南.md）
- [x] 数据接入指南（docs/数据接入指南.md）
- [x] README文档
- [ ] 用户使用手册（待补充）

**2. 部署准备**
- [x] Docker配置（docker-compose.yml）
- [x] Kubernetes配置（k8s/）
- [x] 环境配置管理（config/）
- [ ] CI/CD Pipeline（待生产环境）

**3. 上线检查清单**（待生产部署）
- [ ] 安全审计
- [ ] 性能验收
- [ ] 数据备份方案
- [ ] 回滚方案
- [ ] 应急预案

---

## 核心技术要点

### 1. Protobuf数据转换

#### Timestamp转换

```python
# Python: datetime → protobuf Timestamp
from google.protobuf import timestamp_pb2
ts = timestamp_pb2.Timestamp()
ts.FromDatetime(datetime_obj)

# 前端: protobuf → 显示格式
const formatTimestamp = (timestamp: any): string => {
  if (timestamp.seconds !== undefined) {
    const date = new Date(timestamp.seconds * 1000);
    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
  }
  return '-';
};
```

#### Enum映射

```python
# Python enum → protobuf enum
status_map = {
    "draft": 1,
    "deployed": 2,
    "archived": 3,
}

# 前端: string value
const statusOptions = [
  { label: '草稿', value: 'draft' },
  { label: '已部署', value: 'deployed' },
];
```

#### Struct转换

```python
# Python dict → protobuf Struct
from google.protobuf import struct_pb2
config_struct = struct_pb2.Struct()
config_struct.update(config_dict)

# protobuf Struct → Python dict
from google.protobuf.json_format import MessageToDict
config_dict = MessageToDict(struct_proto)
```

### 2. Go POST请求参数读取

```go
// ✅ 正确：从POST body读取
body, _ := io.ReadAll(c.Request.Body)
var parameter map[string]interface{}
_ = json.Unmarshal(body, &parameter)

tenantID := ""
if tid, ok := parameter["tenant_id"].(string); ok {
    tenantID = tid
}

// ❌ 错误：用c.Query读取POST参数
tenantID := c.Query("tenant_id")  // 读不到POST body的数据
```

### 3. 前端API调用

```typescript
// defHttp已处理response.data，直接返回数据
const data = await list(params);  // ✅ 正确
const { data } = await list(params);  // ❌ 错误（双重解构）

// 设置row-key
<a-table row-key="model_id" ... />  // ✅ 使用实际字段
<a-table row-key="id" ... />  // ❌ 字段可能不存在

// 分页配置
const basePagination = reactive({ current: 1, pageSize: 20, total: 0 });
```

### 4. MongoDB ObjectID生成

```go
// Go
import "go.mongodb.org/mongo-driver/bson/primitive"
modelID := primitive.NewObjectID().Hex()

// Python
from bson import ObjectId
model_id = str(ObjectId())
```

---

## 开发规范

### 1. ID生成规则

- **所有资源ID由后端自动生成**
- 使用MongoDB ObjectID (24位hex字符串)
- 前端表单不需要输入ID字段

### 2. 租户参数处理

```python
# Python服务支持空租户
filter_query = {}
if tenant_id:  # 有值才加入查询条件
    filter_query["tenant_id"] = tenant_id
```

### 3. 错误处理

```typescript
// 前端空数据处理
try {
  const data = await list(params);
  items.value = data?.items || [];
} catch (error) {
  console.error('查询失败:', error);  // ✅ 只记录日志
  // ❌ 不要: Message.error('查询失败');
}
```

### 4. 时间格式统一

- 数据库: UTC datetime
- Protobuf: Timestamp (seconds + nanos)
- 前端显示: YYYY/MM/DD HH:mm:ss

### 5. 状态映射

```python
# Python Pydantic Enum
class ModelStatus(str, Enum):
    DRAFT = "draft"
    DEPLOYED = "deployed"
    ARCHIVED = "archived"

# Protobuf Enum (从1开始)
enum ModelStatus {
  MODEL_STATUS_UNSPECIFIED = 0;
  MODEL_STATUS_DRAFT = 1;
  MODEL_STATUS_DEPLOYED = 2;
  MODEL_STATUS_ARCHIVED = 3;
}

# 前端显示
const STATUS_MAP = {
  draft: '草稿',
  deployed: '已部署',
  archived: '已归档',
};
```

---

## 已完成功能模块

### 1. 模型管理 ✅

- ✅ 列表查询（支持租户/类型/状态筛选）
- ✅ 创建模型（自动生成model_id）
- ✅ 编辑模型
- ✅ 删除模型
- ✅ 特征配置（分类结构：user/item/context/interaction）
- ✅ 算法参数配置（根据模型类型动态显示）
- ✅ 训练数据路径配置

**特点**:
- 模型类型: recall/rank/rerank
- 特征分类管理（从字典表动态加载）
- 算法参数带默认值和注释
- 状态颜色标签显示

### 2. 模板管理 ✅

- ✅ 列表查询
- ✅ 创建模板
- ✅ 可视化配置编辑器
- ✅ 模型选择（按类型筛选）
- ✅ 场景类型（从字典表动态加载）

**特点**:
- 不关联租户（跨租户可复用）
- 场景类型配置化
- 可视化配置（Recall/Rank/Rerank）

### 3. 场景管理 ✅

- ✅ 列表查询（支持租户/类型/状态筛选）
- ✅ 创建场景（自动生成scenario_id）
- ✅ 编辑场景
- ✅ 可视化配置编辑器
- ✅ 状态切换

**特点**:
- 与租户绑定
- 基于模板创建
- 支持独立配置

### 4. 物品管理 ✅

- ✅ 列表查询（支持租户/场景/状态筛选）
- ✅ 创建物品（自动生成item_id）
- ✅ 编辑物品
- ✅ 删除物品（软删除）
- ✅ 批量导入

**特点**:
- 按场景组织
- 支持元数据(metadata)
- 支持向量(embedding)

### 5. AB实验管理 ✅

- ✅ 列表查询（支持租户/状态筛选）
- ✅ 创建实验（自动生成experiment_id）
- ✅ 启动/停止实验
- ✅ 删除实验（软删除→archived）
- ✅ 流量分配配置

**特点**:
- 对照组/实验组配置
- 流量分配验证（总和100%）
- 状态流转管理

### 6. 数据埋点服务 ✅

- ✅ 场景埋点配置管理
- ✅ HTTP/gRPC/Kafka三种接入方式
- ✅ 场景数据验证
- ✅ 实时数据采集

---

## 常见问题和解决方案

### 1. 前端列表不显示数据

**原因**: 双重解构或row-key错误  
**解决**:
```typescript
// ✅ 正确
const data = await list(params);
items.value = data?.items || [];

// ✅ 正确row-key
<a-table row-key="model_id" ... />
```

### 2. Go接口读不到POST参数

**原因**: 使用c.Query读取POST body参数  
**解决**:
```go
// ✅ 正确：从body读取
body, _ := io.ReadAll(c.Request.Body)
var parameter map[string]interface{}
_ = json.Unmarshal(body, &parameter)
```

### 3. Python Pydantic验证失败

**原因**: 字典结构与模型不匹配  
**解决**:
```python
# ✅ 使用model_validate
item = Item.model_validate(doc)

# ✅ 使用model_dump转换
result.model_dump()
```

### 4. 时间显示为protobuf格式

**原因**: 未格式化timestamp  
**解决**:
```typescript
// 添加formatTimestamp函数
const formatTimestamp = (timestamp: any): string => {
  if (timestamp.seconds !== undefined) {
    const date = new Date(timestamp.seconds * 1000);
    // 格式化...
  }
  return '-';
};
```

### 5. Enum值不匹配

**原因**: 前端发送字符串，后端期望数字  
**解决**:
```typescript
// ✅ 前端发送字符串
params.model_type = 'recall'  // 不是 1

// Go后端转换
model_type_map := map[string]int{
    "recall": 1,
    "rank": 2,
}
```

---

## 部署和测试

### Python服务重启

```bash
docker restart lemo_recommender
```

### 前端构建

```bash
cd /Users/edy/Lemo/service_manage/service_manager_web/admin
yarn build
```

### 测试清单

- [ ] 模型管理：列表/创建/编辑/删除
- [ ] 模板管理：列表/创建/编辑
- [ ] 场景管理：列表/创建/编辑/状态切换
- [ ] 物品管理：列表/创建/批量导入
- [ ] AB实验：列表/创建/启动/停止

---

## 关键里程碑

| 里程碑 | 时间节点 | 交付物 | 状态 |
|--------|----------|--------|------|
| M1: MVP版本 | Week 6 | 基础推荐系统，支持2个场景，与网关/用户服务对接 | ✅ 已完成 |
| M2: 特性增强版 | Week 12 | 向量检索、深度学习模型、实时流处理 | ✅ 已完成 |
| M3: 平台化版本 | Week 18 | AB测试、监控告警、管理后台 | ✅ 已完成 |
| M4: 生产就绪版 | Week 22 | 性能优化、高可用、完整文档 | 🚧 进行中 |

---

## 数据字典

### 特征字典表

- **表结构**: `common_dictionary_table` (定义表) + `common_dictionary_data` (数据表) 或 动态表
- **特征分类**: 
  - `rec_feature_user` (用户特征)
  - `rec_feature_item` (物品特征)
  - `rec_feature_context` (上下文特征)
  - `rec_feature_interaction` (交互特征)

### 场景类型字典

- **表**: `rec_scenario_type`
- **示例**: vlog, news, ecommerce

---

## 权限和中间件

### 租户ID获取

```go
// Go中间件自动注入
userInfo, _ := middleware.GetUserInfo(c)
tenantID := userInfo.BusinessID
```

### API验证

- `ValidityAPi` 中间件验证请求头
- `verify-encrypt`, `verify-time` headers

---

## 参考资料

### Proto文件位置

- `andrew-protos/proto/recommender/v1/`

### 生成命令

```bash
cd andrew-protos
make generate
```

### 依赖更新

```bash
cd service_manager_server
go mod vendor  # 更新vendor
```

---

## 风险与挑战

### 技术风险

1. **多场景抽象复杂度**: 不同场景差异大，需设计良好的抽象层
2. **实时性能要求**: 推荐延迟需控制在100ms内
3. **冷启动问题**: 新用户、新物品推荐效果差

### 解决方案

1. 采用策略模式+配置化，降低场景耦合
2. 多级缓存+预计算+ANN检索
3. 热门推荐兜底+主动探索策略

---

## 后续迭代方向

1. **更多算法支持**: 知识图谱、强化学习
2. **跨场景迁移学习**: 利用多场景数据提升效果
3. **AutoML**: 自动调参与模型选择
4. **实时个性化**: 用户行为实时生效
5. **多目标优化**: 平衡点击率、时长、收益等多目标
6. **联邦学习**: 支持用户隐私保护的推荐

---

**文档版本**: v1.0  
**最后更新**: 2025-10-30  
**维护者**: 开发团队

