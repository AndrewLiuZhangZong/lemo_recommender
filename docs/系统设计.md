# å¤šåœºæ™¯SaaSæ¨èç³»ç»Ÿ - ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ç›®å½•
- [1. æŠ€æœ¯æ ˆ](#1-æŠ€æœ¯æ ˆ)
- [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
- [3. æ•°æ®æ¨¡å‹](#3-æ•°æ®æ¨¡å‹)
- [4. åœºæ™¯é…ç½®](#4-åœºæ™¯é…ç½®)
- [5. æœåŠ¡å¯¹æ¥](#5-æœåŠ¡å¯¹æ¥)

---

# 1. æŠ€æœ¯æ ˆ

## 1.1 åç«¯æ ¸å¿ƒæ¡†æ¶

### Webæ¡†æ¶
- **FastAPI**
  - é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶
  - è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ (OpenAPI/Swagger)
  - ç±»å‹æç¤ºæ”¯æŒï¼Œä¾¿äºç»´æŠ¤
  - æ”¯æŒä¾èµ–æ³¨å…¥

### æ¨èç®—æ³•åº“
- **scikit-learn**: ç»å…¸æœºå™¨å­¦ä¹ ç®—æ³•
- **LightGBM/XGBoost**: æ¢¯åº¦æå‡æ¨¡å‹
- **TensorFlow/PyTorch**: æ·±åº¦å­¦ä¹ æ¨¡å‹
- **Surprise**: ååŒè¿‡æ»¤ç®—æ³•åº“
- **Implicit**: éšå¼åé¦ˆæ¨èç®—æ³•
- **Faiss**: Facebookçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢åº“ï¼ˆé«˜æ€§èƒ½ï¼‰

### ç‰¹å¾å·¥ç¨‹
- **Pandas**: æ•°æ®å¤„ç†
- **NumPy**: æ•°å€¼è®¡ç®—
- **scipy**: ç§‘å­¦è®¡ç®—

## 1.2 æ•°æ®å­˜å‚¨

### æ–‡æ¡£æ•°æ®åº“
- **MongoDB**
  - å­˜å‚¨æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼ˆåœºæ™¯é…ç½®ã€ç‰©å“ã€ç”¨æˆ·ç”»åƒã€è¡Œä¸ºæ—¥å¿—ï¼‰
  - çµæ´»Schemaï¼Œé€‚åˆå¤šåœºæ™¯çš„å¼‚æ„æ•°æ®
  - æ”¯æŒæ°´å¹³æ‰©å±•ï¼ˆåˆ†ç‰‡ï¼‰
  - 4.0+ç‰ˆæœ¬æ”¯æŒACIDäº‹åŠ¡

**ä¸ºä»€ä¹ˆé€‰MongoDBè€Œä¸æ˜¯PostgreSQLï¼Ÿ**
1. ç§Ÿæˆ·/ç”¨æˆ·æ•°æ®ç”±å¤–éƒ¨æœåŠ¡ç®¡ç†ï¼Œæ— éœ€å…³ç³»å‹çº¦æŸ
2. åœºæ™¯é…ç½®ã€ç‰©å“å…ƒæ•°æ®Schemaçµæ´»å¤šå˜ï¼Œé€‚åˆæ–‡æ¡£å­˜å‚¨
3. ç®€åŒ–æ¶æ„ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

### ç¼“å­˜å±‚
- **Redis**
  - çƒ­æ•°æ®ç¼“å­˜ï¼ˆç”¨æˆ·ç”»åƒã€çƒ­é—¨ç‰©å“ï¼‰
  - å®æ—¶æ¨èç»“æœç¼“å­˜
  - åˆ†å¸ƒå¼é”
  - è®¡æ•°å™¨ï¼ˆæ›å…‰ã€ç‚¹å‡»ç­‰ï¼‰

### å‘é‡æ•°æ®åº“
- **Milvus** æˆ– **Weaviate**
  - å­˜å‚¨ç‰©å“å’Œç”¨æˆ·çš„å‘é‡è¡¨ç¤º
  - é«˜æ•ˆç›¸ä¼¼åº¦æ£€ç´¢

## 1.3 æ¶ˆæ¯é˜Ÿåˆ—ä¸æµå¤„ç†

### æ¶ˆæ¯é˜Ÿåˆ—
- **Apache Kafka**
  - å¤„ç†å®æ—¶è¡Œä¸ºæ•°æ®æµ
  - é«˜ååé‡ã€ä½å»¶è¿Ÿ
  - è§£è€¦æœåŠ¡æ¨¡å—
  - æŒä¹…åŒ–æ¶ˆæ¯å­˜å‚¨

### æµå¤„ç†
- **Apache Flink**
  - å®æ—¶ç‰¹å¾è®¡ç®—
  - å®æ—¶æ•°æ®èšåˆ
  - å¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰
  - æ”¯æŒç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼ˆExactly-Onceï¼‰

## 1.4 ä»»åŠ¡è°ƒåº¦

- **Celery** + **Redis**
  - æ¨¡å‹è®­ç»ƒä»»åŠ¡
  - æ‰¹é‡æ¨èé¢„è®¡ç®—
  - å®šæ—¶æ•°æ®åŒæ­¥
  - å¼‚æ­¥ä»»åŠ¡å¤„ç†

## 1.5 ç›‘æ§ä¸è¿ç»´

### ç›‘æ§
- **Prometheus** + **Grafana**
  - ç³»ç»Ÿæ€§èƒ½ç›‘æ§
  - ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
  - æ¨èæ•ˆæœç›‘æ§

### æ—¥å¿—
- **ELK Stack**ï¼ˆå¯é€‰ï¼‰
  - æ—¥å¿—æ”¶é›†ä¸åˆ†æ

### é“¾è·¯è¿½è¸ª
- **Jaeger** æˆ– **Zipkin**
  - åˆ†å¸ƒå¼è¿½è¸ª
  - æ€§èƒ½åˆ†æ

## 1.6 å®¹å™¨åŒ–

- **Docker**: æœåŠ¡å®¹å™¨åŒ–
- **Docker Compose**: æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **Kubernetes**: ç”Ÿäº§ç¯å¢ƒç¼–æ’ï¼ˆå¯é€‰ï¼‰

## 1.7 æŠ€æœ¯æ ˆåˆ†é˜¶æ®µå®æ–½

### ç¬¬ä¸€é˜¶æ®µï¼ˆMVPï¼‰
- FastAPI + MongoDB + Redis + Celery
- Docker + Docker Compose
- åŸºç¡€æ¨èç®—æ³•ï¼ˆååŒè¿‡æ»¤ã€å†…å®¹æ¨èï¼‰
- ä¸ç½‘å…³/ç§Ÿæˆ·æœåŠ¡å¯¹æ¥

### ç¬¬äºŒé˜¶æ®µï¼ˆæ‰©å±•ï¼‰
- Milvusï¼ˆå‘é‡æ£€ç´¢ï¼‰
- Kafka + Flinkï¼ˆå®æ—¶æ•°æ®æµå¤„ç†ï¼‰
- æ·±åº¦å­¦ä¹ æ¨¡å‹
- gRPCæœåŠ¡é—´é€šä¿¡

### ç¬¬ä¸‰é˜¶æ®µï¼ˆå®Œå–„ï¼‰
- Kubernetes
- å®Œæ•´ç›‘æ§ä½“ç³»
- ABæµ‹è¯•å¹³å°
- ç®¡ç†åå°

---

# 2. ç³»ç»Ÿæ¶æ„

## 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡ï¼ˆå·²æœ‰ï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  APIç½‘å…³æœåŠ¡      â”‚  â”‚  ç§Ÿæˆ·/ç”¨æˆ·æœåŠ¡    â”‚                â”‚
â”‚  â”‚  (Golang+Kratos) â”‚  â”‚  (Golang+Kratos) â”‚                â”‚
â”‚  â”‚  â€¢ é‰´æƒ           â”‚  â”‚  â€¢ ç§Ÿæˆ·ç®¡ç†       â”‚                â”‚
â”‚  â”‚  â€¢ é™æµ           â”‚  â”‚  â€¢ ç”¨æˆ·ç®¡ç†       â”‚                â”‚
â”‚  â”‚  â€¢ è·¯ç”±           â”‚  â”‚  â€¢ æƒé™æ§åˆ¶       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨èç³»ç»Ÿï¼ˆæœ¬é¡¹ç›®ï¼‰                         â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  åº”ç”¨æœåŠ¡å±‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  åœºæ™¯ç®¡ç†æœåŠ¡  â”‚  â”‚  ç‰©å“ç®¡ç†æœåŠ¡  â”‚  â”‚  è¡Œä¸ºé‡‡é›†æœåŠ¡  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  æ¨èæœåŠ¡     â”‚  â”‚  ç‰¹å¾æœåŠ¡     â”‚  â”‚  æ¨¡å‹æœåŠ¡     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚  â”‚
â”‚  â”‚  â”‚  å®éªŒæœåŠ¡     â”‚                                      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  æ¨èå¼•æ“å±‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚  å¬å›å±‚     â”‚  â”‚  æ’åºå±‚     â”‚  â”‚  é‡æ’å±‚     â”‚      â”‚  â”‚
â”‚  â”‚  â”‚            â”‚  â”‚            â”‚  â”‚            â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ ååŒè¿‡æ»¤  â”‚  â”‚ â€¢ LightGBM â”‚  â”‚ â€¢ å¤šæ ·æ€§   â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ å‘é‡å¬å›  â”‚  â”‚ â€¢ DeepFM   â”‚  â”‚ â€¢ ä¸šåŠ¡è§„åˆ™ â”‚      â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ çƒ­é—¨å¬å›  â”‚  â”‚ â€¢ Wide&Deepâ”‚  â”‚ â€¢ ABæµ‹è¯•   â”‚      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚ â­ v2.0æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   MongoDB    â”‚  â”‚  ClickHouse  â”‚  â”‚    Redis     â”‚      â”‚
â”‚  â”‚  (é…ç½®æ•°æ®)  â”‚  â”‚  (è¡Œä¸ºæ•°æ®)  â”‚  â”‚   (ç¼“å­˜)     â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚â€¢ åœºæ™¯é…ç½®    â”‚  â”‚â€¢ ç”¨æˆ·è¡Œä¸º    â”‚  â”‚â€¢ çƒ­é—¨ç‰©å“    â”‚      â”‚
â”‚  â”‚â€¢ ç‰©å“å…ƒæ•°æ®  â”‚  â”‚â€¢ æ›å…‰ç‚¹å‡»    â”‚  â”‚â€¢ å®æ—¶æŒ‡æ ‡    â”‚      â”‚
â”‚  â”‚â€¢ æ¨¡å‹é…ç½®    â”‚  â”‚â€¢ è½¬åŒ–æ•°æ®    â”‚  â”‚â€¢ ç”¨æˆ·ç”»åƒ    â”‚      â”‚
â”‚  â”‚â€¢ å®éªŒé…ç½®    â”‚  â”‚â€¢ æ—¶åºåˆ†æ    â”‚  â”‚â€¢ æ¨èç¼“å­˜    â”‚      â”‚
â”‚  â”‚â€¢ ç”¨æˆ·ç”»åƒ    â”‚  â”‚â€¢ OLAPæŸ¥è¯¢    â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  Milvus  â”‚   (å¯é€‰ï¼šå‘é‡æ£€ç´¢)                            â”‚
â”‚  â”‚  (å‘é‡)  â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®æ—¶è®¡ç®—å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              Kafka æ¶ˆæ¯é˜Ÿåˆ—                       â”‚       â”‚
â”‚  â”‚  Topic: user-behaviors-{tenant_id} ğŸ”’             â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚       â”‚
â”‚  â”‚  â”‚ è¡Œä¸ºäº‹ä»¶æµï¼ˆæŒ‰ç§Ÿæˆ·éš”ç¦»ï¼‰              â”‚        â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ impression, click, view            â”‚        â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ play, read, learn                  â”‚        â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ like, share, comment               â”‚        â”‚       â”‚
â”‚  â”‚  â”‚ â€¢ add_cart, order, payment           â”‚        â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           Flink æµå¤„ç†å¼•æ“                        â”‚       â”‚
â”‚  â”‚  Job1: ClickHouseSink (Kafka â†’ ClickHouse)       â”‚       â”‚
â”‚  â”‚  Job2: å®æ—¶ç‰©å“çƒ­åº¦ (â†’ Redis ZSET)               â”‚       â”‚
â”‚  â”‚  Job3: å®æ—¶æŒ‡æ ‡èšåˆ (â†’ Redis HASH)               â”‚       â”‚
â”‚  â”‚  Job4: ç”¨æˆ·ç”»åƒæ›´æ–° (â†’ MongoDB)                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                          â–¼                                   â”‚
â”‚         å†™å…¥ ClickHouse(ä¸») / Redis(ç¼“å­˜) / MongoDB(ç”»åƒ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¦»çº¿è®¡ç®—å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Celeryä»»åŠ¡é˜Ÿåˆ— â”‚  â”€â”€â”€â”€â”€â”€â–¶ â”‚  ç¦»çº¿è®¡ç®—       â”‚           â”‚
â”‚  â”‚  â€¢ æ¨¡å‹è®­ç»ƒ      â”‚         â”‚  â€¢ ç›¸ä¼¼åº¦è®¡ç®—   â”‚           â”‚
â”‚  â”‚  â€¢ æ‰¹é‡é¢„è®¡ç®—    â”‚         â”‚  â€¢ ç”»åƒç¦»çº¿æ›´æ–° â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 å¾®æœåŠ¡æ‹†åˆ†ï¼ˆæ”¯æŒK8sç‹¬ç«‹éƒ¨ç½²ï¼‰

### æœåŠ¡åˆ—è¡¨ï¼ˆv2.0æ¶æ„æ›´æ–°ï¼‰

| æœåŠ¡åç§° | ç«¯å£ | åè®® | èŒè´£ | ç‹¬ç«‹éƒ¨ç½² | v2.0å˜æ›´ |
|---------|------|------|------|---------|---------|
| scenario-service | 8001/9001 | HTTP + gRPC | åœºæ™¯CRUDã€é…ç½®ç®¡ç† | âœ… | - |
| item-service | 8002/9002 | HTTP + gRPC | ç‰©å“CRUDã€æ‰¹é‡å¯¼å…¥ | âœ… | - |
| **behavior-service** | **8003/9003** | **HTTP + gRPC** | **è¡Œä¸ºé‡‡é›†ã€Kafkaå‘é€** | âœ… | **â­ ä¸å†™MongoDB** |
| recommendation-service | 8004 | HTTP | æ¨èæ¥å£ã€æµç¨‹ç¼–æ’ | âœ… | - |
| feature-service | 9005 | gRPC | ç‰¹å¾æå–ã€ç‰¹å¾æœåŠ¡ | âœ… | - |
| model-service | 9006 | gRPC | æ¨¡å‹åŠ è½½ã€åœ¨çº¿é¢„æµ‹ | âœ… | - |
| **analytics-service** | **9007** | **gRPC** | **æ•°æ®åˆ†ææŸ¥è¯¢** | âœ… | **â­ æ–°å¢ï¼ˆClickHouseæŸ¥è¯¢ï¼‰** |

**behavior-service v2.0å˜æ›´ï¼š**
- âœ… å¼ºåˆ¶tenant_idéªŒè¯ï¼ˆSaaSéš”ç¦»ï¼‰
- âœ… ç›´æ¥å‘é€åˆ°Kafkaï¼ˆä¸å†™MongoDBï¼‰
- âœ… æ”¯æŒHTTPå’ŒgRPCåŒåè®®
- âœ… æ‰¹é‡é‡‡é›†æ”¯æŒï¼ˆé«˜ååï¼‰
- âœ… å¼‚æ­¥éé˜»å¡ï¼ˆä¸å½±å“æ€§èƒ½ï¼‰

**analytics-serviceï¼ˆæ–°å¢ï¼‰ï¼š**
- âœ… ä»ClickHouseæŸ¥è¯¢è¡Œä¸ºæ•°æ®
- âœ… ä»ªè¡¨æ¿ã€è¶‹åŠ¿ã€åˆ†å¸ƒã€æ¼æ–—åˆ†æ
- âœ… æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- âœ… èšåˆæŸ¥è¯¢ä¼˜åŒ–ï¼ˆç‰©åŒ–è§†å›¾ï¼‰

### æœåŠ¡é—´è°ƒç”¨æ–¹å¼

**å¯¹å¤–APIï¼ˆå®¢æˆ·ç«¯ï¼‰**: HTTP REST API
- scenario-service, item-service, behavior-service, recommendation-service

**å†…éƒ¨è°ƒç”¨ï¼ˆæœåŠ¡é—´ï¼‰**: gRPC
- recommendation-service â†’ feature-service/model-service
- ä¼˜åŠ¿ï¼šé«˜æ€§èƒ½ã€å¼ºç±»å‹ã€å†…ç½®è´Ÿè½½å‡è¡¡

**æœåŠ¡å‘ç°**: Kubernetes Service Discovery
- å¼€å‘ç¯å¢ƒï¼šdocker-compose DNS
- ç”Ÿäº§ç¯å¢ƒï¼šK8s Serviceåç§°

### æœåŠ¡ä¾èµ–å…³ç³»

```
æ— ä¾èµ–ï¼ˆå¯æœ€å…ˆéƒ¨ç½²ï¼‰:
â”œâ”€ scenario-service
â”œâ”€ item-service  
â”œâ”€ behavior-service
â”œâ”€ feature-service
â””â”€ model-service

æœ‰ä¾èµ–ï¼ˆæœ€åéƒ¨ç½²ï¼‰:
â””â”€ recommendation-service
   â”œâ”€ depends: scenario-service (è·å–é…ç½®)
   â”œâ”€ depends: feature-service (ç‰¹å¾æå–)
   â”œâ”€ depends: model-service (æ¨¡å‹é¢„æµ‹)
   â””â”€ depends: item-service (ç‰©å“è¯¦æƒ…)
```

## 2.3 æ¨èæµç¨‹

```
ç”¨æˆ·è¯·æ±‚
   â†“
åœºæ™¯é…ç½®åŠ è½½
   â†“
ç”¨æˆ·ç”»åƒè·å– (Redis/MongoDB)
   â†“
å¬å›å±‚ï¼ˆå¤šè·¯å¬å›å¹¶è¡Œï¼‰
   â”œâ”€ ååŒè¿‡æ»¤å¬å›
   â”œâ”€ å‘é‡å¬å›
   â”œâ”€ çƒ­é—¨å¬å›ï¼ˆä»Redisè·å–Flinkå®æ—¶è®¡ç®—çš„çƒ­åº¦ï¼‰
   â””â”€ åœºæ™¯ç‰¹å®šå¬å›
   â†“
å€™é€‰é›†åˆå¹¶&å»é‡
   â†“
ç‰¹å¾æå–
   â†“
æ’åºå±‚ï¼ˆæ¨¡å‹æ‰“åˆ†ï¼‰
   â†“
é‡æ’å±‚ï¼ˆå¤šæ ·æ€§ã€ä¸šåŠ¡è§„åˆ™ï¼‰
   â†“
ABæµ‹è¯•åˆ†æµ
   â†“
ç»“æœç¼“å­˜
   â†“
è¿”å›æ¨èç»“æœ
```

## 2.4 Kafka + Flink å®æ—¶è®¡ç®—æ¶æ„

### Kafka Topics è®¾è®¡ï¼ˆv2.0æ¶æ„ - SaaSå¤šç§Ÿæˆ·éš”ç¦»ï¼‰

```
æ¨èç³»ç»Ÿçš„Kafka Topicè§„åˆ’ï¼š

1. user-behaviors-{tenant_id} ğŸ”’ (æ ¸å¿ƒTopicï¼ŒæŒ‰ç§Ÿæˆ·éš”ç¦»)
   - ç”¨æˆ·è¡Œä¸ºåŸå§‹æ•°æ®ï¼ˆæ‰€æœ‰åŸ‹ç‚¹äº‹ä»¶ï¼‰
   - å‘½åè§„åˆ™ï¼šuser-behaviors-{tenant_id}
     ä¾‹å¦‚ï¼šuser-behaviors-mymx
           user-behaviors-tenant_abc
   - åˆ†åŒºæ•°ï¼š12-24ï¼ˆæ ¹æ®ç§Ÿæˆ·æµé‡ï¼‰
   - ä¿ç•™æ—¶é—´ï¼š7å¤©
   - Key: user_idï¼ˆä¿è¯åŒä¸€ç”¨æˆ·äº‹ä»¶æœ‰åºï¼‰
   - Value: JSONæ ¼å¼åŸ‹ç‚¹æ•°æ®
   - SaaSéš”ç¦»ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹Topicï¼Œé˜²æ­¢æ•°æ®æ··æ·†
   
2. user-profile-updates
   - ç”¨æˆ·ç”»åƒæ›´æ–°äº‹ä»¶ï¼ˆFlinkè®¡ç®—äº§å‡ºï¼‰
   - å†™å…¥MongoDB user_profiles
   
3. item-stats-updates
   - ç‰©å“ç»Ÿè®¡æ›´æ–°äº‹ä»¶ï¼ˆFlinkè®¡ç®—äº§å‡ºï¼‰
   - å®æ—¶çƒ­åº¦ã€ç‚¹å‡»ç‡ç­‰
   - å†™å…¥Redis ZSET (hot:items:{tenant_id}:{scenario_id})
   
4. recommendation-metrics
   - æ¨èç³»ç»ŸæŒ‡æ ‡ï¼ˆFlinkè®¡ç®—äº§å‡ºï¼‰
   - CTRã€æ›å…‰ã€ç‚¹å‡»ç­‰
   - å†™å…¥Redis HASH (metrics:realtime:{tenant_id}:{scenario_id})
```

**SaaSç§Ÿæˆ·éš”ç¦»ç­–ç•¥ï¼š**
- âœ… TopicæŒ‰tenant_idéš”ç¦»ï¼ˆuser-behaviors-{tenant_id}ï¼‰
- âœ… behavior-serviceå¼ºåˆ¶éªŒè¯tenant_idï¼Œæ— tenant_idæ‹’ç»
- âœ… Flinkæ¶ˆè´¹æ—¶æŒ‰tenant_idåˆ†ç»„å¤„ç†
- âœ… ClickHouseå­˜å‚¨æ—¶æŒ‰tenant_idåˆ†åŒº
- âœ… é˜²æ­¢ç§Ÿæˆ·é—´æ•°æ®æ³„éœ²å’Œæ··æ·†

### Flink ä»»åŠ¡è®¾è®¡ï¼ˆv2.0æ¶æ„ - ClickHouseä¼˜å…ˆï¼‰

#### 1. ClickHouseSinkï¼ˆæ ¸å¿ƒï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰â­
```
Kafka (user-behaviors-{tenant_id})
   â†’ Flink Job: ClickHouseSink
   â†’ æ‰¹é‡æ¶ˆè´¹ï¼ˆæ¯1000æ¡æˆ–5ç§’ï¼‰
   â†’ æ•°æ®æ¸…æ´—å’ŒéªŒè¯
   â†’ æ‰¹é‡å†™å…¥ ClickHouse (user_behaviorsè¡¨)
   â†’ ç‰©åŒ–è§†å›¾è‡ªåŠ¨èšåˆï¼ˆmetrics_hourly, item_stats_dailyï¼‰
   
ä½œç”¨ï¼šè¡Œä¸ºæ•°æ®æŒä¹…åŒ–åˆ°ClickHouseï¼ˆä¸»å­˜å‚¨ï¼‰
æ€§èƒ½ï¼šæ‰¹é‡å†™å…¥ï¼Œååé‡10ä¸‡TPS+
```

#### 2. ç”¨æˆ·ç”»åƒå®æ—¶æ›´æ–°
```
Kafka (user-behaviors-{tenant_id})
   â†’ Flink Job: UserProfileAggregator
   â†’ æŒ‰ tenant_id + user_id åˆ†ç»„
   â†’ æ—¶é—´çª—å£èšåˆï¼ˆ5åˆ†é’Ÿæ»šåŠ¨çª—å£ï¼‰
   â†’ è®¡ç®—ï¼šè§‚çœ‹æ¬¡æ•°ã€åå¥½åˆ†ç±»ã€æ´»è·ƒæ—¶æ®µ
   â†’ è¾“å‡ºåˆ° Kafka (user-profile-updates)
   â†’ å¼‚æ­¥å†™å…¥ MongoDB (user_profiles)
   
ä½œç”¨ï¼šå®æ—¶æ›´æ–°ç”¨æˆ·ç”»åƒï¼Œç”¨äºæ¨èç®—æ³•
å­˜å‚¨ï¼šMongoDBï¼ˆæ–‡æ¡£å‹ï¼Œçµæ´»Schemaï¼‰
```

#### 3. ç‰©å“çƒ­åº¦å®æ—¶è®¡ç®—
```
Kafka (user-behaviors-{tenant_id})
   â†’ Flink Job: ItemHotScoreCalculator
   â†’ æŒ‰ tenant_id + item_id åˆ†ç»„
   â†’ æ—¶é—´çª—å£èšåˆï¼ˆ1å°æ—¶æ»‘åŠ¨çª—å£ï¼‰
   â†’ è®¡ç®—ï¼šæµè§ˆé‡ã€ç‚¹å‡»é‡ã€æ—¶é—´è¡°å‡çƒ­åº¦
   â†’ è¾“å‡ºåˆ° Redis ZSET (hot:items:{tenant_id}:{scenario_id})
   
ä½œç”¨ï¼šå®æ—¶çƒ­åº¦æ¦œå•ï¼Œç”¨äºçƒ­é—¨å¬å›
å­˜å‚¨ï¼šRedisï¼ˆå†…å­˜ï¼Œä½å»¶è¿Ÿï¼‰
TTLï¼š24å°æ—¶
```

#### 4. å®æ—¶æŒ‡æ ‡ç»Ÿè®¡
```
Kafka (user-behaviors-{tenant_id})
   â†’ Flink Job: RecommendationMetrics
   â†’ æŒ‰ tenant_id + scenario_id + experiment_id åˆ†ç»„
   â†’ è®¡ç®—ï¼šCTRã€å¹³å‡è§‚çœ‹æ—¶é•¿ã€è½¬åŒ–ç‡
   â†’ è¾“å‡ºåˆ° Redis HASH (metrics:realtime:{tenant_id}:{scenario_id})
   â†’ å¯é€‰ï¼šè¾“å‡ºåˆ° Prometheus (é€šè¿‡Pushgateway)
   
ä½œç”¨ï¼šå®æ—¶æŒ‡æ ‡ç›‘æ§ï¼Œå±•ç¤ºåœ¨æ•°æ®åˆ†æé¡µé¢
å­˜å‚¨ï¼šRedisï¼ˆå¿«é€Ÿè¯»å–ï¼‰
TTLï¼š1å°æ—¶
```

### Flink ä½œä¸šç¤ºä¾‹

```python
# ä¼ªä»£ç ç¤ºä¾‹ï¼šç”¨æˆ·ç”»åƒå®æ—¶æ›´æ–°
from pyflink.datastream import StreamExecutionEnvironment
from pyflink.datastream.window import TumblingProcessingTimeWindows
from pyflink.common import Time

env = StreamExecutionEnvironment.get_execution_environment()

# ä»Kafkaè¯»å–
behaviors = env.add_source(
    FlinkKafkaConsumer(
        topics=['user-behaviors'],
        deserialization_schema=JsonDeserializationSchema(),
        properties={'bootstrap.servers': 'kafka:9092'}
    )
)

# å¤„ç†é€»è¾‘
user_profiles = (
    behaviors
    .key_by(lambda x: (x['tenant_id'], x['user_id']))
    .window(TumblingProcessingTimeWindows.of(Time.minutes(5)))
    .aggregate(UserProfileAggregateFunction())
)

# å†™å…¥Sink
user_profiles.add_sink(
    FlinkKafkaSink(
        topic='user-profile-updates',
        serialization_schema=JsonSerializationSchema()
    )
)

env.execute("User Profile Real-time Updater")
```

### æ•°æ®æµå‘ï¼ˆv2.0æ¶æ„ - ç®€åŒ–ç‰ˆï¼‰

```
ç”¨æˆ·è¡Œä¸ºä¸ŠæŠ¥ï¼ˆå‰ç«¯åŸ‹ç‚¹ï¼‰
   â†“
FastAPI behavior-service (è¡Œä¸ºé‡‡é›†æœåŠ¡)
   â”œâ”€ å¼ºåˆ¶éªŒè¯tenant_idï¼ˆSaaSéš”ç¦»ï¼‰ğŸ”’
   â”œâ”€ æ•°æ®éªŒè¯ï¼ˆå¿…å¡«å­—æ®µã€æ ¼å¼ï¼‰
   â””â”€ ç›´æ¥å‘é€åˆ° Kafka â­ (ä¸å†™MongoDB)
   
   â†“ Kafka (user-behaviors-{tenant_id})
   
Flink æ¶ˆè´¹ Kafkaï¼ˆ4ä¸ªå¹¶è¡ŒJobï¼‰
   â”œâ”€ Job1: ClickHouseSink â†’ ClickHouse (user_behaviors) â­ ä¸»å­˜å‚¨
   â”œâ”€ Job2: UserProfileAggregator â†’ MongoDB (user_profiles)
   â”œâ”€ Job3: ItemHotScoreCalculator â†’ Redis (hot:items:*)
   â””â”€ Job4: RecommendationMetrics â†’ Redis (metrics:realtime:*)
   
   â†“
æ•°æ®è¯»å–ï¼ˆå¤šä¸ªæœåŠ¡ï¼‰
   â”œâ”€ AnalyticsService â†’ ClickHouseæŸ¥è¯¢ï¼ˆè¶‹åŠ¿ã€æŠ¥è¡¨ï¼‰
   â”œâ”€ RecommendationService â†’ Redisè¯»å–ï¼ˆçƒ­åº¦ã€å®æ—¶æŒ‡æ ‡ï¼‰
   â””â”€ FeatureService â†’ MongoDBè¯»å–ï¼ˆç”¨æˆ·ç”»åƒï¼‰
```

**v1.0 vs v2.0å¯¹æ¯”ï¼š**
```
âŒ v1.0ï¼ˆæ—§æ–¹æ¡ˆï¼‰ï¼š
   behavior-service â†’ MongoDB + Kafka
                        â†“        â†“
                     æ•°æ®é‡å¤    Flink â†’ ClickHouse
                     
âœ… v2.0ï¼ˆæ–°æ–¹æ¡ˆï¼‰ï¼š
   behavior-service â†’ Kafka â†’ Flink â†’ ClickHouse
                                â†“
                         å•ä¸€è¡Œä¸ºæ•°æ®æº
                         
æ”¶ç›Šï¼š
- å‡å°‘50%å­˜å‚¨æˆæœ¬ï¼ˆä¸åœ¨MongoDBå­˜è¡Œä¸ºï¼‰
- é™ä½ç³»ç»Ÿå¤æ‚åº¦ï¼ˆæ— åŒå†™é€»è¾‘ï¼‰
- æå‡æ€§èƒ½ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
- MongoDBä¸“æ³¨é…ç½®æ•°æ®ï¼Œå“åº”æ›´å¿«
```

---

# 3. æ•°æ®æ¨¡å‹

## 3.1 MongoDB Collectionsï¼ˆv2.0æ¶æ„ - ä»…å­˜é…ç½®æ•°æ®ï¼‰

**âš ï¸ é‡è¦å˜æ›´ï¼šMongoDBä¸å†å­˜å‚¨è¡Œä¸ºæ•°æ®ï¼ˆinteractionsï¼‰ï¼Œæ‰€æœ‰è¡Œä¸ºæ•°æ®ç›´æ¥åˆ°ClickHouse**

### scenariosï¼ˆåœºæ™¯é…ç½®ï¼‰
```javascript
{
  _id: ObjectId,
  tenant_id: "tenant_123",
  scenario_id: "vlog_001",
  scenario_type: "vlog",
  name: "çŸ­è§†é¢‘æ¨è",
  config: {
    features: {...},
    recall: {...},
    rank: {...},
    rerank: {...}
  },
  status: "active",
  created_at: ISODate,
  updated_at: ISODate
}

// ç´¢å¼•
db.scenarios.createIndex({tenant_id: 1, scenario_id: 1}, {unique: true})
```

### itemsï¼ˆç‰©å“å…ƒæ•°æ®ï¼‰
```javascript
{
  _id: ObjectId,
  tenant_id: "tenant_123",
  scenario_id: "vlog_001",
  item_id: "item_001",
  metadata: {
    title: "è§†é¢‘æ ‡é¢˜",
    duration: 120,
    category: "entertainment",
    tags: ["funny", "comedy"],
    // åœºæ™¯ç‰¹æœ‰å­—æ®µ...
  },
  embedding: [0.1, 0.2, ...],  // å¯é€‰
  status: "active",
  created_at: ISODate,
  updated_at: ISODate
}

// ç´¢å¼•
db.items.createIndex({tenant_id: 1, scenario_id: 1, item_id: 1}, {unique: true})
db.items.createIndex({"metadata.category": 1})
```

### user_profilesï¼ˆç”¨æˆ·ç”»åƒï¼‰
```javascript
{
  _id: ObjectId,
  tenant_id: "tenant_123",
  user_id: "user_001",
  scenario_id: "vlog_001",
  features: {
    total_watch_count: 100,
    favorite_categories: ["entertainment"],
    // ...
  },
  preferences: {
    category_scores: {"entertainment": 0.8}
  },
  embedding: [0.1, 0.2, ...],
  updated_at: ISODate
}

// ç´¢å¼•
db.user_profiles.createIndex({tenant_id: 1, user_id: 1, scenario_id: 1}, {unique: true})
```

### ~~interactionsï¼ˆè¡Œä¸ºæ—¥å¿—ï¼‰~~ âŒ v2.0å·²åºŸå¼ƒ
**ä¸å†ä½¿ç”¨ï¼æ‰€æœ‰è¡Œä¸ºæ•°æ®å­˜å‚¨åˆ°ClickHouse**

ç†ç”±ï¼š
- âŒ MongoDBä¸é€‚åˆå¤§è§„æ¨¡OLAPæŸ¥è¯¢
- âŒ è¡Œä¸ºæ•°æ®å¢é•¿å¿«ï¼ˆäº¿çº§ï¼‰ï¼ŒMongoDBæ€§èƒ½å·®
- âœ… ClickHouseä¸“ä¸ºOLAPè®¾è®¡ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«100å€+
- âœ… åˆ—å¼å­˜å‚¨ï¼Œå‹ç¼©ç‡é«˜ï¼ˆèŠ‚çœ10å€å­˜å‚¨ç©ºé—´ï¼‰

æ•°æ®æµï¼š
```
æ—§æ–¹æ¡ˆï¼ˆv1.0ï¼‰ï¼š
behavior-service â†’ MongoDB + Kafka â†’ Flink â†’ ClickHouse
                     â†“ æ•°æ®é‡å¤

æ–°æ–¹æ¡ˆï¼ˆv2.0ï¼‰ï¼š
behavior-service â†’ Kafka â†’ Flink â†’ ClickHouse
                              â†“ å•ä¸€æ•°æ®æº
```

### model_configsï¼ˆæ¨¡å‹é…ç½®ï¼‰
```javascript
{
  _id: ObjectId,
  scenario_id: "vlog_001",
  model_type: "rank",
  model_name: "deepfm",
  model_version: "v1.0",
  model_path: "s3://models/deepfm_v1.0.pt",
  config: {...},
  metrics: {auc: 0.85},
  status: "active",
  created_at: ISODate
}
```

### experimentsï¼ˆABå®éªŒï¼‰
```javascript
{
  _id: ObjectId,
  tenant_id: "tenant_123",
  scenario_id: "vlog_001",
  experiment_id: "exp_001",
  name: "æµ‹è¯•æ–°æ’åºæ¨¡å‹",
  groups: [
    {group_id: "control", traffic_ratio: 0.5, config: {...}},
    {group_id: "treatment", traffic_ratio: 0.5, config: {...}}
  ],
  status: "running",
  start_time: ISODate,
  end_time: ISODate
}
```

## 3.2 Redisæ•°æ®ç»“æ„

```
# ç§Ÿæˆ·é…ç½®ç¼“å­˜
tenant:config:{tenant_id} â†’ JSON (TTL: 1å°æ—¶)

# ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
user:info:{tenant_id}:{user_id} â†’ JSON (TTL: 30åˆ†é’Ÿ)

# ç”¨æˆ·ç”»åƒç¼“å­˜
user:profile:{tenant_id}:{user_id}:{scenario_id} â†’ JSON (TTL: 1å°æ—¶)

# æ¨èç»“æœç¼“å­˜
recommend:{tenant_id}:{scenario_id}:{user_id}:{hash} â†’ JSON (TTL: 10åˆ†é’Ÿ)

# åœºæ™¯é…ç½®ç¼“å­˜
scenario:config:{tenant_id}:{scenario_id} â†’ JSON (TTL: 1å°æ—¶)

# çƒ­é—¨ç‰©å“
hot:items:{tenant_id}:{scenario_id} â†’ ZSET (score=çƒ­åº¦)

# ç‰©å“æ›å…‰å»é‡
exposed:{tenant_id}:{user_id}:{scenario_id} â†’ SET (TTL: 24å°æ—¶)

# å®æ—¶è®¡æ•°
item:stats:{tenant_id}:{item_id} â†’ HASH (view_count, like_countç­‰)
```

---

# 4. åœºæ™¯é…ç½®

## 4.1 é…ç½®åŒ–è®¾è®¡ç†å¿µ

**æ ¸å¿ƒæ€æƒ³**ï¼šç»Ÿä¸€çš„æ¨èå¼•æ“æ¡†æ¶ + çµæ´»çš„åœºæ™¯é…ç½® = æ”¯æŒå¤šåœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç»Ÿä¸€çš„æ¨èå¼•æ“ï¼ˆä»£ç ï¼‰      â”‚
â”‚   â€¢ å¯æ’æ‹”çš„å¬å›ç­–ç•¥         â”‚
â”‚   â€¢ å¯é…ç½®çš„æ’åºæ¨¡å‹         â”‚
â”‚   â€¢ å¯é…ç½®çš„é‡æ’è§„åˆ™         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ è¯»å–
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åœºæ™¯é…ç½®ï¼ˆæ•°æ®ï¼‰          â”‚
â”‚   â€¢ vlogé…ç½®                 â”‚
â”‚   â€¢ æ–°é—»é…ç½®                 â”‚
â”‚   â€¢ ç”µå•†é…ç½®                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4.2 åœºæ™¯é…ç½®ç»“æ„

### Vlogåœºæ™¯ç¤ºä¾‹
```json
{
  "scenario_id": "vlog_main_feed",
  "scenario_type": "vlog",
  "config": {
    "features": {
      "item_features": [
        {"name": "duration", "type": "numeric", "weight": 1.0},
        {"name": "completion_rate", "type": "numeric", "weight": 2.0},
        {"name": "category", "type": "categorical", "weight": 1.5}
      ],
      "user_features": [
        {"name": "age", "type": "categorical"},
        {"name": "favorite_categories", "type": "multi_categorical"}
      ]
    },
    "recall": {
      "strategies": [
        {"name": "user_cf", "weight": 0.25, "limit": 100},
        {"name": "vector_search", "weight": 0.3, "limit": 150},
        {"name": "hot_items", "weight": 0.2, "limit": 50}
      ]
    },
    "rank": {
      "model": "deepfm",
      "version": "v1.0",
      "objective": "watch_time"
    },
    "rerank": {
      "rules": [
        {"name": "diversity", "weight": 0.3},
        {"name": "freshness", "weight": 0.2, "params": {"decay_days": 7}}
      ]
    }
  }
}
```

### æ–°é—»åœºæ™¯ç¤ºä¾‹
```json
{
  "scenario_id": "news_main_feed",
  "scenario_type": "news",
  "config": {
    "features": {
      "item_features": [
        {"name": "publish_time", "type": "timestamp", "weight": 3.0},
        {"name": "hot_score", "type": "numeric", "weight": 2.5},
        {"name": "location", "type": "categorical", "weight": 1.5}
      ]
    },
    "recall": {
      "strategies": [
        {"name": "hot_news", "weight": 0.5, "limit": 200},
        {"name": "content_based", "weight": 0.3, "limit": 150},
        {"name": "user_cf", "weight": 0.2, "limit": 100}
      ]
    },
    "rank": {
      "model": "lightgbm",
      "version": "v2.0",
      "objective": "click_rate"
    },
    "rerank": {
      "rules": [
        {"name": "freshness", "weight": 0.5, "params": {"decay_hours": 6}},
        {"name": "location_match", "weight": 0.2}
      ]
    }
  }
}
```

## 4.3 é…ç½®å¦‚ä½•é©±åŠ¨æ¨è

```python
async def recommend(tenant_id: str, user_id: str, scenario_id: str, count: int):
    # 1. åŠ è½½åœºæ™¯é…ç½®
    config = await load_scenario_config(tenant_id, scenario_id)
    
    # 2. å¬å›ï¼ˆæ ¹æ®é…ç½®ï¼‰
    recall_results = []
    for strategy_config in config["recall"]["strategies"]:
        strategy = get_recall_strategy(strategy_config["name"])
        items = await strategy.recall(
            user_id=user_id,
            limit=strategy_config["limit"],
            params=strategy_config.get("params", {})
        )
        weighted_items = [(item, strategy_config["weight"]) for item in items]
        recall_results.extend(weighted_items)
    
    # 3. æ’åºï¼ˆæ ¹æ®é…ç½®é€‰æ‹©æ¨¡å‹ï¼‰
    rank_config = config["rank"]
    model = load_model(rank_config["model"], rank_config["version"])
    scores = model.predict(candidate_items)
    
    # 4. é‡æ’ï¼ˆæ ¹æ®é…ç½®åº”ç”¨è§„åˆ™ï¼‰
    for rule_config in config["rerank"]["rules"]:
        rule = get_rerank_rule(rule_config["name"])
        ranked_items = rule.apply(ranked_items, rule_config)
    
    return ranked_items[:count]
```

## 4.4 é…ç½®ä¼˜åŠ¿

âœ… **æ— éœ€æ”¹ä»£ç **ï¼šè°ƒæ•´æƒé‡ã€æ–°å¢ç‰¹å¾åªéœ€æ”¹é…ç½®  
âœ… **å¿«é€Ÿè¿­ä»£**ï¼šé…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ  
âœ… **ABæµ‹è¯•å‹å¥½**ï¼šä¸åŒå®éªŒç»„ä½¿ç”¨ä¸åŒé…ç½®  
âœ… **å¤šç§Ÿæˆ·å®šåˆ¶**ï¼šåŒä¸€å¥—ä»£ç ï¼Œä¸åŒç§Ÿæˆ·ä¸åŒé…ç½®

---

# 5. æœåŠ¡å¯¹æ¥

## 5.1 ä¸APIç½‘å…³å¯¹æ¥

### è¯·æ±‚å¤´è§„èŒƒ

ç½‘å…³è½¬å‘è¯·æ±‚æ—¶æºå¸¦ï¼š

| Header | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `X-Tenant-Id` | æ˜¯ | ç§Ÿæˆ·ID | `tenant_123` |
| `X-User-Id` | æ˜¯ | ç”¨æˆ·ID | `user_456` |
| `X-Request-Id` | æ˜¯ | è¯·æ±‚è¿½è¸ªID | `req_001` |
| `Authorization` | æ˜¯ | Bearer Token | `Bearer xxx` |

### æ¨èAPIç¤ºä¾‹

```http
POST /api/v1/recommend
X-Tenant-Id: tenant_123
X-User-Id: user_456
X-Request-Id: req_001
Authorization: Bearer xxx

{
  "scenario_id": "vlog_001",
  "count": 20,
  "context": {
    "device_type": "mobile"
  }
}
```

## 5.2 ä¸ç§Ÿæˆ·/ç”¨æˆ·æœåŠ¡å¯¹æ¥

### gRPCæ¥å£å®šä¹‰

#### è·å–ç§Ÿæˆ·é…ç½®
```protobuf
service TenantService {
  rpc GetTenantConfig (GetTenantConfigRequest) returns (GetTenantConfigResponse);
}

message GetTenantConfigRequest {
  string tenant_id = 1;
}

message GetTenantConfigResponse {
  string tenant_id = 1;
  string tenant_name = 2;
  TenantQuota quota = 3;
  string status = 4;
}
```

#### è·å–ç”¨æˆ·ä¿¡æ¯
```protobuf
service UserService {
  rpc GetUserInfo (GetUserInfoRequest) returns (GetUserInfoResponse);
}

message GetUserInfoRequest {
  string tenant_id = 1;
  string user_id = 2;
}

message GetUserInfoResponse {
  string user_id = 1;
  map<string, string> profile = 2;  // age, gender, location
  string status = 3;
}
```

### è°ƒç”¨ç¤ºä¾‹

```python
# gRPCå®¢æˆ·ç«¯
class TenantServiceClient:
    async def get_tenant_config(self, tenant_id: str):
        request = GetTenantConfigRequest(tenant_id=tenant_id)
        response = await self.stub.GetTenantConfig(request, timeout=5.0)
        return response

# ä½¿ç”¨
tenant_config = await tenant_service.get_tenant_config("tenant_123")
user_info = await user_service.get_user_info("tenant_123", "user_456")
```

## 5.3 ç¼“å­˜ç­–ç•¥

- **ç§Ÿæˆ·é…ç½®**ï¼šç¼“å­˜1å°æ—¶ï¼Œä»ç§Ÿæˆ·æœåŠ¡è·å–åç¼“å­˜
- **ç”¨æˆ·ä¿¡æ¯**ï¼šç¼“å­˜30åˆ†é’Ÿï¼ŒLRUæ·˜æ±°
- **åœºæ™¯é…ç½®**ï¼šç¼“å­˜1å°æ—¶ï¼ŒMongoDBè¯»å–åç¼“å­˜

## 5.4 é”™è¯¯å¤„ç†

- å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®
- è¶…æ—¶è®¾ç½®3-5ç§’
- è‡ªåŠ¨é‡è¯•1-2æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£
- [å¼€å‘è®¡åˆ’](./å¼€å‘è®¡åˆ’.md) - è¯¦ç»†çš„å¼€å‘è·¯çº¿å›¾å’Œä»»åŠ¡åˆ†è§£
- [K8séƒ¨ç½²](../k8s/README.md) - Kuberneteséƒ¨ç½²é…ç½®å’Œè¯´æ˜

### å…³é”®æŠ€æœ¯å†³ç­–
| å†³ç­–ç‚¹ | é€‰å‹ | ç†ç”± |
|-------|------|------|
| æ•°æ®åº“ | MongoDB | çµæ´»Schemaï¼Œé€‚åˆå¤šåœºæ™¯å¼‚æ„æ•°æ® |
| æ¶ˆæ¯é˜Ÿåˆ— | Kafka (KRaft) | æ— éœ€Zookeeperï¼Œç®€åŒ–æ¶æ„ |
| æœåŠ¡é—´è°ƒç”¨ | gRPC | é«˜æ€§èƒ½ã€å¼ºç±»å‹ã€å†…ç½®è´Ÿè½½å‡è¡¡ |
| åœºæ™¯å®ç° | é…ç½®åŒ– | å¿«é€Ÿè¿­ä»£ï¼Œæ— éœ€æ”¹ä»£ç  |
| æœåŠ¡æ‹†åˆ† | å¾®æœåŠ¡ | æ”¯æŒK8sç‹¬ç«‹éƒ¨ç½²å’Œæ‰©ç¼©å®¹ |

