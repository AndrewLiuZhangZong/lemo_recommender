# 本地开发环境配置

## 依赖服务

### 1. MongoDB (由本项目启动)
```bash
docker-compose up -d mongodb
```

**连接信息**:
- URL: `mongodb://admin:password@localhost:27017`
- Database: `lemo_recommender`

### 2. Redis (使用本地已有服务)

**已有配置**:
```yaml
redis:
  image: redis:7-alpine
  container_name: ai_lemo_redis
  ports:
    - "6379:6379"
  command: redis-server --appendonly yes --requirepass redis_password_2024
```

**连接信息**:
- URL: `redis://:redis_password_2024@localhost:6379/0`
- 密码: `redis_password_2024`

**验证连接**:
```bash
redis-cli -h localhost -p 6379 -a redis_password_2024 ping
```

### 3. Kafka (使用本地已有服务)

**已有配置**:
```yaml
kafka:
  image: confluentinc/cp-kafka:7.5.0
  container_name: ad-mat-aegis-kafka
  ports:
    - "9092:9092"
    - "9093:9093"
  environment:
    KAFKA_NODE_ID: 1
    KAFKA_PROCESS_ROLES: 'broker,controller'
    # KRaft模式，无需Zookeeper
```

**连接信息**:
- Bootstrap Servers: `localhost:9092`

**验证连接**:
```bash
# 列出所有topic
docker exec -it ad-mat-aegis-kafka kafka-topics --bootstrap-server localhost:9092 --list

# 创建测试topic
docker exec -it ad-mat-aegis-kafka kafka-topics \
  --bootstrap-server localhost:9092 \
  --create \
  --topic user-behaviors \
  --partitions 3 \
  --replication-factor 1
```

## 环境变量配置

创建 `.env` 文件：

```bash
cp .env.example .env
```

确认配置正确：

```env
# MongoDB（本项目启动）
MONGODB_URL=mongodb://admin:password@localhost:27017
MONGODB_DATABASE=lemo_recommender

# Redis（使用本地已有）
REDIS_URL=redis://:redis_password_2024@localhost:6379/0

# Kafka（使用本地已有）
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
```

## 快速启动

```bash
# 1. 安装依赖
poetry install

# 2. 启动MongoDB（Redis和Kafka已在其他docker-compose中运行）
docker-compose up -d mongodb

# 3. 等待MongoDB就绪
sleep 5

# 4. 启动应用
poetry run python app/main.py
```

或者使用快捷脚本：

```bash
./run.sh
```

## 验证服务

### 检查所有服务状态

```bash
# MongoDB
docker ps | grep lemo-mongodb

# Redis (本地)
docker ps | grep ai_lemo_redis

# Kafka (本地)
docker ps | grep ad-mat-aegis-kafka
```

### 访问API

启动后访问：
- API文档: http://localhost:8000/api/v1/docs
- 健康检查: http://localhost:8000/health

## 监控服务

### Prometheus (可选)
```bash
docker-compose up -d prometheus
```
访问: http://localhost:9090

### Grafana (可选)
```bash
docker-compose up -d grafana
```
访问: http://localhost:3000 (admin/admin)

## 停止服务

```bash
# 只停止本项目的MongoDB
docker-compose down

# 保留本地的Redis和Kafka运行
```

## 常见问题

### Q: Redis连接失败？
**A**: 检查密码是否正确，确认使用 `redis_password_2024`

### Q: Kafka连接失败？
**A**: 确认Kafka容器 `ad-mat-aegis-kafka` 正在运行：
```bash
docker ps | grep kafka
docker logs ad-mat-aegis-kafka
```

### Q: MongoDB初始化脚本未执行？
**A**: 删除volume重新创建：
```bash
docker-compose down -v
docker-compose up -d mongodb
```

### 4. Milvus (使用本地已有服务，第二阶段)

**已有配置**:
```yaml
# Milvus依赖
etcd:
  container_name: ai_lemo_etcd
  ports: ["2379:2379"]

minio:
  container_name: ai_lemo_minio
  ports: ["9000:9000", "8001:9001"]

# Milvus向量数据库
milvus:
  image: milvusdb/milvus:v2.4.15
  container_name: ai_lemo_milvus
  ports: ["19530:19530", "9091:9091"]

# Attu管理界面
attu:
  container_name: ai_lemo_attu
  ports: ["8000:3000"]
```

**连接信息**:
- Milvus gRPC: `localhost:19530`
- Milvus HTTP: `localhost:9091`
- MinIO API: `localhost:9000`
- MinIO Console: `localhost:8001`
- Attu管理界面: `http://localhost:8000`

**验证连接**:
```python
from pymilvus import connections

# 连接Milvus
connections.connect(
    alias="default",
    host="localhost",
    port="19530"
)

# 列出集合
from pymilvus import utility
print(utility.list_collections())
```

**第二阶段启用**:
```env
# 在.env中设置
MILVUS_ENABLED=true
MILVUS_HOST=localhost
MILVUS_PORT=19530
```

---

## 本地服务总览

| 服务 | 容器名称 | 端口 | 来源 | 状态 |
|------|---------|------|------|------|
| MongoDB | lemo-mongodb | 27017 | 本项目 | ✅ |
| Redis | ai_lemo_redis | 6379 | 本地已有 | ✅ |
| Kafka | ad-mat-aegis-kafka | 9092/9093 | 本地已有 | ✅ |
| Etcd | ai_lemo_etcd | 2379 | 本地已有 | ✅ |
| MinIO | ai_lemo_minio | 9000/8001 | 本地已有 | ✅ |
| Milvus | ai_lemo_milvus | 19530/9091 | 本地已有 | ✅ |
| Attu | ai_lemo_attu | 8000 | 本地已有 | ✅ |
| Prometheus | lemo-prometheus | 9090 | 本项目(可选) | 🔧 |
| Grafana | lemo-grafana | 3000 | 本项目(可选) | 🔧 |

---

### Q: 端口冲突？
**A**: 
- MongoDB: 27017 (本项目)
- Redis: 6379 (本地已有)
- Kafka: 9092 (本地已有)
- Milvus: 19530/9091 (本地已有)
- MinIO: 9000/8001 (本地已有)
- Etcd: 2379 (本地已有)

**注意**: Attu占用8000端口，推荐系统默认也是8000，建议修改推荐系统端口为8080：
```env
PORT=8080
```

确认端口未被其他服务占用。

